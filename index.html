<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ÃŠxodo - Grupo</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #D4A853;
      --primary-dark: #B8923F;
      --accent: #E8C87A;
      --bg-main: #0D0D0D;
      --bg-card: #1A1A1A;
      --bg-elevated: #242424;
      --text-primary: #FAFAFA;
      --text-secondary: #A0A0A0;
      --text-muted: #666666;
      --success: #4ADE80;
      --danger: #F87171;
      --border: #2A2A2A;
    }

    .light {
      --primary: #C49A3D;
      --primary-dark: #A07D2E;
      --accent: #D4A853;
      --bg-main: #F5F3EF;
      --bg-card: #FFFFFF;
      --bg-elevated: #FAFAF8;
      --text-primary: #1A1A1A;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border: #E5E5E5;
    }

    /* Birthday Theme - Dark Mode */
    .birthday-mode {
      --primary: #FF6B9D;
      --primary-dark: #E84A7F;
      --accent: #FFD93D;
      --bg-main: #1A0A1A;
      --bg-card: #2D1A2D;
      --bg-elevated: #3D2A3D;
      --text-primary: #FFF5F8;
      --text-secondary: #D4A0B8;
      --text-muted: #8A6078;
      --success: #4ADE80;
      --danger: #F87171;
      --border: #4D2A4D;
    }

    /* Birthday Theme - Light Mode */
    .light.birthday-mode {
      --primary: #FF4081;
      --primary-dark: #E91E63;
      --accent: #FFD700;
      --bg-main: #FFF5F8;
      --bg-card: #FFFFFF;
      --bg-elevated: #FFF0F5;
      --text-primary: #4A1A2D;
      --text-secondary: #8A4A68;
      --text-muted: #B888A0;
      --border: #FFD0E0;
    }

    /* Birthday banner */
    .birthday-banner {
      display: none;
      background: linear-gradient(135deg, #FF6B9D, #FFD93D, #FF6B9D);
      background-size: 200% 200%;
      animation: birthdayGradient 3s ease infinite;
      padding: 12px 16px;
      text-align: center;
      color: #1A0A1A;
      font-weight: 600;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .birthday-banner.active {
      display: block;
    }

    .birthday-banner::before {
      content: 'ðŸŽ‚ ';
    }

    .birthday-banner::after {
      content: ' ðŸŽ‰';
    }

    .birthday-banner-text {
      display: inline-block;
      animation: birthdayBounce 1s ease infinite;
    }

    @keyframes birthdayGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes birthdayBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    /* Confetti animation for birthday */
    .birthday-confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confettiFall 4s linear infinite;
    }

    .confetti-piece:nth-child(odd) {
      background: #FF6B9D;
      border-radius: 50%;
    }

    .confetti-piece:nth-child(even) {
      background: #FFD93D;
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    }

    .confetti-piece:nth-child(3n) {
      background: #4ADE80;
      border-radius: 2px;
    }

    .confetti-piece:nth-child(4n) {
      background: #60A5FA;
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg-main);
      position: relative;
    }

    /* Auth Screens */
    .auth-screen {
      display: none;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
      padding: 20px;
      background: var(--bg-main);
      position: relative;
      overflow-y: auto;
    }

    .auth-screen.active {
      display: flex;
    }

    .auth-header {
      text-align: center;
      padding: 40px 0 30px;
    }

    .auth-logo {
      width: 90px;
      height: 90px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 40px;
      color: #0D0D0D;
      box-shadow: 0 10px 40px rgba(212, 168, 83, 0.3);
    }

    .auth-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 3px;
    }

    .auth-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .auth-form {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 380px;
      margin: 0 auto;
      width: 100%;
    }

    .auth-avatar-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }

    .auth-avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 3px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      overflow: hidden;
      position: relative;
    }

    .auth-avatar-preview:hover,
    .auth-avatar-preview:active {
      border-color: var(--primary);
      background: rgba(212, 168, 83, 0.1);
    }

    .auth-avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .auth-avatar-preview i {
      font-size: 32px;
      color: var(--text-muted);
    }

    .auth-avatar-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 10px;
    }

    .input-group {
      position: relative;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-wrapper i {
      position: absolute;
      left: 16px;
      color: var(--text-muted);
      font-size: 18px;
      pointer-events: none;
    }

    .auth-input {
      width: 100%;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 14px;
      padding: 16px 16px 16px 48px;
      font-size: 16px;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.3s;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--bg-elevated);
    }

    .auth-input::placeholder {
      color: var(--text-muted);
    }

    .email-suffix {
      position: absolute;
      right: 16px;
      color: var(--primary);
      font-weight: 500;
      font-size: 14px;
    }

    .input-wrapper .auth-input.with-suffix {
      padding-right: 100px;
    }

    .password-toggle {
      position: absolute;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      font-size: 18px;
    }

    .auth-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #0D0D0D;
      border: none;
      padding: 18px;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      letter-spacing: 0.5px;
    }

    .auth-btn:active {
      transform: scale(0.98);
    }

    .auth-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .auth-btn.loading .btn-text {
      display: none;
    }

    .auth-btn .spinner {
      display: none;
    }

    .auth-btn.loading .spinner {
      display: block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top-color: #0D0D0D;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .auth-switch {
      text-align: center;
      margin-top: 24px;
      padding-bottom: 30px;
    }

    .auth-switch p {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .auth-switch button {
      background: none;
      border: none;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      padding: 4px 8px;
    }

    .auth-error {
      background: rgba(248, 113, 113, 0.15);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 12px;
      padding: 14px 16px;
      color: var(--danger);
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 10px;
    }

    .auth-error.show {
      display: flex;
    }

    .auth-error i {
      font-size: 18px;
    }

    /* Main App Screen */
    .main-app {
      display: none;
    }

    .main-app.active {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(212, 168, 83, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-btn {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 12px;
      color: #0D0D0D;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu-btn:active {
      transform: scale(0.95);
      background: rgba(255,255,255,0.3);
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 700;
      color: #0D0D0D;
      letter-spacing: 1px;
    }

    .header-subtitle {
      font-size: 11px;
      color: rgba(13,13,13,0.7);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .online-dot {
      width: 8px;
      height: 8px;
      background: #4ADE80;
      border-radius: 50%;
      display: inline-block;
      animation: pulse-online 2s infinite;
    }

    @keyframes pulse-online {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 12px;
      color: #0D0D0D;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .header-btn:active {
      transform: scale(0.95);
      background: rgba(255,255,255,0.3);
    }

    /* Sidebar Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: var(--bg-card);
      z-index: 300;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0,0,0,0.3);
    }

    .sidebar.active {
      transform: translateX(280px);
    }

    .sidebar-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .sidebar-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #0D0D0D;
      font-weight: 700;
      border: 3px solid rgba(255,255,255,0.4);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }

    .sidebar-avatar:hover {
      border-color: rgba(255,255,255,0.7);
    }

    .sidebar-avatar:active {
      transform: scale(0.95);
    }

    .sidebar-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .sidebar-user-name {
      font-size: 18px;
      font-weight: 600;
      color: #0D0D0D;
    }

    .sidebar-user-email {
      font-size: 12px;
      color: rgba(13,13,13,0.7);
    }

    .sidebar-user-status {
      font-size: 12px;
      color: rgba(13,13,13,0.7);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sidebar-user-status::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #4ADE80;
      border-radius: 50%;
    }

    .sidebar-menu {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .sidebar-menu-item:hover,
    .sidebar-menu-item:active {
      background: var(--bg-elevated);
    }

    .sidebar-menu-item i {
      width: 24px;
      font-size: 20px;
      color: var(--primary);
      text-align: center;
    }

    .sidebar-menu-item.logout {
      color: var(--danger);
    }

    .sidebar-menu-item.logout i {
      color: var(--danger);
    }

    .sidebar-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 20px;
    }

    .sidebar-nav-item {
      background: var(--bg-elevated);
      margin: 4px 16px;
      border-radius: 12px;
      padding: 14px 20px;
      width: calc(100% - 32px);
    }

    .sidebar-nav-item:hover,
    .sidebar-nav-item:active {
      background: rgba(212, 168, 83, 0.15);
    }

    .sidebar-nav-item i {
      font-size: 18px;
    }

    .sidebar-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      color: #0D0D0D;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .sidebar-close:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      padding-bottom: 90px;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Section Title */
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
    }

    /* Posts Page */
    .post-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .post-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      color: #0D0D0D;
      overflow: hidden;
      flex-shrink: 0;
    }

    .post-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-author {
      flex: 1;
    }

    .post-author-name {
      font-weight: 600;
      font-size: 15px;
    }

    .post-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .post-menu-btn {
      width: 36px;
      height: 36px;
      background: none;
      border: none;
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .post-menu-btn:hover,
    .post-menu-btn:active {
      background: var(--bg-elevated);
      color: var(--danger);
    }

    .post-content {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-primary);
      margin-bottom: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .post-image {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 12px;
      max-height: 400px;
      object-fit: cover;
    }

    /* Post Images Grid */
    .post-images-grid {
      display: grid;
      gap: 4px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .post-images-grid.grid-1 {
      grid-template-columns: 1fr;
    }

    .post-images-grid.grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    .post-images-grid.grid-3 {
      grid-template-columns: 2fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .post-images-grid.grid-3 .post-grid-item:first-child {
      grid-row: span 2;
    }

    .post-images-grid.grid-more {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .post-grid-item {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      cursor: pointer;
    }

    .post-images-grid.grid-1 .post-grid-item {
      aspect-ratio: 16/9;
    }

    .post-images-grid.grid-2 .post-grid-item {
      aspect-ratio: 1;
    }

    .post-images-grid.grid-3 .post-grid-item:first-child {
      aspect-ratio: auto;
    }

    .post-grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }

    .post-grid-item:active img {
      transform: scale(1.02);
    }

    .post-grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      font-weight: 700;
    }

    .post-actions {
      display: flex;
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .post-action {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      font-size: 14px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 20px;
      transition: all 0.2s;
    }

    .post-action:active {
      background: var(--bg-elevated);
    }

    .post-action.liked {
      color: var(--danger);
    }

    /* Comments Section */
    .comments-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .comments-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
      width: 100%;
      text-align: left;
    }

    .comments-toggle:hover,
    .comments-toggle:active {
      background: var(--bg-elevated);
      color: var(--primary);
    }

    .comments-toggle i {
      font-size: 14px;
      transition: transform 0.3s;
    }

    .comments-toggle.expanded i {
      transform: rotate(180deg);
    }

    .comments-list {
      display: none;
      margin-top: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .comments-list.show {
      display: block;
    }

    .comment-item {
      display: flex;
      gap: 10px;
      padding: 12px;
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 8px;
      animation: fadeIn 0.3s ease;
    }

    .comment-item:last-child {
      margin-bottom: 0;
    }

    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #0D0D0D;
      flex-shrink: 0;
      overflow: hidden;
    }

    .comment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .comment-content {
      flex: 1;
      min-width: 0;
    }

    .comment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .comment-author {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .comment-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .comment-text {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-primary);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .comment-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .comment-delete:hover,
    .comment-delete:active {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
    }

    .comment-input-container {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      align-items: flex-end;
    }

    .comment-input-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #0D0D0D;
      flex-shrink: 0;
      overflow: hidden;
    }

    .comment-input-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .comment-input-wrapper {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .comment-input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 14px;
      color: var(--text-primary);
      font-family: inherit;
      resize: none;
      min-height: 40px;
      max-height: 100px;
      overflow-y: auto;
      line-height: 1.4;
    }

    .comment-input::placeholder {
      color: var(--text-muted);
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .comment-send-btn {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
      border-radius: 50%;
      color: #0D0D0D;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .comment-send-btn:active {
      transform: scale(0.95);
    }

    .comment-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .comments-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .comments-empty i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
      opacity: 0.5;
    }

    /* Delete Comment Confirm Modal */
    .delete-comment-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .delete-comment-modal-overlay.active {
      display: flex;
    }

    /* New Post */
    .new-post-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      display: none;
    }

    .new-post-card.visible {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .new-post-input {
      width: 100%;
      background: var(--bg-elevated);
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      color: var(--text-primary);
      font-family: inherit;
      resize: none;
      min-height: 80px;
    }

    .new-post-input::placeholder {
      color: var(--text-muted);
    }

    .new-post-preview {
      margin-top: 12px;
      position: relative;
      display: none;
    }

    .new-post-preview.show {
      display: block;
    }

    .new-post-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .new-post-preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
    }

    .new-post-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .new-post-preview-item-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .new-post-preview-item-remove:hover {
      background: var(--danger);
    }

    .new-post-preview img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 12px;
    }

    .new-post-preview-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .new-post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .new-post-icons {
      display: flex;
      gap: 8px;
    }

    .new-post-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .new-post-icon:active {
      background: var(--primary);
      color: #0D0D0D;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #0D0D0D;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary .spinner-small {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.2);
      border-top-color: #0D0D0D;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Loading posts */
    .posts-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .posts-loading i {
      font-size: 32px;
      margin-bottom: 12px;
      animation: spin 1s linear infinite;
    }

    .posts-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .posts-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Chat Page */
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 90px;
    }

    .chat-message {
      display: flex;
      gap: 10px;
      max-width: 85%;
      position: relative;
    }

    .chat-message.sent {
      flex-direction: row-reverse;
      align-self: flex-end;
    }

    .chat-avatar-small {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #0D0D0D;
      flex-shrink: 0;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-avatar-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-bubble-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-bubble {
      background: var(--bg-card);
      border-radius: 18px;
      border-top-left-radius: 4px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      position: relative;
    }

    .chat-message.sent .chat-bubble {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #3D3D3D;
      border: none;
      border-radius: 18px;
      border-top-right-radius: 4px;
    }

    .chat-sender {
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
      cursor: pointer;
      display: inline-block;
      transition: opacity 0.2s;
    }

    .chat-sender:hover {
      opacity: 0.8;
    }

    .chat-sender:active {
      opacity: 0.6;
    }

    .chat-message.sent .chat-sender {
      color: rgba(0,0,0,0.6);
    }

    .chat-text {
      font-size: 15px;
      line-height: 1.4;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .chat-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .chat-message.sent .chat-time {
      color: rgba(0,0,0,0.5);
    }

    .chat-avatar-small.long-press-active {
      animation: pulse 0.3s ease;
      box-shadow: 0 0 0 3px var(--danger);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .chat-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .chat-loading i {
      font-size: 32px;
      margin-bottom: 12px;
      animation: spin 1s linear infinite;
    }

    .chat-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .chat-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .chat-input-container {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      padding: 12px 16px;
      background: var(--bg-main);
      border-top: 1px solid var(--border);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 12px 18px;
      font-size: 16px;
      color: var(--text-primary);
      font-family: inherit;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.4;
    }

    .chat-input::placeholder {
      color: var(--text-muted);
    }

    .chat-send {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
      border-radius: 50%;
      color: #0D0D0D;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-send:active {
      transform: scale(0.95);
    }

    .chat-send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Chat Image Button */
    .chat-image-btn {
      width: 48px;
      height: 48px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50%;
      color: var(--primary);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .chat-image-btn:active {
      transform: scale(0.95);
      background: var(--bg-elevated);
    }

    /* Chat Image Preview */
    .chat-image-preview {
      display: none;
      position: relative;
      margin-bottom: 10px;
    }

    .chat-image-preview.show {
      display: block;
    }

    .chat-image-preview img {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .chat-image-preview-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chat-image-preview-remove:hover {
      background: var(--danger);
    }

    /* Chat Message Image */
    .chat-message-image {
      max-width: 100%;
      max-height: 250px;
      border-radius: 12px;
      margin-top: 8px;
      cursor: pointer;
      object-fit: cover;
    }

    .chat-message.sent .chat-message-image {
      border-radius: 12px;
    }

    /* Vault Page */
    .vault-balance {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 20px;
      padding: 28px 24px;
      text-align: center;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .vault-balance::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }

    .vault-label {
      font-size: 13px;
      color: rgba(0,0,0,0.6);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .vault-amount {
      font-size: 42px;
      font-weight: 700;
      color: #0D0D0D;
    }

    .vault-currency {
      font-size: 20px;
      font-weight: 500;
    }

    .vault-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .vault-action-btn {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vault-action-btn:active {
      background: var(--bg-elevated);
      transform: scale(0.98);
    }

    .vault-action-btn i {
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .vault-action-btn span {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .vault-history {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .vault-history-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 15px;
    }

    .vault-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }

    .vault-item:last-child {
      border-bottom: none;
    }

    .vault-item-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: 14px;
    }

    .vault-item-icon.income {
      background: rgba(74, 222, 128, 0.15);
      color: var(--success);
    }

    .vault-item-icon.expense {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
    }

    .vault-item-info {
      flex: 1;
    }

    .vault-item-title {
      font-weight: 500;
      font-size: 15px;
    }

    .vault-item-user {
      font-size: 12px;
      color: var(--primary);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .vault-item-user i {
      font-size: 10px;
    }

    .vault-item-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .vault-item-amount {
      font-weight: 600;
      font-size: 15px;
    }

    .vault-item-amount.income {
      color: var(--success);
    }

    .vault-item-amount.expense {
      color: var(--danger);
    }

    .vault-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .vault-loading i {
      font-size: 24px;
      margin-bottom: 10px;
      animation: spin 1s linear infinite;
    }

    .vault-empty {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }

    .vault-empty i {
      font-size: 36px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Profile Page */
    .profile-header-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 30px 20px;
      text-align: center;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: 700;
      color: #0D0D0D;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .profile-avatar-large:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 32px rgba(212, 168, 83, 0.4);
    }

    .profile-avatar-large:active {
      transform: scale(0.98);
    }

    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Profile Avatar Options Menu */
    .avatar-options-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1500;
      align-items: flex-end;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }

    .avatar-options-overlay.active {
      display: flex;
    }

    .avatar-options-menu {
      background: var(--bg-card);
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      animation: slideUp 0.3s ease;
      box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .avatar-options-header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    .avatar-options-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .avatar-options-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .avatar-option-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      padding: 18px 24px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .avatar-option-btn:hover,
    .avatar-option-btn:active {
      background: var(--bg-elevated);
    }

    .avatar-option-btn i {
      width: 40px;
      height: 40px;
      background: var(--bg-elevated);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--primary);
    }

    .avatar-option-btn:hover i,
    .avatar-option-btn:active i {
      background: var(--primary);
      color: #0D0D0D;
    }

    .avatar-option-text {
      flex: 1;
    }

    .avatar-option-text span {
      display: block;
      font-weight: 500;
    }

    .avatar-option-text small {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .avatar-options-cancel {
      display: block;
      width: 100%;
      padding: 18px;
      background: none;
      border: none;
      border-top: 1px solid var(--border);
      color: var(--danger);
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-options-cancel:hover,
    .avatar-options-cancel:active {
      background: rgba(248, 113, 113, 0.1);
    }

    /* Profile Image Viewer */
    .profile-image-viewer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .profile-image-viewer.active {
      display: flex;
    }

    .profile-image-viewer-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      z-index: 10;
    }

    .profile-image-viewer-title {
      color: #fff;
      font-size: 18px;
      font-weight: 600;
    }

    .profile-image-viewer-close {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-image-viewer-close:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }

    .profile-image-viewer img {
      max-width: 90vw;
      max-height: 80vh;
      border-radius: 12px;
      object-fit: contain;
    }

    .profile-image-viewer-placeholder {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      font-weight: 700;
      color: #0D0D0D;
    }

    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .profile-username {
      color: var(--primary);
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .profile-birth {
      color: var(--text-secondary);
      margin-bottom: 20px;
      font-size: 14px;
    }

    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
    }

    .profile-stat {
      text-align: center;
    }

    .profile-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .profile-stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* My Profile Posts Section */
    .my-profile-posts-section {
      margin-top: 20px;
    }

    .my-profile-posts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .my-profile-posts-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .my-profile-posts-title i {
      color: var(--primary);
      font-size: 16px;
    }

    .my-profile-posts-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .my-profile-post-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .my-profile-post-card:hover {
      border-color: var(--primary);
    }

    .my-profile-post-content {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-primary);
      margin-bottom: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .my-profile-post-images {
      display: grid;
      gap: 4px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .my-profile-post-images.grid-1 {
      grid-template-columns: 1fr;
    }

    .my-profile-post-images.grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    .my-profile-post-images.grid-3 {
      grid-template-columns: 2fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .my-profile-post-images.grid-3 .my-profile-post-img:first-child {
      grid-row: span 2;
    }

    .my-profile-post-images.grid-more {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .my-profile-post-img {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      cursor: pointer;
    }

    .my-profile-post-images.grid-1 .my-profile-post-img {
      aspect-ratio: 16/9;
    }

    .my-profile-post-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }

    .my-profile-post-img:active img {
      transform: scale(1.02);
    }

    .my-profile-post-img-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 22px;
      font-weight: 700;
    }

    .my-profile-post-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 13px;
    }

    .my-profile-post-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .my-profile-post-meta i {
      font-size: 14px;
    }

    .my-profile-post-meta .fa-heart {
      color: var(--danger);
    }

    .my-profile-posts-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .my-profile-posts-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--primary);
      opacity: 0.5;
    }

    .my-profile-posts-empty p {
      font-size: 15px;
      margin-bottom: 4px;
    }

    .my-profile-posts-empty small {
      font-size: 13px;
      opacity: 0.7;
    }

    .my-profile-posts-loading {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }

    .my-profile-posts-loading i {
      font-size: 28px;
      margin-bottom: 12px;
      animation: spin 1s linear infinite;
      color: var(--primary);
    }

    /* Footer Navigation */
    .footer-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 12px 20px;
      min-width: 70px;
      min-height: 56px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 12px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      position: relative;
      z-index: 1;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item:active {
      background: var(--bg-elevated);
      transform: scale(0.95);
    }

    .nav-item i {
      font-size: 22px;
      pointer-events: none;
    }

    .nav-item span {
      font-size: 11px;
      font-weight: 500;
      pointer-events: none;
    }

    .nav-avatar {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 16px;
      min-width: 60px;
      min-height: 56px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 12px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .nav-avatar:active {
      transform: scale(0.95);
    }

    .nav-avatar-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #0D0D0D;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .nav-avatar:hover .nav-avatar-img,
    .nav-avatar:active .nav-avatar-img {
      border-color: var(--primary);
    }

    .nav-avatar-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .nav-avatar span {
      font-size: 11px;
      font-weight: 500;
      pointer-events: none;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 340px;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      text-align: center;
    }

    .modal-text {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .modal-input {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      color: var(--text-primary);
      font-family: inherit;
      margin-bottom: 12px;
    }

    .modal-input::placeholder {
      color: var(--text-muted);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.cancel {
      background: var(--bg-elevated);
      border: none;
      color: var(--text-secondary);
    }

    .modal-btn.confirm {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
      color: #0D0D0D;
    }

    .modal-btn.danger {
      background: var(--danger);
      border: none;
      color: white;
    }

    /* Image Viewer */
    .image-viewer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      touch-action: pan-x;
    }

    .image-viewer.active {
      display: flex;
    }

    .viewer-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      z-index: 10;
    }

    .viewer-counter {
      color: #fff;
      font-size: 16px;
      font-weight: 500;
    }

    .viewer-close {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .viewer-close:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }

    .viewer-header-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .viewer-download {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .viewer-download:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }

    .viewer-container {
      width: 100vw;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    .viewer-slides {
      display: flex;
      transition: transform 0.3s ease-out;
      height: 100%;
      width: max-content;
    }

    .viewer-slide {
      width: 100vw;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }

    .viewer-image {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
      object-fit: contain;
    }

    .viewer-placeholder {
      width: 280px;
      height: 280px;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .viewer-placeholder i {
      font-size: 80px;
    }

    .viewer-placeholder span {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }

    .viewer-nav {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .viewer-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transition: all 0.3s;
    }

    .viewer-dot.active {
      width: 24px;
      border-radius: 4px;
      background: var(--primary);
    }

    .viewer-arrows {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      padding: 0 12px;
      pointer-events: none;
      z-index: 10;
    }

    .viewer-arrow {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      pointer-events: auto;
      transition: all 0.2s;
      opacity: 0.7;
    }

    .viewer-arrow:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }

    .viewer-arrow:disabled {
      opacity: 0.2;
      pointer-events: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 14px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 90%;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      border-color: var(--success);
    }

    .toast.error {
      border-color: var(--danger);
    }

    .toast i {
      font-size: 18px;
    }

    .toast.success i {
      color: var(--success);
    }

    .toast.error i {
      color: var(--danger);
    }

    /* Upload Progress Modal */
    .upload-progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 2500;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(8px);
    }

    .upload-progress-modal.active {
      display: flex;
    }

    .upload-progress-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px 28px;
      width: 100%;
      max-width: 300px;
      text-align: center;
      animation: modalIn 0.3s ease;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    .upload-progress-icon {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: pulse-upload 1.5s ease-in-out infinite;
    }

    .upload-progress-icon i {
      font-size: 28px;
      color: #0D0D0D;
    }

    @keyframes pulse-upload {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 168, 83, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(212, 168, 83, 0); }
    }

    .upload-progress-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .upload-progress-status {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      min-height: 20px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .upload-progress-bar-container {
      width: 100%;
      height: 8px;
      background: var(--bg-elevated);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .upload-progress-count {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    /* User Profile Modal */
    .user-profile-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1500;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(4px);
    }

    .user-profile-modal.active {
      display: flex;
    }

    .user-profile-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 30px 24px;
      width: 100%;
      max-width: 400px;
      max-height: 85vh;
      overflow-y: auto;
      text-align: center;
      animation: modalIn 0.3s ease;
      border: 1px solid var(--border);
      position: relative;
    }

    .user-profile-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 50%;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .user-profile-close:hover,
    .user-profile-close:active {
      background: var(--primary);
      color: #0D0D0D;
    }

    .user-profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: 700;
      color: #0D0D0D;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(212, 168, 83, 0.3);
    }

    .user-profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .user-profile-username {
      color: var(--primary);
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .user-profile-email {
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 6px;
    }

    .user-profile-birth {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .user-profile-birth i {
      color: var(--primary);
      font-size: 12px;
    }

    .user-profile-avatar {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .user-profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(212, 168, 83, 0.4);
    }

    .user-profile-avatar:active {
      transform: scale(0.98);
    }

    .user-profile-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(74, 222, 128, 0.15);
      color: var(--success);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 20px;
    }

    .user-profile-status.offline {
      background: rgba(160, 160, 160, 0.15);
      color: var(--text-muted);
    }

    .user-profile-status-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse-online 2s infinite;
    }

    .user-profile-status.offline .user-profile-status-dot {
      background: var(--text-muted);
      animation: none;
    }

    .user-profile-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .user-profile-stat {
      text-align: center;
    }

    .user-profile-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }

    .user-profile-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-profile-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 40px 0;
      color: var(--text-muted);
    }

    .user-profile-loading i {
      font-size: 32px;
      animation: spin 1s linear infinite;
    }

    /* User Profile Posts Section */
    .user-profile-posts-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      text-align: left;
    }

    .user-profile-posts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .user-profile-posts-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-profile-posts-title i {
      color: var(--primary);
      font-size: 14px;
    }

    .user-profile-posts-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .user-profile-posts-container::-webkit-scrollbar {
      width: 4px;
    }

    .user-profile-posts-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .user-profile-post-card {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      transition: all 0.2s;
    }

    .user-profile-post-card:hover {
      background: var(--bg-main);
    }

    .user-profile-post-content {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 8px;
      white-space: pre-wrap;
      word-break: break-word;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .user-profile-post-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 4px;
      margin-bottom: 8px;
      border-radius: 8px;
      overflow: hidden;
    }

    .user-profile-post-images img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .user-profile-post-images img:hover {
      transform: scale(1.05);
    }

    .user-profile-post-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .user-profile-post-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .user-profile-post-meta i {
      font-size: 12px;
    }

    .user-profile-posts-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .user-profile-posts-empty i {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
      display: block;
    }

    /* Absences User Cards */
    .absence-user-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .absence-user-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .absence-user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #0D0D0D;
      overflow: hidden;
      flex-shrink: 0;
    }

    .absence-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .absence-user-info {
      flex: 1;
      min-width: 0;
    }

    .absence-user-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .absence-user-username {
      font-size: 13px;
      color: var(--primary);
    }

    .absence-count-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 8px 14px;
      background: var(--bg-elevated);
      border-radius: 12px;
      min-width: 60px;
    }

    .absence-count-badge.has-absences {
      background: rgba(248, 113, 113, 0.15);
    }

    .absence-count-number {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .absence-count-badge.has-absences .absence-count-number {
      color: var(--danger);
    }

    .absence-count-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .absence-actions {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .absence-action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .absence-action-btn.add {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
    }

    .absence-action-btn.add:active {
      background: rgba(248, 113, 113, 0.25);
      transform: scale(0.98);
    }

    .absence-action-btn.remove {
      background: rgba(74, 222, 128, 0.15);
      color: var(--success);
    }

    .absence-action-btn.remove:active {
      background: rgba(74, 222, 128, 0.25);
      transform: scale(0.98);
    }

    .absence-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .absence-action-btn i {
      font-size: 16px;
    }

    /* Absence History List */
    .absence-history-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .absence-history-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 0;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .absence-history-toggle:hover {
      color: var(--primary);
    }

    .absence-history-toggle i {
      transition: transform 0.3s;
    }

    .absence-history-toggle.expanded i {
      transform: rotate(180deg);
    }

    .absence-history-list {
      display: none;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .absence-history-list.show {
      display: block;
    }

    .absence-history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      margin-bottom: 6px;
    }

    .absence-history-item:last-child {
      margin-bottom: 0;
    }

    .absence-history-date {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .absence-history-date i {
      color: var(--danger);
      font-size: 14px;
    }

    .absence-history-date-text {
      font-size: 14px;
      color: var(--text-primary);
    }

    .absence-history-reason {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .absence-history-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .absence-history-delete:hover,
    .absence-history-delete:active {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
    }

    /* Profile Absences History Modal */
    .profile-absences-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    .profile-absences-modal-overlay.active {
      display: flex;
    }

    .profile-absences-modal {
      background: var(--bg-card);
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .profile-absences-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .profile-absences-modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .profile-absences-modal-title i {
      color: var(--danger);
    }

    .profile-absences-modal-close {
      width: 36px;
      height: 36px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 50%;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .profile-absences-modal-close:hover,
    .profile-absences-modal-close:active {
      background: var(--danger);
      color: white;
    }

    .profile-absences-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .profile-absences-summary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.1), rgba(248, 113, 113, 0.05));
      border-radius: 14px;
      margin-bottom: 20px;
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .profile-absences-summary-number {
      font-size: 36px;
      font-weight: 700;
      color: var(--danger);
    }

    .profile-absences-summary-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .profile-absences-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .profile-absence-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .profile-absence-item:hover {
      border-color: var(--primary);
    }

    .profile-absence-icon {
      width: 40px;
      height: 40px;
      background: rgba(248, 113, 113, 0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--danger);
      font-size: 16px;
      flex-shrink: 0;
    }

    .profile-absence-info {
      flex: 1;
      min-width: 0;
    }

    .profile-absence-date {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .profile-absence-reason {
      font-size: 13px;
      color: var(--text-secondary);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .profile-absences-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .profile-absences-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--success);
    }

    .profile-absences-empty p {
      font-size: 15px;
    }

    .profile-absences-loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .profile-absences-loading i {
      font-size: 32px;
      color: var(--primary);
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    /* Clickable stat for absences */
    .profile-stat.clickable {
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px 12px;
      border-radius: 10px;
      margin: -8px -12px;
    }

    .profile-stat.clickable:hover,
    .profile-stat.clickable:active {
      background: rgba(212, 168, 83, 0.1);
    }

    .profile-stat.clickable .profile-stat-value {
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 4px;
    }

    /* User profile modal clickable stat */
    .user-profile-stat.clickable {
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px 12px;
      border-radius: 10px;
      margin: -8px -12px;
    }

    .user-profile-stat.clickable:hover,
    .user-profile-stat.clickable:active {
      background: rgba(212, 168, 83, 0.1);
    }

    .user-profile-stat.clickable .user-profile-stat-value {
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 4px;
    }

    /* Add Absence Modal for specific user */
    .modal-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .modal-user-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      color: #0D0D0D;
      overflow: hidden;
      flex-shrink: 0;
    }

    .modal-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-user-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
    }

    .modal-user-username {
      font-size: 12px;
      color: var(--primary);
    }

    /* Posts Filter */
    .posts-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 4px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .filter-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .filter-btn:active {
      transform: scale(0.97);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #0D0D0D;
      box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
    }

    .filter-btn i {
      font-size: 16px;
    }

    .filter-btn span {
      white-space: nowrap;
    }

    /* Posts Search */
    .posts-search-container {
      margin-bottom: 12px;
    }

    .posts-search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .posts-search-wrapper i {
      position: absolute;
      left: 16px;
      color: var(--text-muted);
      font-size: 16px;
      pointer-events: none;
      transition: color 0.2s;
    }

    .posts-search-input {
      width: 100%;
      padding: 14px 44px 14px 46px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s;
    }

    .posts-search-input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--bg-elevated);
    }

    .posts-search-input:focus + .posts-search-icon,
    .posts-search-wrapper:focus-within i.posts-search-icon {
      color: var(--primary);
    }

    .posts-search-input::placeholder {
      color: var(--text-muted);
    }

    .posts-search-clear {
      position: absolute;
      right: 12px;
      width: 28px;
      height: 28px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .posts-search-clear:hover,
    .posts-search-clear:active {
      background: var(--primary);
      color: #0D0D0D;
    }

    .posts-search-clear.visible {
      display: flex;
    }

    .posts-search-results {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      margin-top: 10px;
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .posts-search-results i {
      color: var(--primary);
      margin-right: 6px;
    }

    .posts-search-results .highlight-term {
      color: var(--primary);
      font-weight: 600;
    }

    .posts-no-results {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }

    .posts-no-results i {
      font-size: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .posts-no-results p {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.5;
    }

    .posts-no-results .search-term {
      color: var(--primary);
      font-weight: 600;
    }

    /* Highlight search matches in posts */
    .search-highlight {
      background: linear-gradient(135deg, rgba(212, 168, 83, 0.3), rgba(212, 168, 83, 0.15));
      color: var(--primary);
      padding: 1px 4px;
      border-radius: 4px;
      font-weight: 500;
    }

    /* Posts Gallery Grid (for images filter) */
    .posts-gallery-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }

    .posts-gallery-item {
      aspect-ratio: 1;
      background: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .posts-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.2s;
    }

    .posts-gallery-item:active img {
      transform: scale(1.05);
    }

    .posts-gallery-count {
      text-align: center;
      padding: 16px;
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 12px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .posts-gallery-count i {
      color: var(--primary);
      margin-right: 8px;
    }

    /* PIN Security Modal */
    .pin-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .pin-modal-overlay.active {
      display: flex;
    }

    .pin-modal {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px 24px;
      width: 90%;
      max-width: 340px;
      text-align: center;
      animation: pinModalIn 0.3s ease;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    @keyframes pinModalIn {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .pin-modal-icon {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 32px;
      color: #0D0D0D;
      box-shadow: 0 8px 24px rgba(212, 168, 83, 0.3);
    }

    .pin-modal-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .pin-modal-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .pin-display {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .pin-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      transition: all 0.2s ease;
    }

    .pin-dot.filled {
      background: var(--primary);
      border-color: var(--primary);
      box-shadow: 0 0 12px rgba(212, 168, 83, 0.5);
      transform: scale(1.1);
    }

    .pin-dot.error {
      background: var(--danger);
      border-color: var(--danger);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.5);
      animation: pinShake 0.4s ease;
    }

    @keyframes pinShake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }

    .pin-keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-width: 280px;
      margin: 0 auto;
    }

    .pin-key {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: none;
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 28px;
      font-weight: 600;
      font-family: 'Outfit', sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      margin: 0 auto;
      user-select: none;
      -webkit-user-select: none;
    }

    .pin-key:active {
      transform: scale(0.92);
      background: var(--primary);
      color: #0D0D0D;
    }

    .pin-key.action {
      background: transparent;
      font-size: 20px;
      color: var(--text-secondary);
    }

    .pin-key.action:active {
      background: rgba(212, 168, 83, 0.1);
      color: var(--primary);
    }

    .pin-key.empty {
      visibility: hidden;
      cursor: default;
    }

    .pin-error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 16px;
      min-height: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .pin-error-msg.show {
      opacity: 1;
    }

    .pin-modal-cancel {
      margin-top: 20px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 14px;
      font-family: 'Outfit', sans-serif;
      cursor: pointer;
      padding: 10px 20px;
      transition: color 0.2s;
    }

    .pin-modal-cancel:hover,
    .pin-modal-cancel:active {
      color: var(--text-secondary);
    }

    /* ===================== */
    /* Notifications System  */
    /* ===================== */

    /* Notification Badge */
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: var(--danger);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      box-shadow: 0 2px 8px rgba(248, 113, 113, 0.4);
      animation: notificationPulse 2s infinite;
    }

    .notification-badge.hidden {
      display: none;
    }

    @keyframes notificationPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .header-btn {
      position: relative;
    }

    /* Notifications Page */
    .notifications-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .notifications-header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
    }

    .notifications-header-title i {
      color: var(--primary);
    }

    .notifications-mark-all {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .notifications-mark-all:hover,
    .notifications-mark-all:active {
      background: rgba(212, 168, 83, 0.15);
    }

    .notifications-mark-all:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Notifications List */
    .notifications-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notification-card {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .notification-card:hover,
    .notification-card:active {
      background: var(--bg-elevated);
      transform: translateY(-1px);
    }

    .notification-card.unread {
      border-left: 3px solid var(--primary);
      background: rgba(212, 168, 83, 0.05);
    }

    .notification-card.unread::after {
      content: '';
      position: absolute;
      top: 16px;
      right: 16px;
      width: 10px;
      height: 10px;
      background: var(--primary);
      border-radius: 50%;
    }

    .notification-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      color: #0D0D0D;
      flex-shrink: 0;
      overflow: hidden;
    }

    .notification-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .notification-avatar.type-like {
      background: linear-gradient(135deg, #F87171, #EF4444);
    }

    .notification-avatar.type-comment {
      background: linear-gradient(135deg, #60A5FA, #3B82F6);
    }

    .notification-avatar.type-mention {
      background: linear-gradient(135deg, #4ADE80, #22C55E);
    }

    .notification-avatar.type-system {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-text {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .notification-text strong {
      font-weight: 600;
      color: var(--text-primary);
    }

    .notification-time {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .notification-time i {
      font-size: 10px;
    }

    .notification-preview {
      margin-top: 10px;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
      border-left: 2px solid var(--border);
    }

    /* Notification Types Icons */
    .notification-type-icon {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #fff;
      border: 2px solid var(--bg-card);
    }

    .notification-type-icon.like {
      background: #EF4444;
    }

    .notification-type-icon.comment {
      background: #3B82F6;
    }

    .notification-type-icon.mention {
      background: #22C55E;
    }

    .notification-type-icon.system {
      background: var(--primary);
    }

    /* Empty Notifications State */
    .notifications-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .notifications-empty-icon {
      width: 80px;
      height: 80px;
      background: var(--bg-card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      border: 2px solid var(--border);
    }

    .notifications-empty-icon i {
      font-size: 32px;
      color: var(--text-muted);
    }

    .notifications-empty h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .notifications-empty p {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 260px;
    }

    /* Notification Loading */
    .notifications-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 16px;
    }

    .notifications-loading i {
      font-size: 32px;
      color: var(--primary);
      animation: spin 1s linear infinite;
    }

    .notifications-loading span {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Notification Filters */
    .notifications-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .notifications-filters::-webkit-scrollbar {
      display: none;
    }

    .notification-filter-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .notification-filter-btn:hover,
    .notification-filter-btn:active {
      background: var(--bg-elevated);
      border-color: var(--primary);
    }

    .notification-filter-btn.active {
      background: rgba(212, 168, 83, 0.15);
      border-color: var(--primary);
      color: var(--primary);
    }

    .notification-filter-btn i {
      font-size: 14px;
    }

    /* Notification Swipe Actions (for mobile) */
    .notification-card-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 16px;
    }

    .notification-swipe-actions {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      background: var(--danger);
      padding: 0 20px;
      border-radius: 0 16px 16px 0;
    }

    .notification-swipe-actions i {
      color: #fff;
      font-size: 20px;
    }

    /* ===================== */
    /* Send Notifications Section */
    /* ===================== */

    .notifications-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 12px;
    }

    .notification-tab-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      justify-content: center;
    }

    .notification-tab-btn:hover,
    .notification-tab-btn:active {
      background: var(--bg-elevated);
      border-color: var(--primary);
    }

    .notification-tab-btn.active {
      background: rgba(212, 168, 83, 0.15);
      border-color: var(--primary);
      color: var(--primary);
    }

    .notification-tab-btn i {
      font-size: 16px;
    }

    .notification-tab-content {
      display: none;
    }

    .notification-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Send Notification Form */
    .send-notification-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .send-notification-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .send-notification-title i {
      color: var(--primary);
    }

    .notification-recipient-type {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .recipient-type-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      justify-content: center;
    }

    .recipient-type-btn:hover,
    .recipient-type-btn:active {
      background: rgba(212, 168, 83, 0.1);
      border-color: var(--primary);
    }

    .recipient-type-btn.active {
      background: rgba(212, 168, 83, 0.15);
      border-color: var(--primary);
      color: var(--primary);
    }

    .recipient-type-btn i {
      font-size: 16px;
    }

    .notification-user-select {
      margin-bottom: 16px;
      display: none;
    }

    .notification-user-select.active {
      display: block;
    }

    .notification-user-select label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .user-select-dropdown {
      position: relative;
    }

    .user-select-input {
      width: 100%;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.3s;
      cursor: pointer;
    }

    .user-select-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .user-select-input::placeholder {
      color: var(--text-muted);
    }

    .user-dropdown-list {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      z-index: 100;
      display: none;
    }

    .user-dropdown-list.active {
      display: block;
    }

    .user-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-dropdown-item:hover,
    .user-dropdown-item:active {
      background: var(--bg-elevated);
    }

    .user-dropdown-item.selected {
      background: rgba(212, 168, 83, 0.15);
    }

    .user-dropdown-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: #0D0D0D;
      overflow: hidden;
      flex-shrink: 0;
    }

    .user-dropdown-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-dropdown-info {
      flex: 1;
    }

    .user-dropdown-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .user-dropdown-email {
      font-size: 12px;
      color: var(--text-muted);
    }

    .notification-form-group {
      margin-bottom: 16px;
    }

    .notification-form-group label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .notification-input,
    .notification-textarea {
      width: 100%;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.3s;
    }

    .notification-input:focus,
    .notification-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .notification-input::placeholder,
    .notification-textarea::placeholder {
      color: var(--text-muted);
    }

    .notification-textarea {
      resize: none;
      min-height: 100px;
    }

    .notification-type-select {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .notification-type-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .notification-type-option:hover,
    .notification-type-option:active {
      background: rgba(212, 168, 83, 0.1);
      border-color: var(--primary);
    }

    .notification-type-option.active {
      border-color: var(--primary);
      color: var(--primary);
    }

    .notification-type-option.type-system.active {
      border-color: var(--primary);
      background: rgba(212, 168, 83, 0.15);
    }

    .notification-type-option.type-info.active {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.15);
      color: #3B82F6;
    }

    .notification-type-option.type-success.active {
      border-color: #22C55E;
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
    }

    .notification-type-option.type-warning.active {
      border-color: #F59E0B;
      background: rgba(245, 158, 11, 0.15);
      color: #F59E0B;
    }

    .notification-type-option.type-danger.active {
      border-color: #EF4444;
      background: rgba(239, 68, 68, 0.15);
      color: #EF4444;
    }

    .notification-type-option i {
      font-size: 14px;
    }

    .send-notification-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #0D0D0D;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 8px;
    }

    .send-notification-btn:active {
      transform: scale(0.98);
    }

    .send-notification-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .send-notification-btn .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.2);
      border-top-color: #0D0D0D;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .send-notification-btn.loading .btn-text {
      display: none;
    }

    .send-notification-btn.loading .spinner {
      display: block;
    }

    /* Sent Notifications List */
    .sent-notifications-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .sent-notifications-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .sent-notifications-title i {
      color: var(--primary);
    }

    .clear-sent-notifications-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .clear-sent-notifications-btn:hover,
    .clear-sent-notifications-btn:active {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
    }

    .sent-notification-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .sent-notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sent-notification-recipient {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .sent-notification-recipient i {
      color: var(--primary);
    }

    .sent-notification-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sent-notification-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
      padding: 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border-left: 3px solid var(--primary);
    }

    .sent-notification-content.type-info {
      border-left-color: #3B82F6;
    }

    .sent-notification-content.type-success {
      border-left-color: #22C55E;
    }

    .sent-notification-content.type-warning {
      border-left-color: #F59E0B;
    }

    .sent-notification-content.type-danger {
      border-left-color: #EF4444;
    }

    .sent-notification-title-text {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .sent-notification-message {
      color: var(--text-secondary);
    }

    .sent-notifications-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }

    .sent-notifications-empty i {
      font-size: 40px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .sent-notifications-empty p {
      font-size: 14px;
      color: var(--text-secondary);
    }

  </style>
</head>
<body>
  <!-- PIN Security Modal -->
  <div class="pin-modal-overlay" id="pinModal">
    <div class="pin-modal">
      <div class="pin-modal-icon">
        <i class="fas fa-lock" id="pinModalIcon"></i>
      </div>
      <h2 class="pin-modal-title" id="pinModalTitle">Acesso Restrito</h2>
      <p class="pin-modal-subtitle" id="pinModalSubtitle">Digite o PIN para acessar</p>

      <div class="pin-display">
        <div class="pin-dot" id="pinDot1"></div>
        <div class="pin-dot" id="pinDot2"></div>
        <div class="pin-dot" id="pinDot3"></div>
        <div class="pin-dot" id="pinDot4"></div>
      </div>

      <div class="pin-keypad">
        <button class="pin-key" data-key="1">1</button>
        <button class="pin-key" data-key="2">2</button>
        <button class="pin-key" data-key="3">3</button>
        <button class="pin-key" data-key="4">4</button>
        <button class="pin-key" data-key="5">5</button>
        <button class="pin-key" data-key="6">6</button>
        <button class="pin-key" data-key="7">7</button>
        <button class="pin-key" data-key="8">8</button>
        <button class="pin-key" data-key="9">9</button>
        <button class="pin-key empty"></button>
        <button class="pin-key" data-key="0">0</button>
        <button class="pin-key action" data-key="delete"><i class="fas fa-backspace"></i></button>
      </div>

      <p class="pin-error-msg" id="pinErrorMsg">PIN incorreto. Tente novamente.</p>

      <button class="pin-modal-cancel" onclick="closePinModal()">Cancelar</button>
    </div>
  </div>

  <div class="app-container">
    <!-- Login Screen -->
    <div class="auth-screen active" id="loginScreen">
      <div class="auth-header">
        <div class="auth-logo">
          <i class="fas fa-fire"></i>
        </div>
        <h1 class="auth-title">ÃŠXODO</h1>
        <p class="auth-subtitle">Entre na sua conta</p>
      </div>

      <div class="auth-form">
        <div class="auth-error" id="loginError">
          <i class="fas fa-exclamation-circle"></i>
          <span id="loginErrorText">Erro ao fazer login</span>
        </div>

        <div class="input-group">
          <label>Nome de usuÃ¡rio</label>
          <div class="input-wrapper">
            <i class="fas fa-user"></i>
            <input type="text" class="auth-input with-suffix" id="loginUsername" placeholder="seunome">
            <span class="email-suffix">@gmail.com</span>
          </div>
        </div>

        <div class="input-group">
          <label>Senha</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input type="password" class="auth-input" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button class="password-toggle" type="button" onclick="togglePassword('loginPassword', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>

        <button class="auth-btn" id="loginBtn" onclick="handleLogin()">
          <span class="btn-text">Entrar</span>
          <div class="spinner"></div>
        </button>

        <div class="auth-switch">
          <p>NÃ£o tem uma conta?</p>
          <button onclick="showScreen('register')">Criar conta</button>
        </div>
      </div>
    </div>

    <!-- Register Screen -->
    <div class="auth-screen" id="registerScreen">
      <div class="auth-header">
        <div class="auth-logo">
          <i class="fas fa-fire"></i>
        </div>
        <h1 class="auth-title">ÃŠXODO</h1>
        <p class="auth-subtitle">Crie sua conta</p>
      </div>

      <div class="auth-form">
        <div class="auth-error" id="registerError">
          <i class="fas fa-exclamation-circle"></i>
          <span id="registerErrorText">Erro ao criar conta</span>
        </div>

        <div class="auth-avatar-upload">
          <div class="auth-avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarInput').click()">
            <i class="fas fa-camera"></i>
          </div>
          <input type="file" id="avatarInput" accept="image/*" hidden onchange="previewAvatar(this)">
          <span class="auth-avatar-label">Toque para adicionar foto</span>
        </div>

        <div class="input-group">
          <label>Nome completo</label>
          <div class="input-wrapper">
            <i class="fas fa-user"></i>
            <input type="text" class="auth-input" id="registerName" placeholder="Seu nome completo">
          </div>
        </div>

        <div class="input-group">
          <label>Nome de usuÃ¡rio</label>
          <div class="input-wrapper">
            <i class="fas fa-at"></i>
            <input type="text" class="auth-input with-suffix" id="registerUsername" placeholder="seunome">
            <span class="email-suffix">@gmail.com</span>
          </div>
        </div>

        <div class="input-group">
          <label>Data de nascimento</label>
          <div class="input-wrapper">
            <i class="fas fa-calendar"></i>
            <input type="date" class="auth-input" id="registerBirthdate">
          </div>
        </div>

        <div class="input-group">
          <label>Senha</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input type="password" class="auth-input" id="registerPassword" placeholder="MÃ­nimo 6 caracteres">
            <button class="password-toggle" type="button" onclick="togglePassword('registerPassword', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>

        <button class="auth-btn" id="registerBtn" onclick="handleRegister()">
          <span class="btn-text">Criar Conta</span>
          <div class="spinner"></div>
        </button>

        <div class="auth-switch">
          <p>JÃ¡ tem uma conta?</p>
          <button onclick="showScreen('login')">Fazer login</button>
        </div>
      </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
      <!-- Sidebar Overlay -->
      <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <button class="sidebar-close" onclick="closeSidebar()">
          <i class="fas fa-times"></i>
        </button>
        <div class="sidebar-header">
          <div class="sidebar-avatar" id="sidebarAvatar" onclick="openCurrentUserProfileModal()">EU</div>
          <div class="sidebar-user-name" id="sidebarName">UsuÃ¡rio</div>
          <div class="sidebar-user-email" id="sidebarEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="daafa9afbba8b3b59abdb7bbb3b6f4b9b5b7">[email&#160;protected]</a></div>
          <div class="sidebar-user-status">Online</div>
        </div>
        <nav class="sidebar-menu">
          <button class="sidebar-menu-item sidebar-nav-item" data-page="posts">
            <i class="fas fa-newspaper"></i>
            <span>Postagens</span>
          </button>
          <button class="sidebar-menu-item sidebar-nav-item" data-page="chat">
            <i class="fas fa-comments"></i>
            <span>Conversas</span>
          </button>
          <button class="sidebar-menu-item sidebar-nav-item" data-page="vault">
            <i class="fas fa-vault"></i>
            <span>Cofre</span>
          </button>
          <div class="sidebar-menu-divider"></div>
          <button class="sidebar-menu-item" onclick="openProfilePage()">
            <i class="fas fa-user"></i>
            <span>Perfil</span>
          </button>
          <button class="sidebar-menu-item" onclick="openAbsencesPage()">
            <i class="fas fa-calendar-xmark"></i>
            <span>Faltas</span>
          </button>
          <div class="sidebar-menu-divider"></div>
          <button class="sidebar-menu-item" onclick="closeSidebar()">
            <i class="fas fa-cog"></i>
            <span>ConfiguraÃ§Ãµes</span>
          </button>
          <button class="sidebar-menu-item" onclick="closeSidebar()">
            <i class="fas fa-info-circle"></i>
            <span>Sobre</span>
          </button>
          <div class="sidebar-menu-divider"></div>
          <button class="sidebar-menu-item logout" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Sair</span>
          </button>
        </nav>
      </aside>

      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <button class="menu-btn" onclick="openSidebar()">
            <i class="fas fa-bars"></i>
          </button> 
          <div class="header-title">
            
            <div>
              <h1>ÃŠXODO</h1>
              <div class="header-subtitle" id="headerSubtitle"><span class="online-dot"></span> <span id="onlineCount">0</span> online</div>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="header-btn" id="notificationsBtn" onclick="openNotificationsPage()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge hidden" id="notificationBadge">0</span>
          </button>
          <button class="header-btn" id="newPostBtn" onclick="toggleNewPostCard()">
            <i class="fas fa-plus" id="newPostIcon"></i>
          </button>
          <button class="header-btn" onclick="toggleTheme()">
            <i class="fas fa-moon" id="themeIcon"></i>
          </button>
        </div>
      </header>

      <!-- Birthday Banner -->
      <div class="birthday-banner" id="birthdayBanner">
        <span class="birthday-banner-text">Feliz AniversÃ¡rio! Hoje Ã© o seu dia especial!</span>
      </div>

      <!-- Birthday Confetti Container -->
      <div class="birthday-confetti" id="birthdayConfetti"></div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Posts Page -->
        <div class="page active" id="postsPage">
          <div class="new-post-card">
            <textarea class="new-post-input" id="newPostInput" placeholder="O que vocÃª quer compartilhar com o grupo?"></textarea>
            <div class="new-post-preview" id="newPostPreview">
              <div class="new-post-preview-grid" id="newPostPreviewGrid"></div>
            </div>
            <div class="new-post-actions">
              <div class="new-post-icons">
                <button class="new-post-icon" onclick="document.getElementById('postImageInput').click()">
                  <i class="fas fa-images"></i>
                </button>
                <input type="file" id="postImageInput" accept="image/*" multiple hidden onchange="previewPostImages(this)">
              </div>
              <button class="btn-primary" id="publishBtn" onclick="createPost()">
                <span class="btn-text">Publicar</span>
                <div class="spinner-small" style="display: none;"></div>
              </button>
            </div>
          </div>

          <!-- Posts Search -->
          <div class="posts-search-container">
            <div class="posts-search-wrapper">
              <i class="fas fa-search posts-search-icon"></i>
              <input
                type="text"
                class="posts-search-input"
                id="postsSearchInput"
                placeholder="Pesquisar postagens..."
                oninput="handlePostsSearch(this.value)"
                autocomplete="off"
              >
              <button class="posts-search-clear" id="postsSearchClear" onclick="clearPostsSearch()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="posts-search-results" id="postsSearchResults" style="display: none;"></div>
          </div>

          <!-- Posts Filter -->
          <div class="posts-filter">
            <button class="filter-btn active" id="filterAll" onclick="setPostsFilter('all')">
              <i class="fas fa-layer-group"></i>
              <span>Todas</span>
            </button>
            <button class="filter-btn" id="filterImages" onclick="setPostsFilter('images')">
              <i class="fas fa-images"></i>
              <span>Galeria</span>
            </button>
          </div>

          <div id="postsContainer">
            <div class="posts-loading">
              <i class="fas fa-spinner"></i>
              <span>Carregando postagens...</span>
            </div>
          </div>

          <!-- Posts Gallery Grid (hidden by default, shown when filtering by images) -->
          <div id="postsGalleryContainer" style="display: none;">
            <div class="posts-gallery-count" id="postsGalleryCount">
              <i class="fas fa-images"></i>
              <span>0 fotos nas postagens</span>
            </div>
            <div class="posts-gallery-grid" id="postsGalleryGrid"></div>
          </div>
        </div>

        <!-- Chat Page -->
        <div class="page" id="chatPage">
          <div class="section-title">
            <i class="fas fa-comments"></i>
            Conversas
          </div>
          <div class="chat-container" id="chatContainer">
            <div class="chat-loading">
              <i class="fas fa-spinner"></i>
              <span>Carregando mensagens...</span>
            </div>
          </div>
        </div>

        <!-- Vault Page -->
        <div class="page" id="vaultPage">
          <div class="vault-balance">
            <div class="vault-label">Saldo do Cofre</div>
            <div class="vault-amount">
              <span id="vaultBalance">0</span>
              <span class="vault-currency">Kz</span>
            </div>
          </div>

          <div class="vault-actions">
            <button class="vault-action-btn" onclick="showAddFundsModal()">
              <i class="fas fa-plus-circle"></i>
              <span>Adicionar</span>
            </button>
            <button class="vault-action-btn" onclick="showWithdrawModal()">
              <i class="fas fa-minus-circle"></i>
              <span>Retirar</span>
            </button>
            <button class="vault-action-btn" onclick="showHistoryModal()">
              <i class="fas fa-history"></i>
              <span>HistÃ³rico</span>
            </button>
          </div>

          <div class="vault-history">
            <div class="vault-history-header">
              <i class="fas fa-list"></i> Ãšltimas MovimentaÃ§Ãµes
            </div>
            <div id="vaultHistory">
              <div class="vault-loading">
                <i class="fas fa-spinner"></i>
                <span>Carregando...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
          <div class="section-title">
            <i class="fas fa-user"></i>
            Meu Perfil
          </div>
          <div class="profile-header-card">
            <div class="profile-avatar-large" id="profileAvatar" onclick="openAvatarOptions()">EU</div>
            <input type="file" id="profileAvatarInput" accept="image/*" hidden onchange="handleProfileAvatarChange(this)">
            <h2 class="profile-name" id="profileName">UsuÃ¡rio</h2>
            <p class="profile-username" id="profileUsername">@usuario</p>
            <p class="profile-birth" id="profileBirth">26/04/2002 â€¢ 23 Anos</p>
            <div class="profile-stats">
              <div class="profile-stat">
                <div class="profile-stat-value" id="profilePostsCount">0</div>
                <div class="profile-stat-label">Postagens</div>
              </div>
              <div class="profile-stat">
                <div class="profile-stat-value" id="profileLikesCount">0</div>
                <div class="profile-stat-label">Curtidas</div>
              </div>
              <div class="profile-stat clickable" onclick="openProfileAbsencesModal()">
                <div class="profile-stat-value" id="profileAbsences">0</div>
                <div class="profile-stat-label">Faltas</div>
              </div>
            </div>
          </div>

          <!-- My Posts Section -->
          <div class="my-profile-posts-section">
            <div class="my-profile-posts-header">
              <div class="my-profile-posts-title">
                <i class="fas fa-newspaper"></i>
                Minhas PublicaÃ§Ãµes
              </div>
            </div>
            <div class="my-profile-posts-container" id="myProfilePostsContainer">
              <div class="my-profile-posts-loading">
                <i class="fas fa-spinner"></i>
                <p>Carregando publicaÃ§Ãµes...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Absences Page -->
        <div class="page" id="absencesPage">
          <div class="section-title">
            <i class="fas fa-calendar-xmark"></i>
            Controle de Faltas
          </div>
          <div id="absencesUsersContainer">
            <div class="posts-loading">
              <i class="fas fa-spinner"></i>
              <span>Carregando usuÃ¡rios...</span>
            </div>
          </div>
        </div>

        <!-- Notifications Page -->
        <div class="page" id="notificationsPage">
          <div class="notifications-header">
            <div class="notifications-header-title">
              <i class="fas fa-bell"></i>
              NotificaÃ§Ãµes
            </div>
          </div>

          <!-- Tabs -->
          <div class="notifications-tabs">
            <button class="notification-tab-btn active" data-tab="received" onclick="switchNotificationTab('received')">
              <i class="fas fa-inbox"></i>
              <span>Recebidas</span>
            </button>
            <button class="notification-tab-btn" data-tab="send" onclick="switchNotificationTab('send')">
              <i class="fas fa-paper-plane"></i>
              <span>Enviar</span>
            </button>
          </div>

          <!-- Tab Content: Received Notifications -->
          <div class="notification-tab-content active" id="receivedNotificationsTab">
            <div class="notifications-filters">
              <button class="notification-filter-btn active" data-filter="all" onclick="filterNotifications('all')">
                <i class="fas fa-layer-group"></i>
                <span>Todas</span>
              </button>
              <button class="notification-filter-btn" data-filter="unread" onclick="filterNotifications('unread')">
                <i class="fas fa-circle"></i>
                <span>NÃ£o lidas</span>
              </button>
              <button class="notifications-mark-all" id="markAllReadBtn" onclick="markAllNotificationsAsRead()">
                Marcar todas como lidas
              </button>
            </div>

            <div class="notifications-list" id="notificationsList">
              <!-- Notifications Empty State -->
              <div class="notifications-empty" id="notificationsEmpty">
                <div class="notifications-empty-icon">
                  <i class="fas fa-bell-slash"></i>
                </div>
                <h3>Nenhuma notificaÃ§Ã£o</h3>
                <p>Quando vocÃª receber curtidas, comentÃ¡rios ou menÃ§Ãµes, elas aparecerÃ£o aqui.</p>
              </div>
            </div>
          </div>

          <!-- Tab Content: Send Notifications -->
          <div class="notification-tab-content" id="sendNotificationsTab">
            <!-- Send Notification Form -->
            <div class="send-notification-section">
              <div class="send-notification-title">
                <i class="fas fa-bullhorn"></i>
                Enviar NotificaÃ§Ã£o
              </div>

              <!-- Recipient Type -->
              <div class="notification-recipient-type">
                <button class="recipient-type-btn active" data-type="all" onclick="setRecipientType('all')">
                  <i class="fas fa-users"></i>
                  <span>Todos</span>
                </button>
                <button class="recipient-type-btn" data-type="specific" onclick="setRecipientType('specific')">
                  <i class="fas fa-user"></i>
                  <span>EspecÃ­fico</span>
                </button>
              </div>

              <!-- User Selection (hidden by default) -->
              <div class="notification-user-select" id="userSelectSection">
                <label>Selecionar UsuÃ¡rio</label>
                <div class="user-select-dropdown">
                  <input type="text" class="user-select-input" id="userSelectInput" placeholder="Clique para selecionar um usuÃ¡rio..." readonly onclick="toggleUserDropdown()">
                  <div class="user-dropdown-list" id="userDropdownList">
                    <!-- Users will be populated here -->
                  </div>
                </div>
              </div>

              <!-- Notification Title -->
              <div class="notification-form-group">
                <label>TÃ­tulo</label>
                <input type="text" class="notification-input" id="notificationTitle" placeholder="Ex: Aviso Importante">
              </div>

              <!-- Notification Message -->
              <div class="notification-form-group">
                <label>Mensagem</label>
                <textarea class="notification-textarea" id="notificationMessage" placeholder="Digite a mensagem da notificaÃ§Ã£o..."></textarea>
              </div>

              <!-- Notification Type -->
              <div class="notification-form-group">
                <label>Tipo de NotificaÃ§Ã£o</label>
                <div class="notification-type-select">
                  <button class="notification-type-option type-system active" data-type="system" onclick="setNotificationType('system')">
                    <i class="fas fa-cog"></i>
                    <span>Sistema</span>
                  </button>
                  <button class="notification-type-option type-info" data-type="info" onclick="setNotificationType('info')">
                    <i class="fas fa-info-circle"></i>
                    <span>Info</span>
                  </button>
                  <button class="notification-type-option type-success" data-type="success" onclick="setNotificationType('success')">
                    <i class="fas fa-check-circle"></i>
                    <span>Sucesso</span>
                  </button>
                  <button class="notification-type-option type-warning" data-type="warning" onclick="setNotificationType('warning')">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Aviso</span>
                  </button>
                  <button class="notification-type-option type-danger" data-type="danger" onclick="setNotificationType('danger')">
                    <i class="fas fa-times-circle"></i>
                    <span>Urgente</span>
                  </button>
                </div>
              </div>

              <!-- Send Button -->
              <button class="send-notification-btn" id="sendNotificationBtn" onclick="sendNotification()">
                <span class="btn-text"><i class="fas fa-paper-plane"></i> Enviar NotificaÃ§Ã£o</span>
                <div class="spinner"></div>
              </button>
            </div>

            <!-- Sent Notifications History -->
            <div class="sent-notifications-section">
              <div class="sent-notifications-header">
                <div class="sent-notifications-title">
                  <i class="fas fa-history"></i>
                  <span>HistÃ³rico de Envios</span>
                </div>
                <button class="clear-sent-notifications-btn" onclick="clearSentNotifications()">
                  <i class="fas fa-trash-alt"></i> Limpar
                </button>
              </div>

              <div id="sentNotificationsList">
                <div class="sent-notifications-empty" id="sentNotificationsEmpty">
                  <i class="fas fa-paper-plane"></i>
                  <p>Nenhuma notificaÃ§Ã£o enviada ainda.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer Navigation -->
      <nav class="footer-nav">
        <button class="nav-item active" data-page="posts">
          <i class="fas fa-newspaper"></i>
          <span>Postagens</span>
        </button>
        <button class="nav-item" data-page="chat">
          <i class="fas fa-comments" data-page="chat"></i>
          <span data-page="chat">Conversas</span>
        </button>
        <button class="nav-item" data-page="vault">
          <i class="fas fa-vault"></i>
          <span>Cofre</span>
        </button>
        <button class="nav-avatar" id="navUserAvatar" onclick="openProfilePage()">
          <div class="nav-avatar-img" id="navAvatarImg">
            <i class="fas fa-user"></i>
          </div>
          <span>Perfil</span>
        </button>
      </nav>

      <!-- Chat Input (only visible on chat page) -->
      <div class="chat-input-container" id="chatInputContainer" style="display: none;">
        <div class="chat-image-preview" id="chatImagePreview">
          <img id="chatImagePreviewImg" src="" alt="Preview">
          <button class="chat-image-preview-remove" onclick="removeChatImage()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chat-input-wrapper">
          <button class="chat-image-btn" onclick="document.getElementById('chatImageInput').click()">
            <i class="fas fa-image"></i>
          </button>
          <input type="file" id="chatImageInput" accept="image/*" hidden onchange="previewChatImage(this)">
          <textarea class="chat-input" id="chatInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
          <button class="chat-send" id="chatSendBtn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
          <div class="modal-title" id="modalTitle">Adicionar Fundos</div>
          <p class="modal-text" id="modalText" style="display: none;"></p>
          <input type="number" class="modal-input" id="modalAmount" placeholder="Valor (Kz)">
          <input type="text" class="modal-input" id="modalDescription" placeholder="DescriÃ§Ã£o">
          <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal()">Cancelar</button>
            <button class="modal-btn confirm" id="modalConfirm">Confirmar</button>
          </div>
        </div>
      </div>

      <!-- Delete Confirm Modal -->
      <div class="modal-overlay" id="deleteModalOverlay">
        <div class="modal">
          <div class="modal-title">Excluir Postagem</div>
          <p class="modal-text" style="display: block;">Tem certeza que deseja excluir esta postagem? Esta aÃ§Ã£o nÃ£o pode ser desfeita.</p>
          <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeDeleteModal()">Cancelar</button>
            <button class="modal-btn danger" id="deleteConfirmBtn">Excluir</button>
          </div>
        </div>
      </div>

      <!-- Delete Message Confirm Modal -->
      <div class="modal-overlay" id="deleteMessageModalOverlay">
        <div class="modal">
          <div class="modal-title">Excluir Mensagem</div>
          <p class="modal-text" style="display: block;">Tem certeza que deseja excluir esta mensagem? Esta aÃ§Ã£o nÃ£o pode ser desfeita.</p>
          <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeDeleteMessageModal()">Cancelar</button>
            <button class="modal-btn danger" id="deleteMessageConfirmBtn">Excluir</button>
          </div>
        </div>
      </div>

      <!-- Delete Comment Confirm Modal -->
      <div class="modal-overlay" id="deleteCommentModalOverlay">
        <div class="modal">
          <div class="modal-title">Excluir ComentÃ¡rio</div>
          <p class="modal-text" style="display: block;">Tem certeza que deseja excluir este comentÃ¡rio?</p>
          <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeDeleteCommentModal()">Cancelar</button>
            <button class="modal-btn danger" id="deleteCommentConfirmBtn">Excluir</button>
          </div>
        </div>
      </div>

      <!-- Add Absence Modal -->
      <div class="modal-overlay" id="absenceModalOverlay">
        <div class="modal">
          <div class="modal-title">Registrar Falta</div>
          <div class="modal-user-info" id="absenceModalUserInfo" style="display: none;">
            <div class="modal-user-avatar" id="absenceModalUserAvatar"></div>
            <div>
              <div class="modal-user-name" id="absenceModalUserName"></div>
              <div class="modal-user-username" id="absenceModalUserUsername"></div>
            </div>
          </div>
          <input type="date" class="modal-input" id="absenceDate" style="color-scheme: dark;">
          <input type="text" class="modal-input" id="absenceReason" placeholder="Motivo (opcional)">
          <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeAbsenceModal()">Cancelar</button>
            <button class="modal-btn confirm" onclick="saveAbsenceForUser()">Registrar</button>
          </div>
        </div>
      </div>

      <!-- Delete Absence Confirm Modal -->
      <div class="modal-overlay" id="deleteAbsenceModalOverlay">
        <div class="modal">
          <div class="modal-title">Remover Falta</div>
          <p class="modal-text" style="display: block;">Tem certeza que deseja remover este registro de falta?</p>
          <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeDeleteAbsenceModal()">Cancelar</button>
            <button class="modal-btn danger" id="deleteAbsenceConfirmBtn">Remover</button>
          </div>
        </div>
      </div>

      <!-- Profile Absences History Modal -->
      <div class="profile-absences-modal-overlay" id="profileAbsencesModalOverlay" onclick="closeProfileAbsencesModal(event)">
        <div class="profile-absences-modal" onclick="event.stopPropagation()">
          <div class="profile-absences-modal-header">
            <div class="profile-absences-modal-title">
              <i class="fas fa-calendar-xmark"></i>
              <span>HistÃ³rico de Faltas</span>
            </div>
            <button class="profile-absences-modal-close" onclick="closeProfileAbsencesModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="profile-absences-modal-body" id="profileAbsencesModalBody">
            <div class="profile-absences-loading">
              <i class="fas fa-spinner"></i>
              <p>Carregando...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Image Viewer -->
      <div class="image-viewer" id="imageViewer">
        <div class="viewer-header">
          <span class="viewer-counter" id="viewerCounter">1 / 6</span>
          <div class="viewer-header-buttons">
            <button class="viewer-download" onclick="downloadCurrentImage()" title="Abrir no navegador">
              <i class="fas fa-download"></i>
            </button>
            <button class="viewer-close" onclick="closeViewer()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="viewer-container" id="viewerContainer">
          <div class="viewer-slides" id="viewerSlides"></div>
        </div>
        <div class="viewer-arrows">
          <button class="viewer-arrow" id="prevBtn" onclick="navigateViewer(-1)">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="viewer-arrow" id="nextBtn" onclick="navigateViewer(1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="viewer-nav" id="viewerNav"></div>
      </div>
    </div>

    <!-- User Profile Modal -->
    <div class="user-profile-modal" id="userProfileModal">
      <div class="user-profile-card">
        <button class="user-profile-close" onclick="closeUserProfileModal()">
          <i class="fas fa-times"></i>
        </button>
        <div id="userProfileContent">
          <div class="user-profile-loading">
            <i class="fas fa-spinner"></i>
            <span>Carregando perfil...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toastText">Mensagem</span>
    </div>

    <!-- Avatar Options Menu -->
    <div class="avatar-options-overlay" id="avatarOptionsOverlay" onclick="closeAvatarOptions(event)">
      <div class="avatar-options-menu" onclick="event.stopPropagation()">
        <div class="avatar-options-header">
          <div class="avatar-options-title">Foto do Perfil</div>
          <div class="avatar-options-subtitle">O que vocÃª deseja fazer?</div>
        </div>
        <button class="avatar-option-btn" onclick="viewProfilePhoto()">
          <i class="fas fa-eye"></i>
          <div class="avatar-option-text">
            <span>Visualizar foto</span>
            <small>Ver sua foto de perfil em tela cheia</small>
          </div>
        </button>
        <button class="avatar-option-btn" onclick="updateProfilePhoto()">
          <i class="fas fa-camera"></i>
          <div class="avatar-option-text">
            <span>Atualizar foto</span>
            <small>Escolher uma nova foto de perfil</small>
          </div>
        </button>
        <button class="avatar-options-cancel" onclick="closeAvatarOptions()">Cancelar</button>
      </div>
    </div>

    <!-- Profile Image Viewer -->
    <div class="profile-image-viewer" id="profileImageViewer">
      <div class="profile-image-viewer-header">
        <span class="profile-image-viewer-title">Minha Foto</span>
        <button class="profile-image-viewer-close" onclick="closeProfileImageViewer()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="profileImageViewerContent"></div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDW4AxNuJyL0E91Y2RsVgBkE6OpfDftS9o",
      authDomain: "exodoapp-44241.firebaseapp.com",
      projectId: "exodoapp-44241",
      storageBucket: "exodoapp-44241.firebasestorage.app",
      messagingSenderId: "980896035977",
      appId: "1:980896035977:web:a46ba09f6f37f8290ec258",
      measurementId: "G-B9GYTFEB8Q",
      databaseURL: "https://exodoapp-44241-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const rtdb = firebase.database();

    // ImgBB API Key
    const IMGBB_API_KEY = '456de0a6a924067712005b31aff4461e';

    // Current User Data
    let currentUser = null;
    let currentUserData = null;
    let postsUnsubscribe = null;
    let vaultUnsubscribe = null;

    // Vault PIN Security
    let vaultAuthenticated = false;
    const VAULT_PIN = '5665';
    let currentPinInput = '';
    let pendingVaultNavigation = null;
    let transactionsUnsubscribe = null;
    let messagesUnsubscribe = null;
    let presenceUnsubscribe = null;
    let onlineUsersCount = 0;

    // Post image files (multiple)
    let postImageFiles = [];

    // Vault data
    let vaultBalance = 0;

    // Theme detection
    function initTheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
        document.documentElement.classList.add('light');
        const icon = document.getElementById('themeIcon');
        if (icon) icon.className = 'fas fa-sun';
      }
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.remove('light');
        const icon = document.getElementById('themeIcon');
        if (icon) icon.className = 'fas fa-moon';
      } else {
        document.documentElement.classList.add('light');
        const icon = document.getElementById('themeIcon');
        if (icon) icon.className = 'fas fa-sun';
      }
    });

    function toggleTheme() {
      document.documentElement.classList.toggle('light');
      const isLight = document.documentElement.classList.contains('light');
      document.getElementById('themeIcon').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    }

    // Toggle new post card visibility
    function toggleNewPostCard() {
      const card = document.querySelector('.new-post-card');
      const icon = document.getElementById('newPostIcon');
      if (card) {
        // Se vai abrir o card, navega para a pÃ¡gina de postagens primeiro
        const isCurrentlyVisible = card.classList.contains('visible');
        if (!isCurrentlyVisible) {
          showPage('posts');
        }
        card.classList.toggle('visible');
        const isVisible = card.classList.contains('visible');
        icon.className = isVisible ? 'fas fa-times' : 'fas fa-plus';
        if (isVisible) {
          document.getElementById('newPostInput').focus();
        }
      }
    }

    // Hide new post card
    function hideNewPostCard() {
      const card = document.querySelector('.new-post-card');
      const icon = document.getElementById('newPostIcon');
      if (card) {
        card.classList.remove('visible');
        icon.className = 'fas fa-plus';
      }
    }

    // ==================== PRESENCE SYSTEM ====================

    // Setup presence for current user
    function setupPresence(user) {
      if (!user) return;

      const userPresenceRef = rtdb.ref('presence/' + user.uid);
      const connectedRef = rtdb.ref('.info/connected');

      connectedRef.on('value', (snapshot) => {
        if (snapshot.val() === true) {
          // User is connected
          const presenceData = {
            online: true,
            lastSeen: firebase.database.ServerValue.TIMESTAMP,
            displayName: currentUserData?.name || user.displayName || 'UsuÃ¡rio',
            photoURL: currentUserData?.photoURL || user.photoURL || null
          };

          // Set presence as online
          userPresenceRef.set(presenceData);

          // When user disconnects, update presence
          userPresenceRef.onDisconnect().set({
            online: false,
            lastSeen: firebase.database.ServerValue.TIMESTAMP,
            displayName: currentUserData?.name || user.displayName || 'UsuÃ¡rio',
            photoURL: currentUserData?.photoURL || user.photoURL || null
          });
        }
      });
    }

    // Remove presence when logging out
    async function removePresence() {
      if (currentUser) {
        const userPresenceRef = rtdb.ref('presence/' + currentUser.uid);
        try {
          await userPresenceRef.set({
            online: false,
            lastSeen: firebase.database.ServerValue.TIMESTAMP,
            displayName: currentUserData?.name || 'UsuÃ¡rio',
            photoURL: currentUserData?.photoURL || null
          });
        } catch (err) {
          console.error('Error removing presence:', err);
        }
      }
    }

    // Subscribe to online users count
    function subscribeToPresence() {
      const presenceRef = rtdb.ref('presence');

      presenceUnsubscribe = presenceRef.on('value', (snapshot) => {
        let count = 0;
        const data = snapshot.val();

        if (data) {
          Object.keys(data).forEach(uid => {
            if (data[uid].online === true) {
              count++;
            }
          });
        }

        onlineUsersCount = count;
        updateOnlineCount(count);
      });
    }

    // Update online count in UI
    function updateOnlineCount(count) {
      const countEl = document.getElementById('onlineCount');
      if (countEl) {
        countEl.textContent = count;
      }
    }

    // Unsubscribe from presence
    function unsubscribeFromPresence() {
      if (presenceUnsubscribe) {
        rtdb.ref('presence').off('value', presenceUnsubscribe);
        presenceUnsubscribe = null;
      }
    }

    // ==================== END PRESENCE SYSTEM ====================

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastText = document.getElementById('toastText');
      const icon = toast.querySelector('i');

      toastText.textContent = message;
      toast.className = 'toast ' + type;
      icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Screen Management
    function showScreen(screen) {
      document.getElementById('loginScreen').classList.remove('active');
      document.getElementById('registerScreen').classList.remove('active');
      document.getElementById('mainApp').classList.remove('active');

      if (screen === 'login') {
        document.getElementById('loginScreen').classList.add('active');
      } else if (screen === 'register') {
        document.getElementById('registerScreen').classList.add('active');
      } else if (screen === 'main') {
        document.getElementById('mainApp').classList.add('active');
      }
    }

    // Password toggle
    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      const icon = btn.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    }

    // Avatar preview
    let avatarFile = null;
    function previewAvatar(input) {
      if (input.files && input.files[0]) {
        avatarFile = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('avatarPreview');
          preview.innerHTML = '<img src="' + e.target.result + '" alt="Avatar">';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Post images preview (multiple)
    function previewPostImages(input) {
      if (input.files && input.files.length > 0) {
        const newFiles = Array.from(input.files);
        postImageFiles = [...postImageFiles, ...newFiles];
        renderPostPreviewGrid();
      }
    }

    function renderPostPreviewGrid() {
      const grid = document.getElementById('newPostPreviewGrid');
      const preview = document.getElementById('newPostPreview');

      if (postImageFiles.length === 0) {
        preview.classList.remove('show');
        grid.innerHTML = '';
        return;
      }

      preview.classList.add('show');
      grid.innerHTML = '';

      postImageFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const item = document.createElement('div');
          item.className = 'new-post-preview-item';
          item.innerHTML = '<img src="' + e.target.result + '" alt="Preview">' +
            '<button class="new-post-preview-item-remove" onclick="removePostImageAt(' + index + ')">' +
            '<i class="fas fa-times"></i></button>';
          grid.appendChild(item);
        };
        reader.readAsDataURL(file);
      });
    }

    function removePostImageAt(index) {
      postImageFiles.splice(index, 1);
      renderPostPreviewGrid();
      if (postImageFiles.length === 0) {
        document.getElementById('postImageInput').value = '';
      }
    }

    function removeAllPostImages() {
      postImageFiles = [];
      document.getElementById('newPostPreview').classList.remove('show');
      document.getElementById('newPostPreviewGrid').innerHTML = '';
      document.getElementById('postImageInput').value = '';
    }

    // Chat image preview and handling
    let chatImageFile = null;

    function previewChatImage(input) {
      if (input.files && input.files[0]) {
        chatImageFile = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('chatImagePreviewImg').src = e.target.result;
          document.getElementById('chatImagePreview').classList.add('show');
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function removeChatImage() {
      chatImageFile = null;
      document.getElementById('chatImagePreview').classList.remove('show');
      document.getElementById('chatImageInput').value = '';
    }

    // Open chat image in full screen viewer
    function openChatImage(imageURL) {
      const viewer = document.getElementById('imageViewer');
      const slidesContainer = document.getElementById('viewerSlides');
      const navContainer = document.getElementById('viewerNav');

      // Reset state before opening
      currentTranslate = 0;
      prevTranslate = 0;
      currentImageIndex = 0;
      galleryPhotos = [{ url: imageURL }];

      slidesContainer.style.transition = 'none';
      slidesContainer.style.transform = 'translateX(0)';
      slidesContainer.innerHTML = '<div class="viewer-slide"><img class="viewer-image" src="' + imageURL + '" alt="Imagem da conversa"></div>';
      navContainer.innerHTML = '';
      document.getElementById('viewerCounter').textContent = '1 / 1';
      document.getElementById('prevBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';

      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Open profile image in full screen viewer
    function openProfileImage(imageURL) {
      if (!imageURL) return;

      const viewer = document.getElementById('imageViewer');
      const slidesContainer = document.getElementById('viewerSlides');
      const navContainer = document.getElementById('viewerNav');

      // Reset state before opening
      currentTranslate = 0;
      prevTranslate = 0;
      currentImageIndex = 0;
      galleryPhotos = [{ url: imageURL }];

      slidesContainer.style.transition = 'none';
      slidesContainer.style.transform = 'translateX(0)';
      slidesContainer.innerHTML = '<div class="viewer-slide"><img class="viewer-image" src="' + imageURL + '" alt="Foto do perfil"></div>';
      navContainer.innerHTML = '';
      document.getElementById('viewerCounter').textContent = '1 / 1';
      document.getElementById('prevBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';

      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Upload image to ImgBB
    async function uploadToImgBB(file) {
      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch('https://api.imgbb.com/1/upload?key=' + IMGBB_API_KEY, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (data.success) {
          return data.data.url;
        }
        throw new Error('Upload failed');
      } catch (error) {
        console.error('ImgBB upload error:', JSON.stringify(error));
        return null;
      }
    }

    // Calculate age
    function calculateAge(birthdate) {
      const today = new Date();
      const birth = new Date(birthdate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }

    // Check if today is user's birthday
    function isTodayBirthday(birthdate) {
      if (!birthdate) return false;
      const today = new Date();
      const birth = new Date(birthdate);
      return today.getDate() === birth.getDate() && today.getMonth() === birth.getMonth();
    }

    // Activate birthday mode
    let birthdayConfettiInterval = null;

    function activateBirthdayMode(userName) {
      // Add birthday class to html
      document.documentElement.classList.add('birthday-mode');

      // Show birthday banner
      const banner = document.getElementById('birthdayBanner');
      const bannerText = banner.querySelector('.birthday-banner-text');
      if (userName) {
        bannerText.textContent = 'Feliz AniversÃ¡rio, ' + userName.split(' ')[0] + '! Hoje Ã© o seu dia especial!';
      }
      banner.classList.add('active');

      // Start confetti
      startBirthdayConfetti();

      // Show confetti for 10 seconds then stop (but keep theme)
      setTimeout(stopBirthdayConfetti, 10000);
    }

    function deactivateBirthdayMode() {
      document.documentElement.classList.remove('birthday-mode');
      document.getElementById('birthdayBanner').classList.remove('active');
      stopBirthdayConfetti();
    }

    function startBirthdayConfetti() {
      const container = document.getElementById('birthdayConfetti');
      container.innerHTML = '';

      // Create confetti pieces
      function createConfetti() {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random() * 100 + '%';
        piece.style.animationDuration = (3 + Math.random() * 2) + 's';
        piece.style.animationDelay = Math.random() * 0.5 + 's';
        container.appendChild(piece);

        // Remove after animation
        setTimeout(() => piece.remove(), 5000);
      }

      // Initial burst
      for (let i = 0; i < 30; i++) {
        setTimeout(() => createConfetti(), i * 50);
      }

      // Continuous confetti
      birthdayConfettiInterval = setInterval(() => {
        for (let i = 0; i < 5; i++) {
          createConfetti();
        }
      }, 500);
    }

    function stopBirthdayConfetti() {
      if (birthdayConfettiInterval) {
        clearInterval(birthdayConfettiInterval);
        birthdayConfettiInterval = null;
      }
    }

    // Check and apply birthday mode for current user
    async function checkBirthday(userData) {
      if (userData && userData.birthdate && isTodayBirthday(userData.birthdate)) {
        activateBirthdayMode(userData.name);
        // Check and create birthday post automatically
        await checkAndCreateBirthdayPost(userData);
      } else {
        deactivateBirthdayMode();
      }
    }

    // Check if user already posted birthday message today and create if not
    async function checkAndCreateBirthdayPost(userData) {
      if (!currentUser || !userData) return;

      try {
        // Get today's date in YYYY-MM-DD format for comparison
        const today = new Date();
        const todayStr = today.getFullYear() + '-' +
                        String(today.getMonth() + 1).padStart(2, '0') + '-' +
                        String(today.getDate()).padStart(2, '0');

        // Check if user already posted birthday message today
        // Using only authorId query to avoid needing composite index
        const userPostsSnapshot = await db.collection('posts')
          .where('authorId', '==', currentUser.uid)
          .get();

        let alreadyPostedToday = false;

        userPostsSnapshot.forEach(doc => {
          const post = doc.data();
          // Filter on client side to check for birthday post today
          if (post.isBirthdayPost === true && post.birthdayPostDate === todayStr) {
            alreadyPostedToday = true;
          }
        });

        if (alreadyPostedToday) {
          console.log('Birthday post already created today');
          return;
        }

        // Create birthday post with profile photo
        const birthdayMessage = 'ðŸŽ‰ Hoje Ã© meu aniversÃ¡rio! ðŸŽ‰ Estou tÃ£o feliz por compartilhar este momento especial com todos vocÃªs. Vamos celebrar juntos? Deixem seus parabÃ©ns nos comentÃ¡rios, assim vocÃªs fazem meu dia ainda mais especial! ðŸ’–';

        const postData = {
          content: birthdayMessage,
          authorId: currentUser.uid,
          authorName: userData.name || 'UsuÃ¡rio',
          authorPhotoURL: userData.photoURL || null,
          likes: 0,
          likedBy: [],
          isBirthdayPost: true,
          birthdayPostDate: todayStr,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Add profile photo as post image if user has one
        if (userData.photoURL) {
          postData.imageURL = userData.photoURL;
          postData.imageURLs = [userData.photoURL];
        }

        await db.collection('posts').add(postData);
        showToast('ðŸŽ‚ Postagem de aniversÃ¡rio publicada automaticamente!');
        console.log('Birthday post created successfully');

      } catch (error) {
        console.error('Error checking/creating birthday post:', JSON.stringify(error));
        // Don't let birthday post error break the app - just log and continue
      }
    }

    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      return day + '/' + month + '/' + year;
    }

    // Get initials
    function getInitials(name) {
      if (!name) return 'EU';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    // Format time ago
    function timeAgo(timestamp) {
      if (!timestamp) return 'Agora';

      const now = new Date();
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHours = Math.floor(diffMin / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffSec < 60) return 'Agora';
      if (diffMin < 60) return 'HÃ¡ ' + diffMin + ' min';
      if (diffHours < 24) return 'HÃ¡ ' + diffHours + ' hora' + (diffHours > 1 ? 's' : '');
      if (diffDays === 1) return 'Ontem';
      if (diffDays < 7) return 'HÃ¡ ' + diffDays + ' dias';
      return formatDate(date);
    }

    // Format time for chat
    function formatChatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
    }

    // Format date for transactions
    function formatTransactionDate(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      return date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
    }

    // Handle Login
    async function handleLogin() {
      const usernameInput = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      const error = document.getElementById('loginError');
      const errorText = document.getElementById('loginErrorText');

      error.classList.remove('show');

      if (!usernameInput || !password) {
        errorText.textContent = 'Preencha todos os campos';
        error.classList.add('show');
        return;
      }

      const email = usernameInput.includes('@') ? usernameInput : usernameInput + '@gmail.com';

      btn.classList.add('loading');
      btn.disabled = true;

      try {
        await auth.signInWithEmailAndPassword(email, password);
        showToast('Login realizado com sucesso!');
      } catch (err) {
        let message = 'Erro ao fazer login';
        if (err.code === 'auth/user-not-found') {
          message = 'UsuÃ¡rio nÃ£o encontrado';
        } else if (err.code === 'auth/wrong-password') {
          message = 'Senha incorreta';
        } else if (err.code === 'auth/invalid-email') {
          message = 'Email invÃ¡lido';
        } else if (err.code === 'auth/too-many-requests') {
          message = 'Muitas tentativas. Tente mais tarde';
        }
        errorText.textContent = message;
        error.classList.add('show');
      }

      btn.classList.remove('loading');
      btn.disabled = false;
    }

    // Handle Register
    async function handleRegister() {
      const name = document.getElementById('registerName').value.trim();
      const usernameInput = document.getElementById('registerUsername').value.trim();
      const birthdate = document.getElementById('registerBirthdate').value;
      const password = document.getElementById('registerPassword').value;
      const btn = document.getElementById('registerBtn');
      const error = document.getElementById('registerError');
      const errorText = document.getElementById('registerErrorText');

      error.classList.remove('show');

      if (!name || !usernameInput || !birthdate || !password) {
        errorText.textContent = 'Preencha todos os campos';
        error.classList.add('show');
        return;
      }

      if (password.length < 6) {
        errorText.textContent = 'A senha deve ter pelo menos 6 caracteres';
        error.classList.add('show');
        return;
      }

      const email = usernameInput.includes('@') ? usernameInput : usernameInput + '@gmail.com';

      btn.classList.add('loading');
      btn.disabled = true;

      try {
        // Upload avatar if exists
        let photoURL = null;
        if (avatarFile) {
          photoURL = await uploadToImgBB(avatarFile);
        }

        // Create user
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Save user data to Firestore
        await db.collection('users').doc(user.uid).set({
          name: name,
          username: usernameInput,
          email: email,
          birthdate: birthdate,
          photoURL: photoURL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update profile
        await user.updateProfile({
          displayName: name,
          photoURL: photoURL
        });

        showToast('Conta criada com sucesso!');
        avatarFile = null;
      } catch (err) {
        let message = 'Erro ao criar conta';
        if (err.code === 'auth/email-already-in-use') {
          message = 'Este usuÃ¡rio jÃ¡ estÃ¡ em uso';
        } else if (err.code === 'auth/weak-password') {
          message = 'Senha muito fraca';
        } else if (err.code === 'auth/invalid-email') {
          message = 'Email invÃ¡lido';
        }
        errorText.textContent = message;
        error.classList.add('show');
      }

      btn.classList.remove('loading');
      btn.disabled = false;
    }

    // Handle Logout
    async function handleLogout() {
      try {
        // Try to remove presence, but don't let it block logout
        try {
          await removePresence();
        } catch (presenceErr) {
          console.error('Error removing presence:', presenceErr);
        }

        // Safely unsubscribe from presence
        try {
          unsubscribeFromPresence();
        } catch (unsubErr) {
          console.error('Error unsubscribing from presence:', unsubErr);
        }

        // Cleanup notifications listener
        try {
          cleanupNotificationsListener();
        } catch (notifErr) {
          console.error('Error cleaning up notifications:', notifErr);
        }

        // Safely unsubscribe from all listeners
        try {
          if (postsUnsubscribe) {
            postsUnsubscribe();
            postsUnsubscribe = null;
          }
        } catch (e) { console.error('Error unsubscribing posts:', e); }

        try {
          if (vaultUnsubscribe) {
            vaultUnsubscribe();
            vaultUnsubscribe = null;
          }
        } catch (e) { console.error('Error unsubscribing vault:', e); }

        try {
          if (transactionsUnsubscribe) {
            transactionsUnsubscribe();
            transactionsUnsubscribe = null;
          }
        } catch (e) { console.error('Error unsubscribing transactions:', e); }

        try {
          if (messagesUnsubscribe) {
            messagesUnsubscribe();
            messagesUnsubscribe = null;
          }
        } catch (e) { console.error('Error unsubscribing messages:', e); }

        // Reset vault authentication on logout
        vaultAuthenticated = false;

        // Reset user data
        currentUser = null;
        currentUserData = null;

        // Close sidebar before signing out
        closeSidebar();

        // Sign out from Firebase
        await auth.signOut();

        // Force show login screen immediately after signOut
        showScreen('login');
        showToast('VocÃª saiu da conta');
      } catch (err) {
        console.error('Logout error:', err);
        // Even if there's an error, try to force sign out and show login
        try {
          await auth.signOut();
          showScreen('login');
          showToast('VocÃª saiu da conta');
        } catch (signOutErr) {
          console.error('Force signout failed:', signOutErr);
          // Still try to show login screen
          showScreen('login');
          showToast('Erro ao sair. Tente novamente.', 'error');
        }
      }
    }

    // Update UI with user data
    function updateUserUI(userData) {
      currentUserData = userData;

      const name = userData.name || 'UsuÃ¡rio';
      const initials = getInitials(name);
      const photoURL = userData.photoURL;
      const email = userData.email || '';
      const birthdate = userData.birthdate;

      // Sidebar
      const sidebarAvatar = document.getElementById('sidebarAvatar');
      if (photoURL) {
        sidebarAvatar.innerHTML = '<img src="' + photoURL + '" alt="Avatar">';
      } else {
        sidebarAvatar.innerHTML = initials;
      }
      document.getElementById('sidebarName').textContent = name;
      document.getElementById('sidebarEmail').textContent = email;

      // Profile Page
      const profileAvatar = document.getElementById('profileAvatar');
      if (photoURL) {
        profileAvatar.innerHTML = '<img src="' + photoURL + '" alt="Avatar">';
      } else {
        profileAvatar.innerHTML = initials;
      }
      document.getElementById('profileName').textContent = name;
      document.getElementById('profileUsername').textContent = '@' + (userData.username || email);

      // Footer Nav Avatar
      const navAvatarImg = document.getElementById('navAvatarImg');
      if (navAvatarImg) {
        if (photoURL) {
          navAvatarImg.innerHTML = '<img src="' + photoURL + '" alt="Avatar">';
        } else {
          navAvatarImg.innerHTML = initials;
        }
      }

      if (birthdate) {
        const age = calculateAge(birthdate);
        document.getElementById('profileBirth').textContent = formatDate(birthdate) + ' â€¢ ' + age + ' Anos';
      }
    }

    // Auth state observer
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        try {
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) {
            const userData = doc.data();
            updateUserUI(userData);
            // Check if today is user's birthday
            checkBirthday(userData);
          } else {
            // Create user profile if it doesn't exist
            const userData = {
              name: user.displayName || 'UsuÃ¡rio',
              email: user.email,
              photoURL: user.photoURL,
              username: user.email ? user.email.split('@')[0] : 'usuario',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('users').doc(user.uid).set(userData);
            updateUserUI(userData);
            checkBirthday(userData);
          }
        } catch (err) {
          console.error('Error fetching user data:', JSON.stringify(err));
          updateUserUI({
            name: user.displayName || 'UsuÃ¡rio',
            email: user.email,
            photoURL: user.photoURL
          });
        }
        showScreen('main');
        subscribeToPosts();
        subscribeToVault();
        subscribeToTransactions();
        subscribeToMessages();
        updateProfileStats();

        // Setup presence system
        setupPresence(user);
        subscribeToPresence();

        // Setup notifications listener
        setupNotificationsListener();
      } else {
        // Remove presence before logging out
        removePresence();
        unsubscribeFromPresence();

        // Cleanup notifications listener
        cleanupNotificationsListener();

        // Deactivate birthday mode on logout
        deactivateBirthdayMode();

        currentUser = null;
        currentUserData = null;
        if (postsUnsubscribe) {
          postsUnsubscribe();
          postsUnsubscribe = null;
        }
        if (vaultUnsubscribe) {
          vaultUnsubscribe();
          vaultUnsubscribe = null;
        }
        if (transactionsUnsubscribe) {
          transactionsUnsubscribe();
          transactionsUnsubscribe = null;
        }
        if (messagesUnsubscribe) {
          messagesUnsubscribe();
          messagesUnsubscribe = null;
        }
        updateOnlineCount(0);
        showScreen('login');
      }
    });

    // Subscribe to posts from Firestore
    function subscribeToPosts() {
      const container = document.getElementById('postsContainer');
      container.innerHTML = '<div class="posts-loading"><i class="fas fa-spinner"></i><span>Carregando postagens...</span></div>';

      postsUnsubscribe = db.collection('posts')
        .orderBy('createdAt', 'desc')
        .limit(50)
        .onSnapshot((snapshot) => {
          if (snapshot.empty) {
            container.innerHTML = '<div class="posts-empty"><i class="fas fa-newspaper"></i><p>Nenhuma postagem ainda.<br>Seja o primeiro a compartilhar!</p></div>';
            return;
          }

          const posts = [];
          snapshot.forEach(doc => {
            posts.push({ id: doc.id, ...doc.data() });
          });

          postsCache = posts;
          applyPostsFilter();
          updateProfileStats();
        }, (error) => {
          console.error('Error loading posts:', JSON.stringify(error));
          container.innerHTML = '<div class="posts-empty"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar postagens.</p></div>';
        });
    }

    // Subscribe to vault balance - calculado a partir das transaÃ§Ãµes
    function subscribeToVault() {
      // Cancelar inscriÃ§Ã£o anterior se existir
      if (vaultUnsubscribe && typeof vaultUnsubscribe === 'function') {
        vaultUnsubscribe();
        vaultUnsubscribe = null;
      }

      // Mostrar estado de carregamento
      const balanceEl = document.getElementById('vaultBalance');
      if (balanceEl) {
        balanceEl.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 14px;"></i>';
      }

      try {
        // Escutar TODAS as transaÃ§Ãµes para calcular o saldo real
        const unsubscribeFn = db.collection('transactions')
          .onSnapshot(
            { includeMetadataChanges: true },
            (snapshot) => {
              // Calcular saldo baseado nas transaÃ§Ãµes: entradas - saÃ­das
              let totalIncome = 0;
              let totalExpense = 0;

              snapshot.forEach(doc => {
                const data = doc.data();
                const amount = typeof data.amount === 'number' ? data.amount : 0;

                if (data.type === 'income') {
                  totalIncome += amount;
                } else if (data.type === 'expense') {
                  totalExpense += amount;
                }
              });

              // Saldo = entradas - saÃ­das
              vaultBalance = totalIncome - totalExpense;

              console.log('Vault calculated - Income:', totalIncome, 'Expense:', totalExpense, 'Balance:', vaultBalance);

              updateVaultBalance();

              // Indicar visualmente se estÃ¡ sincronizando
              if (snapshot.metadata.hasPendingWrites) {
                if (balanceEl) {
                  balanceEl.style.opacity = '0.7';
                }
              } else {
                if (balanceEl) {
                  balanceEl.style.opacity = '1';
                }
              }
            },
            (error) => {
              console.error('Error loading vault from transactions:', JSON.stringify(error));

              // Mostrar erro visual
              if (balanceEl) {
                balanceEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>';
              }

              // Fallback: mostrar 0
              vaultBalance = 0;
              updateVaultBalance();
            }
          );

        // Guardar referÃªncia correta da funÃ§Ã£o de unsubscribe
        vaultUnsubscribe = unsubscribeFn;

      } catch (err) {
        console.error('Error setting up vault subscription:', JSON.stringify(err));
        if (balanceEl) {
          balanceEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>';
        }
      }
    }

    // Subscribe to transactions from Firestore
    function subscribeToTransactions() {
      const container = document.getElementById('vaultHistory');
      container.innerHTML = '<div class="vault-loading"><i class="fas fa-spinner"></i><span>Carregando...</span></div>';

      transactionsUnsubscribe = db.collection('transactions')
        .orderBy('createdAt', 'desc')
        .limit(20)
        .onSnapshot((snapshot) => {
          if (snapshot.empty) {
            container.innerHTML = '<div class="vault-empty"><i class="fas fa-receipt"></i><p>Nenhuma movimentaÃ§Ã£o ainda.</p></div>';
            return;
          }

          const transactions = [];
          snapshot.forEach(doc => {
            transactions.push({ id: doc.id, ...doc.data() });
          });

          renderTransactionsFromFirestore(transactions);
        }, (error) => {
          console.error('Error loading transactions:', JSON.stringify(error));
          container.innerHTML = '<div class="vault-empty"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar movimentaÃ§Ãµes.</p></div>';
        });
    }

    // Subscribe to messages from Realtime Database
    function subscribeToMessages() {
      const container = document.getElementById('chatContainer');
      container.innerHTML = '<div class="chat-loading"><i class="fas fa-spinner"></i><span>Carregando mensagens...</span></div>';

      const messagesRef = rtdb.ref('messages').orderByChild('timestamp').limitToLast(100);

      messagesUnsubscribe = messagesRef.on('value', (snapshot) => {
        const messages = [];
        snapshot.forEach((child) => {
          messages.push({ id: child.key, ...child.val() });
        });

        if (messages.length === 0) {
          container.innerHTML = '<div class="chat-empty"><i class="fas fa-comments"></i><p>Nenhuma mensagem ainda.<br>Comece a conversa!</p></div>';
          return;
        }

        renderMessagesFromRTDB(messages);

        // Scroll to bottom
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 100);
      }, (error) => {
        console.error('Error loading messages:', JSON.stringify(error));
        container.innerHTML = '<div class="chat-empty"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar mensagens.</p></div>';
      });
    }

    // Render messages from Realtime Database
    function renderMessagesFromRTDB(messages) {
      const container = document.getElementById('chatContainer');

      if (messages.length === 0) {
        container.innerHTML = '<div class="chat-empty"><i class="fas fa-comments"></i><p>Nenhuma mensagem ainda.<br>Comece a conversa!</p></div>';
        return;
      }

      container.innerHTML = messages.map(msg => {
        const isSent = currentUser && msg.senderId === currentUser.uid;
        const avatarContent = msg.senderPhotoURL
          ? '<img src="' + escapeHtml(msg.senderPhotoURL) + '" alt="">'
          : getInitials(msg.senderName);
        const longPressAttr = isSent
          ? 'data-deletable="true" data-msg-id="' + msg.id + '"'
          : '';
        const imageHtml = msg.imageURL
          ? '<img class="chat-message-image" src="' + escapeHtml(msg.imageURL) + '" alt="Imagem" onclick="openChatImage(\'' + escapeHtml(msg.imageURL) + '\')">'
          : '';
        const textHtml = msg.text
          ? '<div class="chat-text">' + escapeHtml(msg.text) + '</div>'
          : '';

        return '<div class="chat-message ' + (isSent ? 'sent' : '') + '" data-message-id="' + msg.id + '">' +
          '<div class="chat-avatar-small" ' + longPressAttr + '>' + avatarContent + '</div>' +
          '<div class="chat-bubble-wrapper">' +
            '<div class="chat-bubble">' +
              '<div class="chat-sender" data-sender-id="' + escapeHtml(msg.senderId) + '">' + escapeHtml(msg.senderName || 'UsuÃ¡rio') + '</div>' +
              textHtml +
              imageHtml +
              '<div class="chat-time">' + formatChatTime(msg.timestamp) + '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');

      // Setup long-press handlers for deletable avatars
      setupLongPressHandlers();

      // Setup click handlers for sender name profile view
      setupSenderNameClickHandlers();
    }

    // Long-press handler for deleting messages
    let longPressTimer = null;
    const LONG_PRESS_DURATION = 600; // ms

    function setupLongPressHandlers() {
      const deletableAvatars = document.querySelectorAll('.chat-avatar-small[data-deletable="true"]');

      deletableAvatars.forEach(avatar => {
        // Touch events
        avatar.addEventListener('touchstart', handleLongPressStart, { passive: true });
        avatar.addEventListener('touchend', handleLongPressEnd);
        avatar.addEventListener('touchcancel', handleLongPressEnd);
        avatar.addEventListener('touchmove', handleLongPressEnd);

        // Mouse events (for desktop)
        avatar.addEventListener('mousedown', handleLongPressStart);
        avatar.addEventListener('mouseup', handleLongPressEnd);
        avatar.addEventListener('mouseleave', handleLongPressEnd);
      });
    }

    function handleLongPressStart(e) {
      const avatar = e.currentTarget;
      const msgId = avatar.dataset.msgId;
      if (!msgId) return;

      longPressTimer = setTimeout(() => {
        avatar.classList.add('long-press-active');
        setTimeout(() => {
          avatar.classList.remove('long-press-active');
        }, 300);
        confirmDeleteMessage(msgId);
      }, LONG_PRESS_DURATION);
    }

    function handleLongPressEnd() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    // Setup click handlers for sender name profile view
    function setupSenderNameClickHandlers() {
      const senderNames = document.querySelectorAll('.chat-sender[data-sender-id]');

      senderNames.forEach(senderName => {
        senderName.addEventListener('click', handleSenderNameClick);
      });
    }

    function handleSenderNameClick(e) {
      const senderElement = e.currentTarget;
      const senderId = senderElement.dataset.senderId;

      if (senderId) {
        showUserProfile(senderId);
      }
    }

    // Open current user profile modal (from sidebar/profile page avatar)
    function openCurrentUserProfileModal() {
      if (currentUser && currentUser.uid) {
        closeSidebar();
        showUserProfile(currentUser.uid);
      } else {
        showToast('FaÃ§a login para ver seu perfil', 'error');
      }
    }

    // Show user profile modal
    async function showUserProfile(userId) {
      const modal = document.getElementById('userProfileModal');
      const content = document.getElementById('userProfileContent');

      // Show loading state
      content.innerHTML = '<div class="user-profile-loading"><i class="fas fa-spinner"></i><span>Carregando perfil...</span></div>';
      modal.classList.add('active');

      try {
        // Fetch user data from Firestore
        const userDoc = await db.collection('users').doc(userId).get();

        if (!userDoc.exists) {
          content.innerHTML = '<div class="user-profile-loading"><i class="fas fa-user-slash"></i><span>UsuÃ¡rio nÃ£o encontrado</span></div>';
          return;
        }

        const userData = userDoc.data();

        // Check if user is online from presence
        let isOnline = false;
        try {
          const presenceSnapshot = await rtdb.ref('presence/' + userId).once('value');
          const presenceData = presenceSnapshot.val();
          isOnline = presenceData && presenceData.online === true;
        } catch (err) {
          console.error('Error checking presence:', JSON.stringify(err));
        }

        // Count user posts
        let postsCount = 0;
        try {
          const postsSnapshot = await db.collection('posts').where('authorId', '==', userId).get();
          postsCount = postsSnapshot.size;
        } catch (err) {
          console.error('Error counting posts:', JSON.stringify(err));
        }

        // Count user likes received
        let likesCount = 0;
        try {
          const userPostsSnapshot = await db.collection('posts').where('authorId', '==', userId).get();
          userPostsSnapshot.forEach(doc => {
            const postData = doc.data();
            likesCount += postData.likes || 0;
          });
        } catch (err) {
          console.error('Error counting likes:', JSON.stringify(err));
        }

        // Count user absences
        let absencesCount = 0;
        try {
          const absencesSnapshot = await db.collection('absences').where('userId', '==', userId).get();
          absencesCount = absencesSnapshot.size;
        } catch (err) {
          console.error('Error counting absences:', JSON.stringify(err));
        }

        // Build profile HTML
        const hasPhoto = userData.photoURL ? true : false;
        const avatarClickAttr = hasPhoto ? 'onclick="openProfileImage(\'' + escapeHtml(userData.photoURL) + '\')"' : '';
        const avatarContent = hasPhoto
          ? '<img src="' + escapeHtml(userData.photoURL) + '" alt="Avatar">'
          : getInitials(userData.name);

        const statusClass = isOnline ? '' : 'offline';
        const statusText = isOnline ? 'Online' : 'Offline';

        // Build birthdate HTML if exists
        let birthdateHtml = '';
        if (userData.birthdate) {
          const age = calculateAge(userData.birthdate);
          birthdateHtml = '<p class="user-profile-birth"><i class="fas fa-birthday-cake"></i>' + formatDate(userData.birthdate) + ' â€¢ ' + age + ' Anos</p>';
        }

        // Fetch user posts
        let userPosts = [];
        try {
          const userPostsSnapshot = await db.collection('posts')
            .where('authorId', '==', userId)
            .get();

          userPostsSnapshot.forEach(doc => {
            userPosts.push({ id: doc.id, ...doc.data() });
          });

          // Sort by createdAt desc on client side (avoids needing composite index)
          userPosts.sort((a, b) => {
            const timeA = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt || 0);
            const timeB = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt || 0);
            return timeB - timeA;
          });

          // Limit to 10 posts after sorting
          userPosts = userPosts.slice(0, 10);
        } catch (err) {
          console.error('Error fetching user posts:', JSON.stringify(err));
        }

        // Build posts HTML
        let postsHtml = '';
        if (userPosts.length > 0) {
          const postsListHtml = userPosts.map(post => {
            let imagesHtml = '';
            let images = [];

            if (post.imageURLs && Array.isArray(post.imageURLs) && post.imageURLs.length > 0) {
              images = post.imageURLs;
            } else if (post.imageURL) {
              images = [post.imageURL];
            }

            if (images.length > 0) {
              imagesHtml = '<div class="user-profile-post-images">' +
                images.slice(0, 4).map(function(url) {
                  return '<img src="' + escapeHtml(url) + '" alt="Foto" onclick="openProfileImage(\'' + escapeHtml(url) + '\')">';
                }).join('') +
              '</div>';
            }

            const postContent = post.content ? escapeHtml(post.content) : '';
            const postTime = post.createdAt ? timeAgo(post.createdAt) : '';
            const postLikes = post.likes || 0;

            return '<div class="user-profile-post-card">' +
              (postContent ? '<div class="user-profile-post-content">' + postContent + '</div>' : '') +
              imagesHtml +
              '<div class="user-profile-post-meta">' +
                '<span><i class="fas fa-clock"></i>' + postTime + '</span>' +
                '<span><i class="fas fa-heart"></i>' + postLikes + '</span>' +
              '</div>' +
            '</div>';
          }).join('');

          postsHtml = '<div class="user-profile-posts-section">' +
            '<div class="user-profile-posts-header">' +
              '<div class="user-profile-posts-title"><i class="fas fa-newspaper"></i>PublicaÃ§Ãµes</div>' +
            '</div>' +
            '<div class="user-profile-posts-container">' + postsListHtml + '</div>' +
          '</div>';
        } else {
          postsHtml = '<div class="user-profile-posts-section">' +
            '<div class="user-profile-posts-header">' +
              '<div class="user-profile-posts-title"><i class="fas fa-newspaper"></i>PublicaÃ§Ãµes</div>' +
            '</div>' +
            '<div class="user-profile-posts-empty">' +
              '<i class="fas fa-file-alt"></i>' +
              '<span>Nenhuma publicaÃ§Ã£o ainda</span>' +
            '</div>' +
          '</div>';
        }

        content.innerHTML =
          '<div class="user-profile-avatar" ' + avatarClickAttr + '>' + avatarContent + '</div>' +
          '<h2 class="user-profile-name">' + escapeHtml(userData.name || 'UsuÃ¡rio') + '</h2>' +
          '<p class="user-profile-username">@' + escapeHtml(userData.username || userData.email?.split('@')[0] || 'usuario') + '</p>' +
          '<p class="user-profile-email">' + escapeHtml(userData.email || '') + '</p>' +
          birthdateHtml +
          '<div class="user-profile-status ' + statusClass + '">' +
            '<span class="user-profile-status-dot"></span>' +
            '<span>' + statusText + '</span>' +
          '</div>' +
          '<div class="user-profile-stats">' +
            '<div class="user-profile-stat">' +
              '<div class="user-profile-stat-value">' + postsCount + '</div>' +
              '<div class="user-profile-stat-label">Postagens</div>' +
            '</div>' +
            '<div class="user-profile-stat">' +
              '<div class="user-profile-stat-value">' + likesCount + '</div>' +
              '<div class="user-profile-stat-label">Curtidas</div>' +
            '</div>' +
            '<div class="user-profile-stat clickable" onclick="openProfileAbsencesModal(\'' + userId + '\')">' +
              '<div class="user-profile-stat-value">' + absencesCount + '</div>' +
              '<div class="user-profile-stat-label">Faltas</div>' +
            '</div>' +
          '</div>' +
          postsHtml;

      } catch (error) {
        console.error('Error fetching user profile:', JSON.stringify(error));
        content.innerHTML = '<div class="user-profile-loading"><i class="fas fa-exclamation-triangle"></i><span>Erro ao carregar perfil</span></div>';
      }
    }

    // Close user profile modal
    function closeUserProfileModal() {
      document.getElementById('userProfileModal').classList.remove('active');
    }

    // Close modal when clicking outside
    document.getElementById('userProfileModal').addEventListener('click', (e) => {
      if (e.target.id === 'userProfileModal') {
        closeUserProfileModal();
      }
    });

    // Send message to Realtime Database
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const btn = document.getElementById('chatSendBtn');
      const text = input.value.trim();

      if (!text && !chatImageFile) return;

      if (!currentUser || !currentUserData) {
        showToast('FaÃ§a login para enviar mensagens', 'error');
        return;
      }

      btn.disabled = true;

      try {
        let imageURL = null;
        if (chatImageFile) {
          showToast('Enviando imagem...');
          imageURL = await uploadToImgBB(chatImageFile);
          if (!imageURL) {
            showToast('Erro ao enviar imagem', 'error');
            btn.disabled = false;
            return;
          }
        }

        const newMessageRef = rtdb.ref('messages').push();
        await newMessageRef.set({
          text: text,
          imageURL: imageURL,
          senderId: currentUser.uid,
          senderName: currentUserData.name || 'UsuÃ¡rio',
          senderPhotoURL: currentUserData.photoURL || null,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        input.value = '';
        input.style.height = 'auto'; // Reset textarea height
        removeChatImage(); // Clear image preview
      } catch (error) {
        console.error('Error sending message:', JSON.stringify(error));
        showToast('Erro ao enviar mensagem', 'error');
      }

      btn.disabled = false;
    }

    // Delete message from Realtime Database
    let messageToDelete = null;

    function confirmDeleteMessage(messageId) {
      messageToDelete = messageId;
      document.getElementById('deleteMessageModalOverlay').classList.add('active');
    }

    function closeDeleteMessageModal() {
      messageToDelete = null;
      document.getElementById('deleteMessageModalOverlay').classList.remove('active');
    }

    document.getElementById('deleteMessageConfirmBtn').addEventListener('click', async () => {
      if (!messageToDelete) return;

      try {
        await rtdb.ref('messages/' + messageToDelete).remove();
        showToast('Mensagem excluÃ­da');
        closeDeleteMessageModal();
      } catch (error) {
        console.error('Error deleting message:', JSON.stringify(error));
        showToast('Erro ao excluir mensagem', 'error');
      }
    });

    // Render posts from Firestore
    function renderPostsFromFirestore(posts) {
      const container = document.getElementById('postsContainer');

      if (posts.length === 0) {
        // Check if this is a search with no results
        if (currentSearchQuery && currentSearchQuery.trim() !== '') {
          container.innerHTML = '<div class="posts-no-results">' +
            '<i class="fas fa-search"></i>' +
            '<p>Nenhuma postagem encontrada para<br>"<span class="search-term">' + escapeHtml(currentSearchQuery) + '</span>"</p>' +
          '</div>';
        } else if (currentPostsFilter === 'images') {
          container.innerHTML = '<div class="posts-empty"><i class="fas fa-images"></i><p>Nenhuma postagem com fotos ainda.<br>Compartilhe uma foto!</p></div>';
        } else {
          container.innerHTML = '<div class="posts-empty"><i class="fas fa-newspaper"></i><p>Nenhuma postagem ainda.<br>Seja o primeiro a compartilhar!</p></div>';
        }
        return;
      }

      container.innerHTML = posts.map(post => {
        const isAuthor = currentUser && post.authorId === currentUser.uid;
        const avatarContent = post.authorPhotoURL
          ? '<img src="' + post.authorPhotoURL + '" alt="">'
          : getInitials(post.authorName);

        const avatarClickAttr = post.authorPhotoURL
          ? 'onclick="openProfileImage(\'' + escapeHtml(post.authorPhotoURL) + '\')" style="cursor:pointer"'
          : '';

        const imageHtml = buildPostImagesHtml(post);
        const deleteBtn = isAuthor
          ? '<button class="post-menu-btn" onclick="confirmDeletePost(\'' + post.id + '\')"><i class="fas fa-trash-alt"></i></button>'
          : '';

        // Build comments section HTML
        const commentsHtml = buildCommentsSection(post.id);

        // Highlight search matches in content and author name
        const highlightedContent = highlightSearchMatches(post.content);
        const highlightedAuthorName = highlightSearchMatches(post.authorName || 'UsuÃ¡rio');

        return '<div class="post-card" data-post-id="' + post.id + '">' +
          '<div class="post-header">' +
            '<div class="post-avatar" ' + avatarClickAttr + '>' + avatarContent + '</div>' +
            '<div class="post-author">' +
              '<div class="post-author-name" onclick="showUserProfile(\'' + escapeHtml(post.authorId) + '\')" style="cursor:pointer">' + highlightedAuthorName + '</div>' +
              '<div class="post-time">' + timeAgo(post.createdAt) + '</div>' +
            '</div>' +
            deleteBtn +
          '</div>' +
          '<div class="post-content">' + highlightedContent + '</div>' +
          imageHtml +
          '<div class="post-actions">' +
            '<button class="post-action ' + (post.likedBy && post.likedBy.includes(currentUser?.uid) ? 'liked' : '') + '" onclick="toggleLike(\'' + post.id + '\')">' +
              '<i class="fas fa-heart"></i>' +
              '<span>' + (post.likes || 0) + '</span>' +
            '</button>' +
            '<button class="post-action" onclick="toggleCommentsSection(\'' + post.id + '\')">' +
              '<i class="fas fa-comment"></i>' +
              '<span id="commentsCount-' + post.id + '">' + getCommentsCount(post.id) + '</span>' +
            '</button>' +
            '<button class="post-action" onclick="sharePost(\'' + post.id + '\')">' +
              '<i class="fas fa-share"></i>' +
              '<span>Compartilhar</span>' +
            '</button>' +
          '</div>' +
          commentsHtml +
        '</div>';
      }).join('');
    }

    // Build post images HTML with grid support
    function buildPostImagesHtml(post) {
      let images = [];

      if (post.imageURLs && Array.isArray(post.imageURLs) && post.imageURLs.length > 0) {
        images = post.imageURLs;
      } else if (post.imageURL) {
        images = [post.imageURL];
      }

      if (images.length === 0) return '';

      const postId = post.id;
      const totalImages = images.length;

      if (totalImages === 1) {
        return '<div class="post-images-grid grid-1">' +
          '<div class="post-grid-item" onclick="openPostImages(\'' + postId + '\', 0)">' +
            '<img src="' + images[0] + '" alt="Foto">' +
          '</div>' +
        '</div>';
      }

      if (totalImages === 2) {
        return '<div class="post-images-grid grid-2">' +
          images.map(function(url, idx) {
            return '<div class="post-grid-item" onclick="openPostImages(\'' + postId + '\', ' + idx + ')">' +
              '<img src="' + url + '" alt="Foto">' +
            '</div>';
          }).join('') +
        '</div>';
      }

      if (totalImages === 3) {
        return '<div class="post-images-grid grid-3">' +
          images.map(function(url, idx) {
            return '<div class="post-grid-item" onclick="openPostImages(\'' + postId + '\', ' + idx + ')">' +
              '<img src="' + url + '" alt="Foto">' +
            '</div>';
          }).join('') +
        '</div>';
      }

      const visibleImages = images.slice(0, 4);
      const remaining = totalImages - 4;

      return '<div class="post-images-grid grid-more">' +
        visibleImages.map(function(url, idx) {
          const isLast = idx === 3 && remaining > 0;
          return '<div class="post-grid-item" onclick="openPostImages(\'' + postId + '\', ' + idx + ')">' +
            '<img src="' + url + '" alt="Foto">' +
            (isLast ? '<div class="post-grid-overlay">+' + remaining + '</div>' : '') +
          '</div>';
        }).join('') +
      '</div>';
    }

    // Store post images for viewer
    let currentPostImages = [];
    let currentPostImageIndex = 0;

    function openPostImages(postId, startIndex) {
      const postCard = document.querySelector('[data-post-id="' + postId + '"]');
      if (!postCard) return;

      const post = postsCache.find(function(p) { return p.id === postId; });
      if (!post) return;

      let images = [];
      if (post.imageURLs && Array.isArray(post.imageURLs) && post.imageURLs.length > 0) {
        images = post.imageURLs;
      } else if (post.imageURL) {
        images = [post.imageURL];
      }

      if (images.length === 0) return;

      currentPostImages = images;
      currentPostImageIndex = startIndex || 0;

      const viewer = document.getElementById('imageViewer');
      const slidesContainer = document.getElementById('viewerSlides');
      const navContainer = document.getElementById('viewerNav');

      // Reset state before opening
      currentTranslate = 0;
      prevTranslate = 0;

      slidesContainer.style.transition = 'none';
      slidesContainer.innerHTML = images.map(function(url) {
        return '<div class="viewer-slide">' +
          '<img class="viewer-image" src="' + url + '" alt="Foto">' +
        '</div>';
      }).join('');

      navContainer.innerHTML = images.map(function(url, idx) {
        return '<div class="viewer-dot ' + (idx === currentPostImageIndex ? 'active' : '') + '"></div>';
      }).join('');

      document.getElementById('viewerCounter').textContent = (currentPostImageIndex + 1) + ' / ' + images.length;
      document.getElementById('prevBtn').style.display = images.length > 1 ? 'block' : 'none';
      document.getElementById('nextBtn').style.display = images.length > 1 ? 'block' : 'none';

      const slideWidth = window.innerWidth;
      slidesContainer.style.transform = 'translateX(-' + (currentPostImageIndex * slideWidth) + 'px)';
      prevTranslate = -(currentPostImageIndex * slideWidth);
      currentTranslate = prevTranslate;

      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';

      galleryPhotos = images.map(function(url) { return { url: url }; });
      currentImageIndex = currentPostImageIndex;
    }

    let postsCache = [];
    let currentPostsFilter = 'all'; // 'all' or 'images'
    let currentSearchQuery = ''; // Current search query
    let searchDebounceTimer = null; // Debounce timer for search

    // Set posts filter
    function setPostsFilter(filter) {
      currentPostsFilter = filter;

      // Update button states
      document.getElementById('filterAll').classList.toggle('active', filter === 'all');
      document.getElementById('filterImages').classList.toggle('active', filter === 'images');

      // Re-render posts with filter
      applyPostsFilter();
    }

    // Apply posts filter
    function applyPostsFilter() {
      if (postsCache.length === 0) return;

      const postsContainer = document.getElementById('postsContainer');
      const galleryContainer = document.getElementById('postsGalleryContainer');

      // Apply search filter first
      const filteredPosts = getFilteredPosts();

      if (currentPostsFilter === 'images') {
        // Show gallery view, hide posts view
        postsContainer.style.display = 'none';
        galleryContainer.style.display = 'block';
        renderPostsGallery(filteredPosts);
      } else {
        // Show posts view, hide gallery view
        postsContainer.style.display = 'block';
        galleryContainer.style.display = 'none';
        renderPostsFromFirestore(filteredPosts);
      }

      // Update search results info
      updateSearchResultsInfo(filteredPosts.length);
    }

    // Get filtered posts based on search query
    function getFilteredPosts() {
      if (!currentSearchQuery || currentSearchQuery.trim() === '') {
        return postsCache;
      }

      const query = currentSearchQuery.toLowerCase().trim();
      const queryWords = query.split(/\s+/).filter(function(word) { return word.length > 0; });

      return postsCache.filter(function(post) {
        const content = (post.content || '').toLowerCase();
        const authorName = (post.authorName || '').toLowerCase();

        // Match if all query words are found in content or author name
        return queryWords.every(function(word) {
          return content.includes(word) || authorName.includes(word);
        });
      });
    }

    // Handle posts search input
    function handlePostsSearch(value) {
      // Update clear button visibility
      const clearBtn = document.getElementById('postsSearchClear');
      if (clearBtn) {
        clearBtn.classList.toggle('visible', value.length > 0);
      }

      // Debounce search for performance
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(function() {
        currentSearchQuery = value;
        applyPostsFilter();
      }, 250);
    }

    // Clear posts search
    function clearPostsSearch() {
      const input = document.getElementById('postsSearchInput');
      const clearBtn = document.getElementById('postsSearchClear');
      const resultsEl = document.getElementById('postsSearchResults');

      if (input) input.value = '';
      if (clearBtn) clearBtn.classList.remove('visible');
      if (resultsEl) resultsEl.style.display = 'none';

      currentSearchQuery = '';
      applyPostsFilter();
    }

    // Update search results info
    function updateSearchResultsInfo(resultCount) {
      const resultsEl = document.getElementById('postsSearchResults');
      if (!resultsEl) return;

      if (!currentSearchQuery || currentSearchQuery.trim() === '') {
        resultsEl.style.display = 'none';
        return;
      }

      const totalPosts = postsCache.length;
      const escapedQuery = escapeHtml(currentSearchQuery);

      resultsEl.innerHTML = '<span><i class="fas fa-filter"></i> ' +
        resultCount + ' de ' + totalPosts + ' postagen' + (totalPosts !== 1 ? 's' : '') +
        ' para "<span class="highlight-term">' + escapedQuery + '</span>"</span>';
      resultsEl.style.display = 'flex';
    }

    // Highlight search matches in text
    function highlightSearchMatches(text) {
      if (!currentSearchQuery || currentSearchQuery.trim() === '' || !text) {
        return escapeHtml(text);
      }

      const escapedText = escapeHtml(text);
      const queryWords = currentSearchQuery.toLowerCase().trim().split(/\s+/).filter(function(word) { return word.length > 0; });

      let result = escapedText;
      queryWords.forEach(function(word) {
        if (word.length < 2) return; // Skip very short words
        const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Use negative lookbehind/lookahead to avoid matching inside HTML entities like &amp; &lt; &gt; etc
        // Match the word only if NOT preceded by & or followed by ; (part of HTML entity)
        const regex = new RegExp('(?<!&[a-z]*)(' + escapedWord + ')(?![a-z]*;)', 'gi');
        result = result.replace(regex, '<span class="search-highlight">$1</span>');
      });

      return result;
    }

    // Collect all images from posts for gallery view
    let postsGalleryImages = [];

    function collectAllPostsImages(filteredPosts) {
      postsGalleryImages = [];
      const postsToProcess = filteredPosts || postsCache;

      postsToProcess.forEach(function(post) {
        let images = [];
        if (post.imageURLs && Array.isArray(post.imageURLs) && post.imageURLs.length > 0) {
          images = post.imageURLs;
        } else if (post.imageURL) {
          images = [post.imageURL];
        }

        images.forEach(function(url) {
          postsGalleryImages.push({
            url: url,
            postId: post.id,
            authorName: post.authorName,
            createdAt: post.createdAt
          });
        });
      });

      return postsGalleryImages;
    }

    // Render posts gallery (grid view of all images)
    function renderPostsGallery(filteredPosts) {
      const grid = document.getElementById('postsGalleryGrid');
      const countEl = document.getElementById('postsGalleryCount');

      collectAllPostsImages(filteredPosts);

      if (postsGalleryImages.length === 0) {
        if (currentSearchQuery && currentSearchQuery.trim() !== '') {
          countEl.innerHTML = '<i class="fas fa-images"></i><span>Nenhuma foto encontrada</span>';
          grid.innerHTML = '<div class="posts-no-results" style="grid-column: 1 / -1;">' +
            '<i class="fas fa-search"></i>' +
            '<p>Nenhuma foto encontrada para<br>"<span class="search-term">' + escapeHtml(currentSearchQuery) + '</span>"</p>' +
          '</div>';
        } else {
          countEl.innerHTML = '<i class="fas fa-images"></i><span>Nenhuma foto nas postagens</span>';
          grid.innerHTML = '<div class="posts-empty" style="grid-column: 1 / -1;"><i class="fas fa-images"></i><p>Nenhuma postagem com fotos ainda.<br>Compartilhe uma foto!</p></div>';
        }
        return;
      }

      countEl.innerHTML = '<i class="fas fa-images"></i><span>' + postsGalleryImages.length + ' foto' + (postsGalleryImages.length !== 1 ? 's' : '') + ' nas postagens</span>';

      grid.innerHTML = postsGalleryImages.map(function(photo, index) {
        return '<div class="posts-gallery-item" onclick="openPostsGalleryViewer(' + index + ')">' +
          '<img src="' + photo.url + '" alt="Foto" onerror="this.parentElement.style.display=\'none\'">' +
        '</div>';
      }).join('');
    }

    // Open viewer for posts gallery
    function openPostsGalleryViewer(startIndex) {
      if (postsGalleryImages.length === 0) return;

      const viewer = document.getElementById('imageViewer');
      const slidesContainer = document.getElementById('viewerSlides');
      const navContainer = document.getElementById('viewerNav');

      currentImageIndex = startIndex;

      // Reset state before opening
      currentTranslate = 0;
      prevTranslate = 0;

      slidesContainer.style.transition = 'none';
      slidesContainer.innerHTML = postsGalleryImages.map(function(photo) {
        return '<div class="viewer-slide">' +
          '<img class="viewer-image" src="' + photo.url + '" alt="Foto">' +
        '</div>';
      }).join('');

      navContainer.innerHTML = postsGalleryImages.map(function(photo, idx) {
        return '<div class="viewer-dot ' + (idx === startIndex ? 'active' : '') + '"></div>';
      }).join('');

      document.getElementById('viewerCounter').textContent = (startIndex + 1) + ' / ' + postsGalleryImages.length;
      document.getElementById('prevBtn').style.display = postsGalleryImages.length > 1 ? 'block' : 'none';
      document.getElementById('nextBtn').style.display = postsGalleryImages.length > 1 ? 'block' : 'none';
      document.getElementById('prevBtn').disabled = startIndex === 0;
      document.getElementById('nextBtn').disabled = startIndex === postsGalleryImages.length - 1;

      const slideWidth = window.innerWidth;
      slidesContainer.style.transform = 'translateX(-' + (startIndex * slideWidth) + 'px)';
      prevTranslate = -(startIndex * slideWidth);
      currentTranslate = prevTranslate;

      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Update galleryPhotos for viewer navigation
      galleryPhotos = postsGalleryImages.map(function(photo) { return { url: photo.url }; });
    }

    // Render transactions from Firestore
    function renderTransactionsFromFirestore(transactions) {
      const container = document.getElementById('vaultHistory');

      if (transactions.length === 0) {
        container.innerHTML = '<div class="vault-empty"><i class="fas fa-receipt"></i><p>Nenhuma movimentaÃ§Ã£o ainda.</p></div>';
        return;
      }

      container.innerHTML = transactions.map(t => {
        const userName = t.userName || 'UsuÃ¡rio';
        const dateStr = formatTransactionDate(t.createdAt);

        return '<div class="vault-item">' +
          '<div class="vault-item-icon ' + t.type + '">' +
            '<i class="fas ' + (t.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up') + '"></i>' +
          '</div>' +
          '<div class="vault-item-info">' +
            '<div class="vault-item-title">' + escapeHtml(t.description || (t.type === 'income' ? 'DepÃ³sito' : 'Retirada')) + '</div>' +
            '<div class="vault-item-user"><i class="fas fa-user"></i> ' + escapeHtml(userName) + '</div>' +
            '<div class="vault-item-date">' + dateStr + '</div>' +
          '</div>' +
          '<div class="vault-item-amount ' + t.type + '">' +
            (t.type === 'income' ? '+' : '-') + ' ' + formatKwanza(t.amount) + ' Kz' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Create new post
    async function createPost() {
      const input = document.getElementById('newPostInput');
      const content = input.value.trim();
      const btn = document.getElementById('publishBtn');
      const spinner = btn.querySelector('.spinner-small');
      const btnText = btn.querySelector('.btn-text');

      if (!content && postImageFiles.length === 0) {
        showToast('Escreva algo para publicar', 'error');
        return;
      }

      if (!currentUser || !currentUserData) {
        showToast('FaÃ§a login para publicar', 'error');
        return;
      }

      btn.disabled = true;
      btnText.style.display = 'none';
      spinner.style.display = 'block';

      try {
        let imageURLs = [];

        if (postImageFiles.length > 0) {
          showToast('Enviando ' + postImageFiles.length + ' foto(s)...');
          for (let i = 0; i < postImageFiles.length; i++) {
            const url = await uploadToImgBB(postImageFiles[i]);
            if (url) {
              imageURLs.push(url);
            }
          }
        }

        await db.collection('posts').add({
          content: content,
          imageURL: imageURLs.length === 1 ? imageURLs[0] : null,
          imageURLs: imageURLs.length > 0 ? imageURLs : null,
          authorId: currentUser.uid,
          authorName: currentUserData.name || 'UsuÃ¡rio',
          authorPhotoURL: currentUserData.photoURL || null,
          likes: 0,
          likedBy: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        input.value = '';
        removeAllPostImages();
        hideNewPostCard();
        showToast('Postagem publicada!');
      } catch (error) {
        console.error('Error creating post:', JSON.stringify(error));
        showToast('Erro ao publicar', 'error');
      }

      btn.disabled = false;
      btnText.style.display = 'inline';
      spinner.style.display = 'none';
    }

    // Toggle like on post
    async function toggleLike(postId) {
      if (!currentUser) {
        showToast('FaÃ§a login para curtir', 'error');
        return;
      }

      const postRef = db.collection('posts').doc(postId);

      try {
        const doc = await postRef.get();
        if (!doc.exists) return;

        const post = doc.data();
        const likedBy = post.likedBy || [];
        const userIndex = likedBy.indexOf(currentUser.uid);

        if (userIndex > -1) {
          // Unlike
          likedBy.splice(userIndex, 1);
          await postRef.update({
            likes: firebase.firestore.FieldValue.increment(-1),
            likedBy: likedBy
          });
        } else {
          // Like
          likedBy.push(currentUser.uid);
          await postRef.update({
            likes: firebase.firestore.FieldValue.increment(1),
            likedBy: likedBy
          });
        }
      } catch (error) {
        console.error('Error toggling like:', JSON.stringify(error));
      }
    }

    // Share post (copy content)
    async function sharePost(postId) {
      try {
        const doc = await db.collection('posts').doc(postId).get();
        if (!doc.exists) return;

        const post = doc.data();
        const textToCopy = post.content || '';

        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(textToCopy);
          showToast('Texto copiado!');
        } else {
          // Fallback
          const textArea = document.createElement('textarea');
          textArea.value = textToCopy;
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showToast('Texto copiado!');
        }
      } catch (error) {
        console.error('Error sharing post:', JSON.stringify(error));
        showToast('Erro ao copiar', 'error');
      }
    }

    // ==================== COMMENTS SYSTEM (FIRESTORE INTEGRATED) ====================

    // In-memory comments cache (loaded from Firestore)
    let commentsData = {};
    let commentsLoaded = {}; // Track which posts have loaded comments
    let commentToDelete = null;
    let commentPostIdToDelete = null;

    // Get comments count for a post (from cache or placeholder)
    function getCommentsCount(postId) {
      if (!commentsData[postId] || commentsData[postId].length === 0) {
        return 'Comentar';
      }
      return commentsData[postId].length;
    }

    // Build comments section HTML
    function buildCommentsSection(postId) {
      const userAvatarContent = currentUser && currentUserData && currentUserData.photoURL
        ? '<img src="' + currentUserData.photoURL + '" alt="">'
        : getInitials(currentUserData?.name || 'EU');

      return '<div class="comments-section" id="commentsSection-' + postId + '" style="display: none;">' +
        '<div class="comments-list show" id="commentsList-' + postId + '">' +
          '<div class="comments-empty"><i class="fas fa-spinner fa-spin"></i><br>Carregando comentÃ¡rios...</div>' +
        '</div>' +
        '<div class="comment-input-container">' +
          '<div class="comment-input-avatar">' + userAvatarContent + '</div>' +
          '<div class="comment-input-wrapper">' +
            '<textarea class="comment-input" id="commentInput-' + postId + '" placeholder="Escreva um comentÃ¡rio..." rows="1" oninput="autoResizeCommentInput(this)"></textarea>' +
            '<button class="comment-send-btn" onclick="addComment(\'' + postId + '\')">' +
              '<i class="fas fa-paper-plane"></i>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Load comments from Firestore for a specific post
    async function loadCommentsFromFirestore(postId) {
      try {
        const snapshot = await db.collection('posts').doc(postId)
          .collection('comments')
          .orderBy('createdAt', 'asc')
          .get();

        const comments = [];
        snapshot.forEach(doc => {
          comments.push({ id: doc.id, ...doc.data() });
        });

        commentsData[postId] = comments;
        commentsLoaded[postId] = true;

        return comments;
      } catch (error) {
        console.error('Error loading comments:', JSON.stringify(error));
        commentsData[postId] = [];
        commentsLoaded[postId] = true;
        return [];
      }
    }

    // Render comments HTML
    function renderCommentsHtml(postId) {
      const comments = commentsData[postId] || [];

      if (comments.length === 0) {
        return '<div class="comments-empty">' +
          '<i class="fas fa-comments"></i>' +
          'Nenhum comentÃ¡rio ainda.<br>Seja o primeiro a comentar!' +
        '</div>';
      }

      return comments.map(function(comment) {
        const isAuthor = currentUser && comment.authorId === currentUser.uid;
        const avatarContent = comment.authorPhotoURL
          ? '<img src="' + comment.authorPhotoURL + '" alt="">'
          : getInitials(comment.authorName);
        const deleteBtn = isAuthor
          ? '<button class="comment-delete" onclick="confirmDeleteComment(\'' + postId + '\', \'' + comment.id + '\')">' +
              '<i class="fas fa-trash-alt"></i>' +
            '</button>'
          : '';

        return '<div class="comment-item" data-comment-id="' + comment.id + '">' +
          '<div class="comment-avatar">' + avatarContent + '</div>' +
          '<div class="comment-content">' +
            '<div class="comment-header">' +
              '<span class="comment-author">' + escapeHtml(comment.authorName) + '</span>' +
              '<span class="comment-time">' + commentTimeAgo(comment.createdAt) + '</span>' +
            '</div>' +
            '<div class="comment-text">' + escapeHtml(comment.text) + '</div>' +
          '</div>' +
          deleteBtn +
        '</div>';
      }).join('');
    }

    // Time ago for comments (handles Firestore timestamps)
    function commentTimeAgo(timestamp) {
      if (!timestamp) return 'Agora';

      const now = new Date();
      // Handle Firestore timestamp objects
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHours = Math.floor(diffMin / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffSec < 60) return 'Agora';
      if (diffMin < 60) return diffMin + ' min';
      if (diffHours < 24) return diffHours + 'h';
      if (diffDays < 7) return diffDays + 'd';

      return date.toLocaleDateString('pt-BR');
    }

    // Toggle comments section visibility
    async function toggleCommentsSection(postId) {
      const section = document.getElementById('commentsSection-' + postId);
      if (!section) return;

      const isVisible = section.style.display !== 'none';
      section.style.display = isVisible ? 'none' : 'block';

      // Load comments from Firestore when opening (if not already loaded)
      if (!isVisible) {
        if (!commentsLoaded[postId]) {
          await loadCommentsFromFirestore(postId);
          updateCommentsUI(postId);
        }

        // Focus on input when opening
        const input = document.getElementById('commentInput-' + postId);
        if (input) {
          setTimeout(function() { input.focus(); }, 100);
        }
      }
    }

    // Auto resize comment input
    function autoResizeCommentInput(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    // Add a new comment (saves to Firestore)
    async function addComment(postId) {
      const input = document.getElementById('commentInput-' + postId);
      if (!input) return;

      const text = input.value.trim();
      if (!text) return;

      if (!currentUser) {
        showToast('FaÃ§a login para comentar', 'error');
        return;
      }

      // Disable button while saving
      const btn = input.parentElement.querySelector('.comment-send-btn');
      if (btn) btn.disabled = true;

      try {
        // Save comment to Firestore (as subcollection of the post)
        const commentRef = await db.collection('posts').doc(postId)
          .collection('comments')
          .add({
            postId: postId,
            authorId: currentUser.uid,
            authorName: currentUserData?.name || 'UsuÃ¡rio',
            authorPhotoURL: currentUserData?.photoURL || null,
            text: text,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        // Create local comment object for immediate UI update
        const comment = {
          id: commentRef.id,
          postId: postId,
          authorId: currentUser.uid,
          authorName: currentUserData?.name || 'UsuÃ¡rio',
          authorPhotoURL: currentUserData?.photoURL || null,
          text: text,
          createdAt: new Date() // Use local date for immediate display
        };

        // Add to local cache
        if (!commentsData[postId]) {
          commentsData[postId] = [];
        }
        commentsData[postId].push(comment);

        // Clear input
        input.value = '';
        input.style.height = 'auto';

        // Update UI
        updateCommentsUI(postId);
        showToast('ComentÃ¡rio adicionado');

      } catch (error) {
        console.error('Error adding comment:', JSON.stringify(error));
        showToast('Erro ao adicionar comentÃ¡rio', 'error');
      }

      // Re-enable button
      if (btn) btn.disabled = false;
    }

    // Update comments UI for a specific post
    function updateCommentsUI(postId) {
      // Update comments list
      const commentsList = document.getElementById('commentsList-' + postId);
      if (commentsList) {
        commentsList.innerHTML = renderCommentsHtml(postId);
      }

      // Update comments count
      const countEl = document.getElementById('commentsCount-' + postId);
      if (countEl) {
        countEl.textContent = getCommentsCount(postId);
      }
    }

    // Confirm delete comment
    function confirmDeleteComment(postId, commentId) {
      commentToDelete = commentId;
      commentPostIdToDelete = postId;
      document.getElementById('deleteCommentModalOverlay').classList.add('active');
    }

    // Close delete comment modal
    function closeDeleteCommentModal() {
      commentToDelete = null;
      commentPostIdToDelete = null;
      document.getElementById('deleteCommentModalOverlay').classList.remove('active');
    }

    // Delete comment confirm button listener
    document.getElementById('deleteCommentConfirmBtn').addEventListener('click', async function() {
      if (!commentToDelete || !commentPostIdToDelete) return;

      const postId = commentPostIdToDelete;
      const commentId = commentToDelete;

      try {
        // Delete from Firestore
        await db.collection('posts').doc(postId)
          .collection('comments')
          .doc(commentId)
          .delete();

        // Remove from local cache
        if (commentsData[postId]) {
          commentsData[postId] = commentsData[postId].filter(function(c) {
            return c.id !== commentId;
          });
        }

        // Update UI
        updateCommentsUI(postId);
        showToast('ComentÃ¡rio excluÃ­do');
      } catch (error) {
        console.error('Error deleting comment:', JSON.stringify(error));
        showToast('Erro ao excluir comentÃ¡rio', 'error');
      }

      closeDeleteCommentModal();
    });

    // Allow sending comment with Enter key (Shift+Enter for new line)
    document.addEventListener('keydown', function(e) {
      if (e.target.classList.contains('comment-input') && e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const postId = e.target.id.replace('commentInput-', '');
        addComment(postId);
      }
    });

    // ==================== END COMMENTS SYSTEM ====================

    // Delete post
    let postToDelete = null;

    function confirmDeletePost(postId) {
      postToDelete = postId;
      document.getElementById('deleteModalOverlay').classList.add('active');
    }

    function closeDeleteModal() {
      postToDelete = null;
      document.getElementById('deleteModalOverlay').classList.remove('active');
    }

    document.getElementById('deleteConfirmBtn').addEventListener('click', async () => {
      if (!postToDelete) return;

      try {
        await db.collection('posts').doc(postToDelete).delete();
        showToast('Postagem excluÃ­da');
        closeDeleteModal();
      } catch (error) {
        console.error('Error deleting post:', JSON.stringify(error));
        showToast('Erro ao excluir', 'error');
      }
    });

    // Update profile stats
    async function updateProfileStats() {
      if (!currentUser) return;

      try {
        // Count user's posts
        const postsSnapshot = await db.collection('posts')
          .where('authorId', '==', currentUser.uid)
          .get();

        document.getElementById('profilePostsCount').textContent = postsSnapshot.size;

        // Count total likes on user's posts
        let totalLikes = 0;
        postsSnapshot.forEach(doc => {
          totalLikes += doc.data().likes || 0;
        });
        document.getElementById('profileLikesCount').textContent = totalLikes;

        // Count user's absences
        const absencesSnapshot = await db.collection('absences')
          .where('userId', '==', currentUser.uid)
          .get();
        document.getElementById('profileAbsences').textContent = absencesSnapshot.size;
      } catch (error) {
        console.error('Error updating profile stats:', JSON.stringify(error));
      }
    }

    // Load my profile posts
    async function loadMyProfilePosts() {
      if (!currentUser) return;

      const container = document.getElementById('myProfilePostsContainer');
      if (!container) return;

      container.innerHTML = '<div class="my-profile-posts-loading"><i class="fas fa-spinner"></i><p>Carregando publicaÃ§Ãµes...</p></div>';

      try {
        const postsSnapshot = await db.collection('posts')
          .where('authorId', '==', currentUser.uid)
          .get();

        if (postsSnapshot.empty) {
          container.innerHTML = '<div class="my-profile-posts-empty"><i class="fas fa-file-alt"></i><p>Nenhuma publicaÃ§Ã£o ainda</p><small>Suas publicaÃ§Ãµes aparecerÃ£o aqui</small></div>';
          return;
        }

        // Collect posts and sort on client side (avoids needing composite index)
        let postsArray = [];
        postsSnapshot.forEach(doc => {
          postsArray.push({ id: doc.id, ...doc.data() });
        });

        // Sort by createdAt desc
        postsArray.sort((a, b) => {
          const timeA = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt || 0);
          const timeB = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt || 0);
          return timeB - timeA;
        });

        // Limit to 20 posts
        postsArray = postsArray.slice(0, 20);

        let postsHtml = '';
        postsArray.forEach(post => {
          const postId = post.id;

          // Handle images
          let images = [];
          if (post.imageURLs && Array.isArray(post.imageURLs) && post.imageURLs.length > 0) {
            images = post.imageURLs;
          } else if (post.imageURL) {
            images = [post.imageURL];
          }

          let imagesHtml = '';
          if (images.length > 0) {
            const gridClass = images.length === 1 ? 'grid-1' :
                              images.length === 2 ? 'grid-2' :
                              images.length === 3 ? 'grid-3' : 'grid-more';

            const displayImages = images.slice(0, 4);
            const remaining = images.length - 4;

            imagesHtml = '<div class="my-profile-post-images ' + gridClass + '">';
            displayImages.forEach((url, index) => {
              if (index === 3 && remaining > 0) {
                imagesHtml += '<div class="my-profile-post-img" onclick="openGallery(\'' + postId + '\', 3)"><img src="' + escapeHtml(url) + '" alt="Foto"><div class="my-profile-post-img-overlay">+' + remaining + '</div></div>';
              } else {
                imagesHtml += '<div class="my-profile-post-img" onclick="openGallery(\'' + postId + '\', ' + index + ')"><img src="' + escapeHtml(url) + '" alt="Foto"></div>';
              }
            });
            imagesHtml += '</div>';
          }

          const postContent = post.content ? escapeHtml(post.content) : '';
          const postTime = post.createdAt ? timeAgo(post.createdAt) : '';
          const postLikes = post.likes || 0;

          postsHtml += '<div class="my-profile-post-card">';
          if (postContent) {
            postsHtml += '<div class="my-profile-post-content">' + postContent + '</div>';
          }
          postsHtml += imagesHtml;
          postsHtml += '<div class="my-profile-post-meta">' +
            '<span><i class="fas fa-clock"></i>' + postTime + '</span>' +
            '<span><i class="fas fa-heart"></i>' + postLikes + '</span>' +
          '</div></div>';
        });

        container.innerHTML = postsHtml;
      } catch (error) {
        console.error('Error loading my profile posts:', JSON.stringify(error));
        container.innerHTML = '<div class="my-profile-posts-empty"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar</p><small>Tente novamente mais tarde</small></div>';
      }
    }

    // Sidebar functions
    function openSidebar() {
      document.getElementById('sidebar').classList.add('active');
      document.getElementById('sidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('sidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    function openProfilePage() {
      closeSidebar();
      showPage('profile');
      loadMyProfilePosts();
    }

    function openAbsencesPage() {
      closeSidebar();
      showPage('absences');
      loadAllUsersWithAbsences();
    }

    // ========================
    // Notifications Functions
    // ========================

    // VariÃ¡veis para armazenar notificaÃ§Ãµes recebidas
    let receivedNotifications = [];
    let currentNotificationFilter = 'all';
    let notificationsQueryRef = null;
    let notificationsListenerActive = false;

    function openNotificationsPage() {
      closeSidebar();
      showPage('notifications');
      // Carregar notificaÃ§Ãµes quando abrir a pÃ¡gina
      if (currentUser && !notificationsListenerActive) {
        setupNotificationsListener();
      }
    }

    // Configurar listener em tempo real do Firebase para notificaÃ§Ãµes recebidas
    function setupNotificationsListener() {
      if (!currentUser) return;

      // Cancelar listener anterior se existir
      if (notificationsQueryRef) {
        notificationsQueryRef.off();
        notificationsQueryRef = null;
      }
      notificationsListenerActive = false;

      // Mostrar estado de loading apenas se estiver na pÃ¡gina de notificaÃ§Ãµes
      const listContainer = document.getElementById('notificationsList');
      const emptyState = document.getElementById('notificationsEmpty');
      if (listContainer) {
        listContainer.innerHTML = '<div class="notifications-loading"><i class="fas fa-spinner"></i><span>Carregando notificaÃ§Ãµes...</span></div>';
      }
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      // Criar a query para notificaÃ§Ãµes do usuÃ¡rio
      notificationsQueryRef = rtdb.ref('notifications/users/' + currentUser.uid);

      // Registrar o listener na query
      notificationsQueryRef.on('value', (snapshot) => {
        notificationsListenerActive = true;
        receivedNotifications = [];

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const notif = child.val();
            // Garantir que createdAt Ã© um nÃºmero vÃ¡lido
            const createdAtValue = notif.createdAt;
            const createdAtTimestamp = typeof createdAtValue === 'number' ? createdAtValue : Date.now();

            receivedNotifications.push({
              id: child.key,
              title: notif.title || 'NotificaÃ§Ã£o',
              message: notif.message || '',
              type: notif.type || 'system',
              senderName: notif.senderName || 'Sistema',
              senderPhoto: notif.senderPhotoURL || notif.senderPhoto || null,
              senderId: notif.senderId || null,
              createdAt: createdAtTimestamp,
              read: notif.read === true
            });
          });

          // Ordenar por mais recente primeiro (usando timestamp numÃ©rico)
          receivedNotifications.sort((a, b) => b.createdAt - a.createdAt);

          // Limitar a 50 notificaÃ§Ãµes
          if (receivedNotifications.length > 50) {
            receivedNotifications = receivedNotifications.slice(0, 50);
          }
        }

        // Atualizar badge de notificaÃ§Ãµes
        const unreadCount = receivedNotifications.filter(n => !n.read).length;
        updateNotificationBadge(unreadCount);

        // Renderizar notificaÃ§Ãµes apenas se a lista existir
        renderReceivedNotifications();
      }, (error) => {
        console.error('Erro ao carregar notificaÃ§Ãµes:', JSON.stringify(error));
        notificationsListenerActive = false;
        const listContainerErr = document.getElementById('notificationsList');
        if (listContainerErr) {
          listContainerErr.innerHTML = '<div class="notifications-empty"><div class="notifications-empty-icon"><i class="fas fa-exclamation-triangle"></i></div><h3>Erro ao carregar</h3><p>NÃ£o foi possÃ­vel carregar as notificaÃ§Ãµes. Verifique as permissÃµes do Firebase.</p></div>';
        }
      });
    }

    // Renderizar notificaÃ§Ãµes recebidas
    function renderReceivedNotifications() {
      const listContainer = document.getElementById('notificationsList');
      const markAllBtn = document.getElementById('markAllReadBtn');

      // Se os elementos nÃ£o existem (pÃ¡gina nÃ£o estÃ¡ aberta), nÃ£o renderizar
      if (!listContainer) return;

      // HTML do empty state para reutilizar
      const emptyStateHTML = '<div class="notifications-empty" id="notificationsEmpty">' +
        '<div class="notifications-empty-icon"><i class="fas fa-bell-slash"></i></div>' +
        '<h3>Nenhuma notificaÃ§Ã£o</h3>' +
        '<p>VocÃª nÃ£o tem notificaÃ§Ãµes no momento.</p>' +
      '</div>';

      // Filtrar notificaÃ§Ãµes baseado no filtro atual
      let filteredNotifications = receivedNotifications;
      if (currentNotificationFilter === 'unread') {
        filteredNotifications = receivedNotifications.filter(n => !n.read);
      }

      // Verificar se hÃ¡ notificaÃ§Ãµes nÃ£o lidas para habilitar/desabilitar botÃ£o
      const hasUnread = receivedNotifications.some(n => !n.read);
      if (markAllBtn) {
        markAllBtn.disabled = !hasUnread;
      }

      if (filteredNotifications.length === 0) {
        listContainer.innerHTML = emptyStateHTML;
        const emptyState = document.getElementById('notificationsEmpty');
        if (emptyState) emptyState.style.display = 'flex';
        return;
      }

      const typeIcons = {
        system: 'fa-cog',
        info: 'fa-info-circle',
        success: 'fa-check-circle',
        warning: 'fa-exclamation-triangle',
        danger: 'fa-times-circle'
      };

      const typeClasses = {
        system: 'type-system',
        info: 'type-mention',
        success: 'type-mention',
        warning: 'type-like',
        danger: 'type-like'
      };

      listContainer.innerHTML = filteredNotifications.map(notif => {
        // Converter timestamp para Date para formatTimeAgo
        const notifDate = new Date(notif.createdAt);
        const timeAgo = formatTimeAgo(notifDate);
        const unreadClass = notif.read ? '' : 'unread';
        const initials = (notif.senderName || 'S').substring(0, 2).toUpperCase();
        const avatarContent = notif.senderPhoto
          ? '<img src="' + notif.senderPhoto + '" alt="Avatar">'
          : initials;

        return '<div class="notification-card ' + unreadClass + '" onclick="markNotificationAsRead(\'' + notif.id + '\')">' +
          '<div class="notification-avatar ' + (typeClasses[notif.type] || 'type-system') + '">' +
            avatarContent +
            '<div class="notification-type-icon ' + notif.type + '">' +
              '<i class="fas ' + (typeIcons[notif.type] || 'fa-bell') + '"></i>' +
            '</div>' +
          '</div>' +
          '<div class="notification-content">' +
            '<div class="notification-text">' +
              '<strong>' + notif.title + '</strong>' +
            '</div>' +
            '<div class="notification-preview">' + notif.message + '</div>' +
            '<div class="notification-time">' +
              '<i class="fas fa-clock"></i> ' + timeAgo +
              ' â€¢ <i class="fas fa-user"></i> ' + notif.senderName +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function filterNotifications(filter) {
      currentNotificationFilter = filter;

      const filterBtns = document.querySelectorAll('.notification-filter-btn');
      filterBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        }
      });

      // Re-renderizar com o novo filtro
      renderReceivedNotifications();
    }

    // Marcar notificaÃ§Ã£o individual como lida
    async function markNotificationAsRead(notificationId) {
      if (!currentUser || !notificationId) return;

      // Encontrar a notificaÃ§Ã£o
      const notif = receivedNotifications.find(n => n.id === notificationId);
      if (!notif || notif.read) return;

      try {
        // Atualizar no Firebase
        await rtdb.ref('notifications/users/' + currentUser.uid + '/' + notificationId).update({
          read: true
        });

        // Atualizar localmente (o listener tambÃ©m vai atualizar)
        notif.read = true;

        // Atualizar badge
        const unreadCount = receivedNotifications.filter(n => !n.read).length;
        updateNotificationBadge(unreadCount);

        // Re-renderizar
        renderReceivedNotifications();
      } catch (error) {
        console.error('Erro ao marcar notificaÃ§Ã£o como lida:', JSON.stringify(error));
      }
    }

    // Marcar todas as notificaÃ§Ãµes como lidas
    async function markAllNotificationsAsRead() {
      if (!currentUser) return;

      const unreadNotifications = receivedNotifications.filter(n => !n.read);
      if (unreadNotifications.length === 0) {
        showToast('Todas as notificaÃ§Ãµes jÃ¡ estÃ£o lidas', 'info');
        return;
      }

      try {
        // Atualizar todas no Firebase
        const updates = {};
        unreadNotifications.forEach(notif => {
          updates['notifications/users/' + currentUser.uid + '/' + notif.id + '/read'] = true;
        });

        await rtdb.ref().update(updates);

        // Atualizar localmente
        receivedNotifications.forEach(n => n.read = true);

        // Atualizar badge
        updateNotificationBadge(0);

        // Re-renderizar
        renderReceivedNotifications();

        showToast('Todas as notificaÃ§Ãµes foram marcadas como lidas');
      } catch (error) {
        console.error('Erro ao marcar notificaÃ§Ãµes como lidas:', JSON.stringify(error));
        showToast('Erro ao marcar notificaÃ§Ãµes como lidas', 'error');
      }
    }

    function updateNotificationBadge(count) {
      const badge = document.getElementById('notificationBadge');
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // Limpar listener de notificaÃ§Ãµes ao fazer logout
    function cleanupNotificationsListener() {
      if (notificationsQueryRef) {
        notificationsQueryRef.off();
        notificationsQueryRef = null;
      }
      notificationsListenerActive = false;
      receivedNotifications = [];
      currentNotificationFilter = 'all';
    }

    // ========================
    // Send Notifications System
    // ========================

    let selectedRecipientType = 'all';
    let selectedUserId = null;
    let selectedUserName = null;
    let selectedNotificationType = 'system';
    let sentNotifications = [];

    // Switch between tabs
    function switchNotificationTab(tab) {
      const tabBtns = document.querySelectorAll('.notification-tab-btn');
      const tabContents = document.querySelectorAll('.notification-tab-content');

      tabBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });

      tabContents.forEach(content => content.classList.remove('active'));

      if (tab === 'received') {
        document.getElementById('receivedNotificationsTab').classList.add('active');
      } else {
        document.getElementById('sendNotificationsTab').classList.add('active');
        loadUsersForNotification();
        loadSentNotificationsFromFirebase();
      }
    }

    // Load sent notifications from Firebase
    async function loadSentNotificationsFromFirebase() {
      if (!currentUser) return;

      try {
        const snapshot = await rtdb.ref('notifications/sent/' + currentUser.uid)
          .orderByChild('sentAt')
          .limitToLast(50)
          .once('value');

        if (snapshot.exists()) {
          const notifications = [];
          snapshot.forEach(child => {
            const notif = child.val();
            notifications.push({
              id: child.key,
              recipientType: notif.recipientType,
              recipientId: notif.recipientId,
              recipientName: notif.recipientName,
              title: notif.title,
              message: notif.message,
              type: notif.type,
              sentAt: new Date(notif.sentAt || notif.createdAt)
            });
          });
          // Sort by newest first
          notifications.sort((a, b) => b.sentAt - a.sentAt);
          sentNotifications = notifications;
          renderSentNotifications();
        }
      } catch (error) {
        console.error('Erro ao carregar notificaÃ§Ãµes enviadas:', JSON.stringify(error));
      }
    }

    // Set recipient type (all or specific)
    function setRecipientType(type) {
      selectedRecipientType = type;
      const btns = document.querySelectorAll('.recipient-type-btn');
      btns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.type === type) {
          btn.classList.add('active');
        }
      });

      const userSelectSection = document.getElementById('userSelectSection');
      if (type === 'specific') {
        userSelectSection.classList.add('active');
        loadUsersForNotification();
      } else {
        userSelectSection.classList.remove('active');
        selectedUserId = null;
        selectedUserName = null;
        document.getElementById('userSelectInput').value = '';
      }
    }

    // Load users for dropdown
    async function loadUsersForNotification() {
      const dropdownList = document.getElementById('userDropdownList');

      // Use allUsersCache if available, otherwise load from Firestore
      let users = allUsersCache;
      if (!users || users.length === 0) {
        try {
          const snapshot = await db.collection('users').get();
          users = [];
          snapshot.forEach(doc => {
            users.push({ id: doc.id, ...doc.data() });
          });
          users.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        } catch (error) {
          console.error('Error loading users:', JSON.stringify(error));
          users = [];
        }
      }

      dropdownList.innerHTML = users.map(user => {
        const initials = (user.name || 'U').substring(0, 2).toUpperCase();
        const avatarHtml = user.photoURL
          ? '<img src="' + user.photoURL + '" alt="Avatar">'
          : initials;

        return '<div class="user-dropdown-item" onclick="selectUserForNotification(\'' + user.id + '\', \'' + (user.name || 'UsuÃ¡rio').replace(/'/g, "\\'") + '\', \'' + (user.photoURL || '').replace(/'/g, "\\'") + '\')">' +
          '<div class="user-dropdown-avatar">' + avatarHtml + '</div>' +
          '<div class="user-dropdown-info">' +
            '<div class="user-dropdown-name">' + (user.name || 'UsuÃ¡rio') + '</div>' +
            '<div class="user-dropdown-email">' + (user.email || '') + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Toggle user dropdown
    function toggleUserDropdown() {
      const dropdown = document.getElementById('userDropdownList');
      dropdown.classList.toggle('active');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('userDropdownList');
      const input = document.getElementById('userSelectInput');
      if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
        dropdown.classList.remove('active');
      }
    });

    // Select user for notification
    function selectUserForNotification(userId, userName, photoURL) {
      selectedUserId = userId;
      selectedUserName = userName;
      document.getElementById('userSelectInput').value = userName;
      document.getElementById('userDropdownList').classList.remove('active');

      // Mark selected user
      const items = document.querySelectorAll('.user-dropdown-item');
      items.forEach(item => item.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    // Set notification type
    function setNotificationType(type) {
      selectedNotificationType = type;
      const options = document.querySelectorAll('.notification-type-option');
      options.forEach(opt => {
        opt.classList.remove('active');
        if (opt.dataset.type === type) {
          opt.classList.add('active');
        }
      });
    }

    // Send notification to Firebase Realtime Database
    // IMPORTANTE: As regras do RTDB devem permitir exclusÃ£o com !newData.exists()
    // - notifications/global: title, message, type, recipientType, senderId, senderName, createdAt, read (obrigatÃ³rios)
    // - notifications/users/$uid: title, message, type, senderId, senderName, createdAt, read (obrigatÃ³rios)
    // - notifications/sent/$uid: title, message, type, recipientType, senderId, senderName, createdAt, read, sentAt (obrigatÃ³rios)
    async function sendNotification() {
      const title = document.getElementById('notificationTitle').value.trim();
      const message = document.getElementById('notificationMessage').value.trim();

      // Validation - tÃ­tulo mÃ¡ximo 200 caracteres
      if (!title) {
        showToast('Digite um tÃ­tulo para a notificaÃ§Ã£o', 'error');
        return;
      }
      if (title.length > 200) {
        showToast('O tÃ­tulo deve ter no mÃ¡ximo 200 caracteres', 'error');
        return;
      }

      // Validation - mensagem mÃ¡ximo 2000 caracteres
      if (!message) {
        showToast('Digite uma mensagem para a notificaÃ§Ã£o', 'error');
        return;
      }
      if (message.length > 2000) {
        showToast('A mensagem deve ter no mÃ¡ximo 2000 caracteres', 'error');
        return;
      }

      if (selectedRecipientType === 'specific' && !selectedUserId) {
        showToast('Selecione um usuÃ¡rio destinatÃ¡rio', 'error');
        return;
      }

      if (!currentUser) {
        showToast('VocÃª precisa estar logado para enviar notificaÃ§Ãµes', 'error');
        return;
      }

      const btn = document.getElementById('sendNotificationBtn');
      btn.classList.add('loading');
      btn.disabled = true;

      try {
        const now = Date.now();
        const senderName = currentUserData?.name || 'UsuÃ¡rio';
        const senderPhotoURL = currentUserData?.photoURL || null;

        console.log('[Notification] Iniciando envio de notificaÃ§Ã£o...');
        console.log('[Notification] Tipo de destinatÃ¡rio:', selectedRecipientType);
        console.log('[Notification] UsuÃ¡rio atual:', currentUser.uid);

        // Dados para notifications/users/$uid (campos obrigatÃ³rios conforme regras)
        // NOTA: senderId NÃƒO deve validar auth.uid para permitir que outros usuÃ¡rios escrevam
        const userNotificationData = {
          title: title,
          message: message,
          type: selectedNotificationType,
          senderId: currentUser.uid,
          senderName: senderName,
          senderPhotoURL: senderPhotoURL || null,
          createdAt: now,
          read: false,
          recipientType: selectedRecipientType,
          recipientId: selectedRecipientType === 'specific' ? selectedUserId : null,
          recipientName: selectedRecipientType === 'all' ? 'Todos os usuÃ¡rios' : selectedUserName
        };

        // Dados para notifications/sent/$uid (campos obrigatÃ³rios conforme regras)
        const sentNotificationData = {
          title: title,
          message: message,
          type: selectedNotificationType,
          recipientType: selectedRecipientType,
          recipientId: selectedRecipientType === 'specific' ? selectedUserId : null,
          recipientName: selectedRecipientType === 'all' ? 'Todos os usuÃ¡rios' : selectedUserName,
          senderId: currentUser.uid,
          senderName: senderName,
          senderPhotoURL: senderPhotoURL || null,
          createdAt: now,
          read: false,
          sentAt: now
        };

        // Save notification to Firebase Realtime Database
        if (selectedRecipientType === 'all') {
          // For all users, save to a global notifications node (opcional)
          const globalNotificationData = {
            title: title,
            message: message,
            type: selectedNotificationType,
            recipientType: 'all',
            recipientId: null,
            recipientName: 'Todos os usuÃ¡rios',
            senderId: currentUser.uid,
            senderName: senderName,
            senderPhotoURL: senderPhotoURL || null,
            createdAt: now,
            read: false
          };

          console.log('[Notification] Salvando em notifications/global...');
          const notifRef = rtdb.ref('notifications/global').push();
          await notifRef.set(globalNotificationData);
          const globalNotifKey = notifRef.key;
          console.log('[Notification] Salvo em global com key:', globalNotifKey);

          // Also save to each user's personal notifications
          console.log('[Notification] Buscando usuÃ¡rios do Firestore...');
          const usersSnapshot = await db.collection('users').get();
          const promises = [];
          let userCount = 0;

          usersSnapshot.forEach(doc => {
            if (doc.id !== currentUser.uid) {
              userCount++;
              const userNotifRef = rtdb.ref('notifications/users/' + doc.id).push();
              promises.push(
                userNotifRef.set({
                  ...userNotificationData,
                  notificationId: globalNotifKey
                }).catch(err => {
                  console.error('[Notification] Erro ao notificar usuÃ¡rio ' + doc.id + ':', JSON.stringify(err));
                  return null; // Continue mesmo com erro
                })
              );
            }
          });

          console.log('[Notification] Enviando para ' + userCount + ' usuÃ¡rios...');
          await Promise.all(promises);
          console.log('[Notification] NotificaÃ§Ãµes enviadas para todos os usuÃ¡rios');
        } else {
          // For specific user, save to their personal notifications
          console.log('[Notification] Enviando para usuÃ¡rio especÃ­fico:', selectedUserId);
          const userNotifRef = rtdb.ref('notifications/users/' + selectedUserId).push();
          await userNotifRef.set(userNotificationData);
          console.log('[Notification] NotificaÃ§Ã£o enviada para:', selectedUserId);
        }

        // Save to sent notifications history
        console.log('[Notification] Salvando em notifications/sent/' + currentUser.uid);
        const sentNotifRef = rtdb.ref('notifications/sent/' + currentUser.uid).push();
        await sentNotifRef.set(sentNotificationData);
        console.log('[Notification] Salvo no histÃ³rico com key:', sentNotifRef.key);

        const notification = {
          id: sentNotifRef.key,
          recipientType: selectedRecipientType,
          recipientId: selectedUserId,
          recipientName: selectedRecipientType === 'all' ? 'Todos os usuÃ¡rios' : selectedUserName,
          title: title,
          message: message,
          type: selectedNotificationType,
          sentAt: new Date(now)
        };

        sentNotifications.unshift(notification);
        renderSentNotifications();

        // Reset form
        document.getElementById('notificationTitle').value = '';
        document.getElementById('notificationMessage').value = '';
        setRecipientType('all');
        setNotificationType('system');

        btn.classList.remove('loading');
        btn.disabled = false;

        showToast('NotificaÃ§Ã£o enviada com sucesso!');
      } catch (error) {
        console.error('[Notification] Erro ao enviar notificaÃ§Ã£o:', JSON.stringify(error));
        console.error('[Notification] Error code:', error.code);
        console.error('[Notification] Error message:', error.message);
        btn.classList.remove('loading');
        btn.disabled = false;

        // Mensagem de erro mais especÃ­fica
        let errorMsg = 'Erro ao enviar notificaÃ§Ã£o.';
        if (error.code === 'PERMISSION_DENIED') {
          errorMsg = 'PermissÃ£o negada. Verifique as regras do Firebase.';
        } else if (error.message) {
          errorMsg = 'Erro: ' + error.message;
        }
        showToast(errorMsg, 'error');
      }
    }

    // Render sent notifications
    function renderSentNotifications() {
      const container = document.getElementById('sentNotificationsList');
      if (!container) return;

      // Cria o HTML do empty state para poder reutilizar
      const emptyStateHTML = '<div class="sent-notifications-empty" id="sentNotificationsEmpty">' +
        '<i class="fas fa-paper-plane"></i>' +
        '<p>Nenhuma notificaÃ§Ã£o enviada ainda.</p>' +
      '</div>';

      if (sentNotifications.length === 0) {
        container.innerHTML = emptyStateHTML;
        const emptyState = document.getElementById('sentNotificationsEmpty');
        if (emptyState) emptyState.style.display = 'flex';
        return;
      }

      const typeIcons = {
        system: 'fa-cog',
        info: 'fa-info-circle',
        success: 'fa-check-circle',
        warning: 'fa-exclamation-triangle',
        danger: 'fa-times-circle'
      };

      container.innerHTML = sentNotifications.map(notif => {
        const timeAgo = formatTimeAgo(notif.sentAt);
        const recipientIcon = notif.recipientType === 'all' ? 'fa-users' : 'fa-user';

        return '<div class="sent-notification-card">' +
          '<div class="sent-notification-header">' +
            '<div class="sent-notification-recipient">' +
              '<i class="fas ' + recipientIcon + '"></i>' +
              '<span>' + (notif.recipientName || 'DestinatÃ¡rio') + '</span>' +
            '</div>' +
            '<div class="sent-notification-time">' + timeAgo + '</div>' +
          '</div>' +
          '<div class="sent-notification-content type-' + (notif.type || 'system') + '">' +
            '<div class="sent-notification-title-text">' +
              '<i class="fas ' + (typeIcons[notif.type] || 'fa-cog') + '"></i> ' + (notif.title || '') +
            '</div>' +
            '<div class="sent-notification-message">' + (notif.message || '') + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Format time ago
    function formatTimeAgo(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);

      if (diff < 60) return 'Agora mesmo';
      if (diff < 3600) return Math.floor(diff / 60) + ' min atrÃ¡s';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h atrÃ¡s';
      if (diff < 604800) return Math.floor(diff / 86400) + 'd atrÃ¡s';

      return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
    }

    // Clear sent notifications
    // IMPORTANTE: As regras do RTDB devem ter !newData.exists() || ... para permitir .remove()
    async function clearSentNotifications() {
      if (sentNotifications.length === 0) {
        showToast('NÃ£o hÃ¡ notificaÃ§Ãµes para limpar', 'info');
        return;
      }

      showConfirmModal(
        'Limpar HistÃ³rico',
        'Tem certeza que deseja limpar todo o histÃ³rico de notificaÃ§Ãµes enviadas?',
        async () => {
          try {
            if (!currentUser) {
              showToast('VocÃª precisa estar logado', 'error');
              return;
            }

            console.log('[Notification] Limpando histÃ³rico de notificaÃ§Ãµes enviadas...');
            console.log('[Notification] Path: notifications/sent/' + currentUser.uid);

            // Clear from Firebase - usa .remove() que envia null como newData
            // As regras devem ter: ".validate": "!newData.exists() || ..."
            await rtdb.ref('notifications/sent/' + currentUser.uid).remove();

            console.log('[Notification] HistÃ³rico limpo com sucesso!');
            sentNotifications = [];
            renderSentNotifications();
            showToast('HistÃ³rico limpo com sucesso!');
          } catch (error) {
            console.error('[Notification] Erro ao limpar histÃ³rico:', JSON.stringify(error));
            console.error('[Notification] Error code:', error.code);
            console.error('[Notification] Error message:', error.message);

            // Mensagem de erro mais especÃ­fica
            let errorMsg = 'Erro ao limpar histÃ³rico.';
            if (error.code === 'PERMISSION_DENIED') {
              errorMsg = 'PermissÃ£o negada. Atualize as regras do Firebase para permitir exclusÃ£o.';
            }
            showToast(errorMsg, 'error');
          }
        }
      );
    }

    // Custom confirm modal for notifications
    function showConfirmModal(title, message, onConfirm) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'confirmModalOverlay';
      modal.innerHTML =
        '<div class="modal">' +
          '<div class="modal-title">' + title + '</div>' +
          '<p class="modal-text" style="display: block;">' + message + '</p>' +
          '<div class="modal-actions">' +
            '<button class="modal-btn cancel" onclick="closeConfirmModal()">Cancelar</button>' +
            '<button class="modal-btn danger" id="confirmModalBtn">Confirmar</button>' +
          '</div>' +
        '</div>';

      document.body.appendChild(modal);

      document.getElementById('confirmModalBtn').onclick = function() {
        closeConfirmModal();
        onConfirm();
      };

      modal.addEventListener('click', function(e) {
        if (e.target.id === 'confirmModalOverlay') {
          closeConfirmModal();
        }
      });
    }

    function closeConfirmModal() {
      const modal = document.getElementById('confirmModalOverlay');
      if (modal) {
        modal.remove();
      }
    }

    function showPage(pageName) {
      const pages = document.querySelectorAll('.page');
      const navItems = document.querySelectorAll('.nav-item');

      pages.forEach(p => p.classList.remove('active'));
      navItems.forEach(nav => nav.classList.remove('active'));

      document.getElementById(pageName + 'Page').classList.add('active');

      const chatInputContainer = document.getElementById('chatInputContainer');
      chatInputContainer.style.display = pageName === 'chat' ? 'block' : 'none';
    }

    // Data for image viewer
    let galleryPhotos = [];

    // Navigation - usando Event Delegation para melhor captura de cliques
    // Isso resolve o problema de cliques em elementos filhos (Ã­cones, spans) nÃ£o serem capturados
    const footerNav = document.querySelector('.footer-nav');
    const pages = document.querySelectorAll('.page');
    const chatInputContainer = document.getElementById('chatInputContainer');

    function handleNavigation(e) {
      // Verifica se o clique foi no avatar do usuÃ¡rio - nÃ£o interceptar
      const navAvatar = e.target.closest('.nav-avatar');
      if (navAvatar) return; // Deixa o onclick do avatar funcionar

      e.preventDefault();
      e.stopPropagation();

      // Usa closest() para encontrar o botÃ£o .nav-item, nÃ£o importa onde o clique ocorreu
      const navItem = e.target.closest('.nav-item');
      if (!navItem) return;

      const page = navItem.dataset.page;
      if (!page) return;

      // Intercepta navegaÃ§Ã£o para Ã¡reas protegidas - requer PIN
      if ((page === 'vault' || page === 'chat') && !vaultAuthenticated) {
        pendingVaultNavigation = { source: 'footer', page: page };
        showPinModal(page);
        return;
      }

      // Atualiza estado ativo dos nav items
      const navItems = footerNav.querySelectorAll('.nav-item');
      navItems.forEach(nav => nav.classList.remove('active'));
      navItem.classList.add('active');

      // Atualiza pÃ¡gina visÃ­vel
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(page + 'Page').classList.add('active');

      // Mostra/esconde input do chat
      chatInputContainer.style.display = page === 'chat' ? 'block' : 'none';
    }

    // Adiciona listeners para touch e click
    footerNav.addEventListener('click', handleNavigation);

    // Para dispositivos touch, usar touchend para resposta mais rÃ¡pida
    let touchHandled = false;
    footerNav.addEventListener('touchend', (e) => {
      touchHandled = true;
      handleNavigation(e);
      // Reset apÃ³s um curto delay
      setTimeout(() => { touchHandled = false; }, 300);
    }, { passive: false });

    // NavegaÃ§Ã£o via Sidebar
    function navigateFromSidebar(page) {
      // Intercepta navegaÃ§Ã£o para Ã¡reas protegidas - requer PIN
      if ((page === 'vault' || page === 'chat') && !vaultAuthenticated) {
        closeSidebar();
        pendingVaultNavigation = { source: 'sidebar', page: page };
        showPinModal(page);
        return;
      }

      // Atualiza estado ativo dos nav items do footer
      const footerNavItems = footerNav.querySelectorAll('.nav-item');
      footerNavItems.forEach(nav => nav.classList.remove('active'));
      const targetNavItem = footerNav.querySelector('[data-page="' + page + '"]');
      if (targetNavItem) targetNavItem.classList.add('active');

      // Atualiza pÃ¡gina visÃ­vel
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(page + 'Page').classList.add('active');

      // Mostra/esconde input do chat
      chatInputContainer.style.display = page === 'chat' ? 'block' : 'none';

      // Fecha o sidebar
      closeSidebar();
    }

    // Adiciona listeners para os botÃµes de navegaÃ§Ã£o do sidebar
    document.querySelectorAll('.sidebar-nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const page = item.dataset.page;
        if (page) navigateFromSidebar(page);
      });
    });

    function formatKwanza(value) {
      return value.toLocaleString('pt-AO').replace(',', '.');
    }

    function updateVaultBalance() {
      document.getElementById('vaultBalance').textContent = formatKwanza(vaultBalance);
    }

    // Auto-resize textarea (Enter livre para quebrar linha, envio sÃ³ pelo botÃ£o)
    const chatInputEl = document.getElementById('chatInput');
    chatInputEl.addEventListener('input', () => {
      chatInputEl.style.height = 'auto';
      chatInputEl.style.height = Math.min(chatInputEl.scrollHeight, 120) + 'px';
    });

    // Modal de progresso de upload
    function showUploadProgressModal(total) {
      const existingModal = document.getElementById('uploadProgressModal');
      if (existingModal) existingModal.remove();

      const modal = document.createElement('div');
      modal.id = 'uploadProgressModal';
      modal.className = 'upload-progress-modal active';
      modal.innerHTML = `
        <div class="upload-progress-card">
          <div class="upload-progress-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <h3 class="upload-progress-title">Enviando fotos</h3>
          <p class="upload-progress-status" id="uploadProgressStatus">Preparando...</p>
          <div class="upload-progress-bar-container">
            <div class="upload-progress-bar" id="uploadProgressBar" style="width: 0%"></div>
          </div>
          <p class="upload-progress-count" id="uploadProgressCount">0 de ${total}</p>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function updateUploadProgress(current, total, fileName) {
      const percent = Math.round((current / total) * 100);
      const progressBar = document.getElementById('uploadProgressBar');
      const progressStatus = document.getElementById('uploadProgressStatus');
      const progressCount = document.getElementById('uploadProgressCount');

      if (progressBar) progressBar.style.width = percent + '%';
      if (progressStatus) progressStatus.textContent = `Enviando: ${fileName.substring(0, 20)}${fileName.length > 20 ? '...' : ''}`;
      if (progressCount) progressCount.textContent = `${current} de ${total}`;
    }

    function closeUploadProgressModal() {
      const modal = document.getElementById('uploadProgressModal');
      if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.remove(), 300);
      }
    }

    // Modal functions
    let currentModalType = null;

    function showAddFundsModal() {
      currentModalType = 'add';
      document.getElementById('modalTitle').textContent = 'Adicionar Fundos';
      document.getElementById('modalText').style.display = 'none';
      document.getElementById('modalAmount').value = '';
      document.getElementById('modalAmount').style.display = 'block';
      document.getElementById('modalDescription').value = '';
      document.getElementById('modalDescription').style.display = 'block';
      document.getElementById('modalConfirm').className = 'modal-btn confirm';
      document.getElementById('modalOverlay').classList.add('active');
      document.getElementById('modalConfirm').onclick = confirmModalAction;
    }

    function showWithdrawModal() {
      currentModalType = 'withdraw';
      document.getElementById('modalTitle').textContent = 'Retirar Fundos';
      document.getElementById('modalText').style.display = 'none';
      document.getElementById('modalAmount').value = '';
      document.getElementById('modalAmount').style.display = 'block';
      document.getElementById('modalDescription').value = '';
      document.getElementById('modalDescription').style.display = 'block';
      document.getElementById('modalConfirm').className = 'modal-btn confirm';
      document.getElementById('modalOverlay').classList.add('active');
      document.getElementById('modalConfirm').onclick = confirmModalAction;
    }

    function showHistoryModal() {
      document.querySelector('.vault-history').scrollIntoView({ behavior: 'smooth' });
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    async function confirmModalAction() {
      const amount = parseFloat(document.getElementById('modalAmount').value);
      const description = document.getElementById('modalDescription').value.trim() ||
        (currentModalType === 'add' ? 'DepÃ³sito' : 'Retirada');

      if (!amount || amount <= 0) {
        showToast('Digite um valor vÃ¡lido', 'error');
        return;
      }

      if (!currentUser || !currentUserData) {
        showToast('FaÃ§a login para continuar', 'error');
        return;
      }

      if (currentModalType === 'withdraw' && amount > vaultBalance) {
        showToast('Saldo insuficiente', 'error');
        return;
      }

      try {
        const transactionType = currentModalType === 'add' ? 'income' : 'expense';

        // Criar registro da transaÃ§Ã£o - o saldo Ã© calculado automaticamente
        await db.collection('transactions').add({
          type: transactionType,
          description: description,
          amount: amount,
          userId: currentUser.uid,
          userName: currentUserData.name || 'UsuÃ¡rio',
          userPhotoURL: currentUserData.photoURL || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // O saldo serÃ¡ atualizado automaticamente pelo listener em subscribeToVault()
        showToast(currentModalType === 'add' ? 'Fundos adicionados!' : 'Retirada realizada!');
        closeModal();
      } catch (error) {
        console.error('Error processing transaction:', JSON.stringify(error));
        showToast('Erro ao processar operaÃ§Ã£o', 'error');
      }
    }

    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'modalOverlay') closeModal();
    });

    document.getElementById('deleteModalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'deleteModalOverlay') closeDeleteModal();
    });

    document.getElementById('deleteMessageModalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'deleteMessageModalOverlay') closeDeleteMessageModal();
    });

    // Image Viewer
    let currentImageIndex = 0;
    let touchStartX = 0;
    let touchEndX = 0;
    let isDragging = false;
    let currentTranslate = 0;
    let prevTranslate = 0;

    function openViewer(index) {
      currentImageIndex = index;
      const viewer = document.getElementById('imageViewer');
      const slidesContainer = document.getElementById('viewerSlides');
      const navContainer = document.getElementById('viewerNav');

      // Reset state before opening
      currentTranslate = 0;
      prevTranslate = 0;

      slidesContainer.style.transition = 'none';
      slidesContainer.innerHTML = galleryPhotos.map(photo => {
        const imgPart = photo.url
          ? '<img class="viewer-image" src="' + photo.url + '" alt="Foto do Grupo" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">'
          : '';
        const placeholderStyle = photo.url ? 'display: none;' : '';
        return '<div class="viewer-slide">' +
          imgPart +
          '<div class="viewer-placeholder" style="' + placeholderStyle + 'background: linear-gradient(135deg, ' + photo.color + '60, ' + photo.color + '30)">' +
            '<i class="fas fa-image" style="color: ' + photo.color + '"></i>' +
            '<span>Foto do Grupo</span>' +
          '</div>' +
        '</div>';
      }).join('');

      navContainer.innerHTML = galleryPhotos.map((_, i) => {
        return '<div class="viewer-dot ' + (i === index ? 'active' : '') + '" onclick="goToImage(' + i + ')"></div>';
      }).join('');

      updateViewerPosition(false);
      updateViewerUI();
      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeViewer() {
      const viewer = document.getElementById('imageViewer');
      const slidesContainer = document.getElementById('viewerSlides');
      const navContainer = document.getElementById('viewerNav');

      viewer.classList.remove('active');
      document.body.style.overflow = '';

      // Reset transform and transitions
      slidesContainer.style.transition = 'none';
      slidesContainer.style.transform = 'translateX(0)';

      // Clear slides content after animation
      setTimeout(function() {
        slidesContainer.innerHTML = '';
        navContainer.innerHTML = '';
      }, 300);

      // Reset state variables
      currentTranslate = 0;
      prevTranslate = 0;
      currentImageIndex = 0;

      // Restore arrow buttons visibility
      document.getElementById('prevBtn').style.display = '';
      document.getElementById('nextBtn').style.display = '';
    }

    function downloadCurrentImage() {
      // Get the current image URL from galleryPhotos
      if (galleryPhotos.length > 0 && galleryPhotos[currentImageIndex]) {
        const imageUrl = galleryPhotos[currentImageIndex].url;
        if (imageUrl) {
          // Try to call Android interface to open in external browser
          try {
            if (typeof Android !== 'undefined' && Android.openApp) {
              Android.openApp(imageUrl);
            } else {
              // Fallback: open in new tab/window if Android interface not available
              window.open(imageUrl, '_blank');
            }
          } catch (e) {
            // Fallback: open in new tab/window
            window.open(imageUrl, '_blank');
          }
        }
      }
    }

    function navigateViewer(direction) {
      const newIndex = currentImageIndex + direction;
      if (newIndex >= 0 && newIndex < galleryPhotos.length) {
        currentImageIndex = newIndex;
        updateViewerPosition(true);
        updateViewerUI();
      }
    }

    function goToImage(index) {
      currentImageIndex = index;
      updateViewerPosition(true);
      updateViewerUI();
    }

    function updateViewerPosition(animate) {
      const slidesContainer = document.getElementById('viewerSlides');
      const offset = -currentImageIndex * window.innerWidth;
      slidesContainer.style.transition = animate ? 'transform 0.3s ease-out' : 'none';
      slidesContainer.style.transform = 'translateX(' + offset + 'px)';
      prevTranslate = offset;
      currentTranslate = offset;
    }

    function updateViewerUI() {
      document.getElementById('viewerCounter').textContent =
        (currentImageIndex + 1) + ' / ' + galleryPhotos.length;

      const dots = document.querySelectorAll('.viewer-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentImageIndex);
      });

      document.getElementById('prevBtn').disabled = currentImageIndex === 0;
      document.getElementById('nextBtn').disabled = currentImageIndex === galleryPhotos.length - 1;
    }

    // Touch/Swipe handling for viewer
    const viewerContainer = document.getElementById('viewerContainer');

    viewerContainer.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      isDragging = true;
      const slidesContainer = document.getElementById('viewerSlides');
      slidesContainer.style.transition = 'none';
    }, { passive: true });

    viewerContainer.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      touchEndX = e.touches[0].clientX;
      const diff = touchEndX - touchStartX;
      currentTranslate = prevTranslate + diff;

      const slidesContainer = document.getElementById('viewerSlides');
      slidesContainer.style.transform = 'translateX(' + currentTranslate + 'px)';
    }, { passive: true });

    viewerContainer.addEventListener('touchend', () => {
      isDragging = false;
      const diff = touchEndX - touchStartX;
      const threshold = window.innerWidth * 0.2;

      if (Math.abs(diff) > threshold) {
        if (diff > 0 && currentImageIndex > 0) {
          currentImageIndex--;
        } else if (diff < 0 && currentImageIndex < galleryPhotos.length - 1) {
          currentImageIndex++;
        }
      }

      updateViewerPosition(true);
      updateViewerUI();
      touchStartX = 0;
      touchEndX = 0;
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const viewer = document.getElementById('imageViewer');
      if (!viewer.classList.contains('active')) return;

      if (e.key === 'Escape') closeViewer();
      if (e.key === 'ArrowLeft') navigateViewer(-1);
      if (e.key === 'ArrowRight') navigateViewer(1);
    });

    // Sidebar swipe
    let sidebarTouchStartX = 0;
    let sidebarTouchEndX = 0;
    const sidebarEdgeThreshold = 30;
    const sidebarSwipeThreshold = 80;

    document.addEventListener('touchstart', (e) => {
      const viewer = document.getElementById('imageViewer');
      if (viewer.classList.contains('active')) return;
      sidebarTouchStartX = e.touches[0].clientX;
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      const viewer = document.getElementById('imageViewer');
      if (viewer.classList.contains('active')) return;

      sidebarTouchEndX = e.changedTouches[0].clientX;
      const diffX = sidebarTouchEndX - sidebarTouchStartX;

      const sidebar = document.getElementById('sidebar');
      const isSidebarOpen = sidebar.classList.contains('active');

      if (diffX > sidebarSwipeThreshold && sidebarTouchStartX < sidebarEdgeThreshold && !isSidebarOpen) {
        openSidebar();
      } else if (diffX < -sidebarSwipeThreshold && isSidebarOpen) {
        closeSidebar();
      }

      sidebarTouchStartX = 0;
      sidebarTouchEndX = 0;
    }, { passive: true });

    // =====================
    // ABSENCE SYSTEM
    // =====================

    let selectedUserForAbsence = null;
    let absenceToDelete = null;
    let allUsersCache = [];
    let allAbsencesCache = {};

    async function loadAllUsersWithAbsences() {
      const container = document.getElementById('absencesUsersContainer');
      container.innerHTML = '<div class="posts-loading"><i class="fas fa-spinner"></i><span>Carregando usuÃ¡rios...</span></div>';

      try {
        // Load all users
        const usersSnapshot = await db.collection('users').get();
        allUsersCache = [];
        usersSnapshot.forEach(doc => {
          allUsersCache.push({ id: doc.id, ...doc.data() });
        });

        // Sort users by name
        allUsersCache.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

        // Load all absences (without orderBy on single field is fine, but we'll sort on client)
        const absencesSnapshot = await db.collection('absences').get();
        allAbsencesCache = {};
        absencesSnapshot.forEach(doc => {
          const data = doc.data();
          if (!allAbsencesCache[data.userId]) {
            allAbsencesCache[data.userId] = [];
          }
          allAbsencesCache[data.userId].push({ id: doc.id, ...data });
        });

        // Sort each user's absences by date descending
        Object.keys(allAbsencesCache).forEach(uid => {
          allAbsencesCache[uid].sort((a, b) => {
            const dateA = a.date?.toMillis ? a.date.toMillis() : (typeof a.date === 'number' ? a.date : new Date(a.date).getTime());
            const dateB = b.date?.toMillis ? b.date.toMillis() : (typeof b.date === 'number' ? b.date : new Date(b.date).getTime());
            return dateB - dateA;
          });
        });

        renderUsersWithAbsences();
      } catch (err) {
        console.error('Error loading users and absences:', err);
        container.innerHTML = '<div class="posts-empty"><i class="fas fa-exclamation-circle"></i><p>Erro ao carregar usuÃ¡rios</p></div>';
      }
    }

    function renderUsersWithAbsences() {
      const container = document.getElementById('absencesUsersContainer');

      if (allUsersCache.length === 0) {
        container.innerHTML = '<div class="posts-empty"><i class="fas fa-users"></i><p>Nenhum usuÃ¡rio encontrado</p></div>';
        return;
      }

      container.innerHTML = allUsersCache.map(user => {
        const userAbsences = allAbsencesCache[user.id] || [];
        const absenceCount = userAbsences.length;
        const initials = getInitials(user.name || 'UsuÃ¡rio');
        const hasAbsences = absenceCount > 0;

        let avatarHtml = initials;
        if (user.photoURL) {
          avatarHtml = '<img src="' + escapeHtml(user.photoURL) + '" alt="Avatar">';
        }

        let historyHtml = '';
        if (hasAbsences) {
          historyHtml = '<div class="absence-history-section">' +
            '<button class="absence-history-toggle" onclick="toggleAbsenceHistory(this, \'' + user.id + '\')">' +
              '<span><i class="fas fa-history"></i> Ver histÃ³rico de faltas</span>' +
              '<i class="fas fa-chevron-down"></i>' +
            '</button>' +
            '<div class="absence-history-list" id="absenceHistory_' + user.id + '">' +
              userAbsences.map(absence => {
                const dateFormatted = formatAbsenceDate(absence.date);
                return '<div class="absence-history-item">' +
                  '<div class="absence-history-date">' +
                    '<i class="fas fa-calendar-xmark"></i>' +
                    '<div>' +
                      '<div class="absence-history-date-text">' + dateFormatted + '</div>' +
                      '<div class="absence-history-reason">' + (absence.reason ? escapeHtml(absence.reason) : 'Sem motivo') + '</div>' +
                    '</div>' +
                  '</div>' +
                  '<button class="absence-history-delete" onclick="confirmDeleteAbsenceForUser(\'' + absence.id + '\', \'' + user.id + '\')">' +
                    '<i class="fas fa-trash-alt"></i>' +
                  '</button>' +
                '</div>';
              }).join('') +
            '</div>' +
          '</div>';
        }

        return '<div class="absence-user-card" id="userCard_' + user.id + '">' +
          '<div class="absence-user-header">' +
            '<div class="absence-user-avatar">' + avatarHtml + '</div>' +
            '<div class="absence-user-info">' +
              '<div class="absence-user-name">' + escapeHtml(user.name || 'UsuÃ¡rio') + '</div>' +
              '<div class="absence-user-username">@' + escapeHtml(user.username || user.email || '') + '</div>' +
            '</div>' +
            '<div class="absence-count-badge' + (hasAbsences ? ' has-absences' : '') + '">' +
              '<div class="absence-count-number">' + absenceCount + '</div>' +
              '<div class="absence-count-label">Faltas</div>' +
            '</div>' +
          '</div>' +
          '<div class="absence-actions">' +
            '<button class="absence-action-btn add" onclick="openAddAbsenceModalForUser(\'' + user.id + '\')">' +
              '<i class="fas fa-plus"></i>' +
              '<span>Adicionar Falta</span>' +
            '</button>' +
            '<button class="absence-action-btn remove" onclick="removeLastAbsenceForUser(\'' + user.id + '\')"' + (hasAbsences ? '' : ' disabled') + '>' +
              '<i class="fas fa-minus"></i>' +
              '<span>Remover Falta</span>' +
            '</button>' +
          '</div>' +
          historyHtml +
        '</div>';
      }).join('');
    }

    function toggleAbsenceHistory(btn, odId) {
      const historyList = document.getElementById('absenceHistory_' + odId);
      if (historyList) {
        btn.classList.toggle('expanded');
        historyList.classList.toggle('show');
      }
    }

    function openAddAbsenceModalForUser(odId) {
      const user = allUsersCache.find(u => u.id === odId);
      if (!user) {
        showToast('UsuÃ¡rio nÃ£o encontrado');
        return;
      }

      selectedUserForAbsence = user;

      // Update modal with user info
      const userInfoDiv = document.getElementById('absenceModalUserInfo');
      const avatarDiv = document.getElementById('absenceModalUserAvatar');
      const nameDiv = document.getElementById('absenceModalUserName');
      const usernameDiv = document.getElementById('absenceModalUserUsername');

      userInfoDiv.style.display = 'flex';

      const initials = getInitials(user.name || 'UsuÃ¡rio');
      if (user.photoURL) {
        avatarDiv.innerHTML = '<img src="' + escapeHtml(user.photoURL) + '" alt="Avatar">';
      } else {
        avatarDiv.innerHTML = initials;
      }

      nameDiv.textContent = user.name || 'UsuÃ¡rio';
      usernameDiv.textContent = '@' + (user.username || user.email || '');

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('absenceDate').value = today;
      document.getElementById('absenceReason').value = '';
      document.getElementById('absenceModalOverlay').classList.add('active');
    }

    function closeAbsenceModal() {
      document.getElementById('absenceModalOverlay').classList.remove('active');
      selectedUserForAbsence = null;
    }

    async function saveAbsenceForUser() {
      if (!selectedUserForAbsence) {
        showToast('Nenhum usuÃ¡rio selecionado');
        return;
      }

      const dateInput = document.getElementById('absenceDate').value;
      const reason = document.getElementById('absenceReason').value.trim();

      if (!dateInput) {
        showToast('Selecione uma data');
        return;
      }

      const userId = selectedUserForAbsence.id;
      const userName = selectedUserForAbsence.name || 'usuÃ¡rio';

      try {
        // Add to Firestore and get the document reference
        const docRef = await db.collection('absences').add({
          userId: userId,
          date: dateInput,
          reason: reason || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Immediately update local cache with the new absence
        const newAbsence = {
          id: docRef.id,
          userId: userId,
          date: dateInput,
          reason: reason || null,
          createdAt: new Date()
        };

        // Initialize array if not exists
        if (!allAbsencesCache[userId]) {
          allAbsencesCache[userId] = [];
        }

        // Add to cache and sort by date descending
        allAbsencesCache[userId].unshift(newAbsence);
        allAbsencesCache[userId].sort((a, b) => {
          const dateA = typeof a.date === 'string' ? new Date(a.date).getTime() : a.date;
          const dateB = typeof b.date === 'string' ? new Date(b.date).getTime() : b.date;
          return dateB - dateA;
        });

        closeAbsenceModal();
        showToast('Falta registrada para ' + userName);

        // Re-render the UI with updated cache
        renderUsersWithAbsences();
        updateProfileAbsenceCount();
      } catch (err) {
        console.error('Error saving absence:', err);
        showToast('Erro ao registrar falta', 'error');
      }
    }

    async function removeLastAbsenceForUser(odId) {
      const userAbsences = allAbsencesCache[odId];
      if (!userAbsences || userAbsences.length === 0) {
        showToast('Este usuÃ¡rio nÃ£o tem faltas');
        return;
      }

      const user = allUsersCache.find(u => u.id === odId);
      const lastAbsence = userAbsences[0]; // Already sorted by date desc

      try {
        await db.collection('absences').doc(lastAbsence.id).delete();

        // Immediately update local cache by removing the absence
        allAbsencesCache[odId] = allAbsencesCache[odId].filter(a => a.id !== lastAbsence.id);

        showToast('Falta removida de ' + (user ? user.name : 'usuÃ¡rio'));

        // Re-render the UI with updated cache
        renderUsersWithAbsences();
        updateProfileAbsenceCount();
      } catch (err) {
        console.error('Error removing absence:', err);
        showToast('Erro ao remover falta', 'error');
      }
    }

    function confirmDeleteAbsenceForUser(absenceId, odId) {
      absenceToDelete = { absenceId, odId };
      document.getElementById('deleteAbsenceModalOverlay').classList.add('active');
    }

    function closeDeleteAbsenceModal() {
      document.getElementById('deleteAbsenceModalOverlay').classList.remove('active');
      absenceToDelete = null;
    }

    document.getElementById('deleteAbsenceConfirmBtn').addEventListener('click', async () => {
      if (!absenceToDelete) return;

      const { absenceId, odId } = absenceToDelete;

      try {
        await db.collection('absences').doc(absenceId).delete();

        // Immediately update local cache by removing the absence
        if (allAbsencesCache[odId]) {
          allAbsencesCache[odId] = allAbsencesCache[odId].filter(a => a.id !== absenceId);
        }

        closeDeleteAbsenceModal();
        showToast('Falta removida');

        // Re-render the UI with updated cache
        renderUsersWithAbsences();
        updateProfileAbsenceCount();
      } catch (err) {
        console.error('Error deleting absence:', err);
        showToast('Erro ao remover falta', 'error');
      }
    });

    function formatAbsenceDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      const months = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      return day + ' de ' + months[parseInt(month) - 1] + ' de ' + year;
    }

    async function updateProfileAbsenceCount() {
      if (!currentUser) return;

      try {
        const snapshot = await db.collection('absences')
          .where('userId', '==', currentUser.uid)
          .get();

        const count = snapshot.size;
        const el = document.getElementById('profileAbsences');
        if (el) el.textContent = count;
      } catch (err) {
        console.error('Error updating absence count:', err);
      }
    }

    // ========== Profile Absences History Modal Functions ==========

    // Open the profile absences history modal
    async function openProfileAbsencesModal(userId) {
      const overlay = document.getElementById('profileAbsencesModalOverlay');
      const body = document.getElementById('profileAbsencesModalBody');

      // Show loading state
      body.innerHTML = '<div class="profile-absences-loading"><i class="fas fa-spinner"></i><p>Carregando...</p></div>';

      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Determine which user to load (current user or specified user)
      const targetUserId = userId || (currentUser ? currentUser.uid : null);

      if (!targetUserId) {
        body.innerHTML = '<div class="profile-absences-empty"><i class="fas fa-exclamation-triangle"></i><p>UsuÃ¡rio nÃ£o encontrado</p></div>';
        return;
      }

      await loadProfileAbsences(targetUserId);
    }

    // Close the profile absences history modal
    function closeProfileAbsencesModal(event) {
      if (event && event.target !== event.currentTarget) return;

      const overlay = document.getElementById('profileAbsencesModalOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Load absences for a specific user
    async function loadProfileAbsences(userId) {
      const body = document.getElementById('profileAbsencesModalBody');

      try {
        // Fetch absences from Firestore (without orderBy to avoid needing composite index)
        const absencesSnapshot = await db.collection('absences')
          .where('userId', '==', userId)
          .get();

        const absences = [];
        absencesSnapshot.forEach(doc => {
          absences.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Sort by date descending on client side
        absences.sort((a, b) => {
          const dateA = a.date?.toMillis ? a.date.toMillis() : (typeof a.date === 'number' ? a.date : new Date(a.date).getTime());
          const dateB = b.date?.toMillis ? b.date.toMillis() : (typeof b.date === 'number' ? b.date : new Date(b.date).getTime());
          return dateB - dateA;
        });

        // If no absences, show empty state
        if (absences.length === 0) {
          body.innerHTML =
            '<div class="profile-absences-empty">' +
              '<i class="fas fa-check-circle"></i>' +
              '<p>Nenhuma falta registrada!</p>' +
            '</div>';
          return;
        }

        // Build the absences list HTML
        let listHtml = absences.map(function(absence) {
          const dateFormatted = formatAbsenceDate(absence.date);
          const reason = absence.reason ? escapeHtml(absence.reason) : 'Sem motivo informado';

          return '<div class="profile-absence-item">' +
            '<div class="profile-absence-icon">' +
              '<i class="fas fa-calendar-xmark"></i>' +
            '</div>' +
            '<div class="profile-absence-info">' +
              '<div class="profile-absence-date">' + dateFormatted + '</div>' +
              '<div class="profile-absence-reason">' + reason + '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        // Build summary and list
        body.innerHTML =
          '<div class="profile-absences-summary">' +
            '<div class="profile-absences-summary-number">' + absences.length + '</div>' +
            '<div class="profile-absences-summary-text">' +
              (absences.length === 1 ? 'falta registrada' : 'faltas registradas') +
            '</div>' +
          '</div>' +
          '<div class="profile-absences-list">' + listHtml + '</div>';

      } catch (error) {
        console.error('Error loading profile absences:', JSON.stringify(error));
        body.innerHTML =
          '<div class="profile-absences-empty">' +
            '<i class="fas fa-exclamation-triangle"></i>' +
            '<p>Erro ao carregar faltas</p>' +
          '</div>';
      }
    }

    // ========== Profile Avatar Options Functions ==========

    // Open avatar options menu
    function openAvatarOptions() {
      document.getElementById('avatarOptionsOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close avatar options menu
    function closeAvatarOptions(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('avatarOptionsOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    // View profile photo in fullscreen
    function viewProfilePhoto() {
      closeAvatarOptions();

      const viewer = document.getElementById('profileImageViewer');
      const content = document.getElementById('profileImageViewerContent');

      if (currentUserData && currentUserData.photoURL) {
        content.innerHTML = '<img src="' + currentUserData.photoURL + '" alt="Foto de perfil">';
      } else {
        const initials = getInitials(currentUserData ? currentUserData.name : 'UsuÃ¡rio');
        content.innerHTML = '<div class="profile-image-viewer-placeholder">' + initials + '</div>';
      }

      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close profile image viewer
    function closeProfileImageViewer() {
      document.getElementById('profileImageViewer').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Trigger file input to update profile photo
    function updateProfilePhoto() {
      closeAvatarOptions();
      document.getElementById('profileAvatarInput').click();
    }

    // Handle profile avatar file change
    async function handleProfileAvatarChange(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];

      // Validate file type
      if (!file.type.startsWith('image/')) {
        showToast('Por favor, selecione uma imagem vÃ¡lida', 'error');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showToast('A imagem deve ter no mÃ¡ximo 5MB', 'error');
        return;
      }

      showToast('Atualizando foto...');

      try {
        // Upload to ImgBB
        const photoURL = await uploadToImgBB(file);

        if (!photoURL) {
          showToast('Erro ao fazer upload da imagem', 'error');
          return;
        }

        // Update in Firestore
        await db.collection('users').doc(currentUser.uid).update({
          photoURL: photoURL
        });

        // Update local data
        currentUserData.photoURL = photoURL;

        // Update UI elements
        updateAvatarUI(photoURL);

        // Create post announcing profile photo update
        await createProfilePhotoUpdatePost(photoURL);

        showToast('Foto atualizada com sucesso!');
      } catch (error) {
        console.error('Error updating avatar:', JSON.stringify(error));
        showToast('Erro ao atualizar foto', 'error');
      }

      // Clear input
      input.value = '';
    }

    // Create a post announcing profile photo update
    async function createProfilePhotoUpdatePost(photoURL) {
      try {
        const userName = currentUserData.name || 'UsuÃ¡rio';

        await db.collection('posts').add({
          content: userName + ' atualizou sua foto de perfil.',
          imageURL: photoURL,
          imageURLs: [photoURL],
          authorId: currentUser.uid,
          authorName: userName,
          authorPhotoURL: photoURL,
          likes: 0,
          likedBy: [],
          isProfileUpdate: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Refresh posts if on posts tab
        if (document.getElementById('postsSection') &&
            document.getElementById('postsSection').style.display !== 'none') {
          loadPostsFromFirestore();
        }
      } catch (error) {
        console.error('Error creating profile update post:', JSON.stringify(error));
      }
    }

    // Update all avatar UI elements
    function updateAvatarUI(photoURL) {
      const avatarHtml = '<img src="' + photoURL + '" alt="Avatar">';

      // Profile page avatar
      const profileAvatar = document.getElementById('profileAvatar');
      if (profileAvatar) {
        profileAvatar.innerHTML = avatarHtml;
      }

      // Sidebar avatar
      const sidebarAvatar = document.getElementById('sidebarAvatar');
      if (sidebarAvatar) {
        sidebarAvatar.innerHTML = avatarHtml;
      }
    }

    // Close profile image viewer on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (document.getElementById('profileImageViewer').classList.contains('active')) {
          closeProfileImageViewer();
        }
        if (document.getElementById('avatarOptionsOverlay').classList.contains('active')) {
          closeAvatarOptions();
        }
      }
    });

    // ==================== PIN SECURITY MODAL ====================

    const pinModalTexts = {
      vault: {
        title: 'Acesso ao Cofre',
        subtitle: 'Digite o PIN para acessar o Cofre',
        icon: 'fa-vault'
      },
      chat: {
        title: 'Conversas Privadas',
        subtitle: 'Digite o PIN para acessar as Conversas',
        icon: 'fa-comments'
      }
    };

    function showPinModal(page) {
      currentPinInput = '';
      updatePinDisplay();
      document.getElementById('pinErrorMsg').classList.remove('show');

      // Atualiza textos e Ã­cone do modal baseado na pÃ¡gina
      const texts = pinModalTexts[page] || pinModalTexts.vault;
      document.getElementById('pinModalTitle').textContent = texts.title;
      document.getElementById('pinModalSubtitle').textContent = texts.subtitle;
      document.getElementById('pinModalIcon').className = 'fas ' + texts.icon;

      document.getElementById('pinModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePinModal() {
      document.getElementById('pinModal').classList.remove('active');
      document.body.style.overflow = '';
      currentPinInput = '';
      pendingVaultNavigation = null;
      updatePinDisplay();
    }

    function updatePinDisplay() {
      for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById('pinDot' + i);
        dot.classList.remove('filled', 'error');
        if (i <= currentPinInput.length) {
          dot.classList.add('filled');
        }
      }
    }

    function showPinError() {
      const dots = document.querySelectorAll('.pin-dot');
      dots.forEach(dot => {
        dot.classList.remove('filled');
        dot.classList.add('error');
      });
      document.getElementById('pinErrorMsg').classList.add('show');

      setTimeout(() => {
        currentPinInput = '';
        updatePinDisplay();
        document.getElementById('pinErrorMsg').classList.remove('show');
      }, 1200);
    }

    function handlePinInput(key) {
      if (key === 'delete') {
        currentPinInput = currentPinInput.slice(0, -1);
        updatePinDisplay();
        return;
      }

      if (currentPinInput.length >= 4) return;

      currentPinInput += key;
      updatePinDisplay();

      // Verifica o PIN quando 4 dÃ­gitos sÃ£o inseridos
      if (currentPinInput.length === 4) {
        setTimeout(() => {
          if (currentPinInput === VAULT_PIN) {
            // PIN correto - autenticar e navegar para a pÃ¡gina protegida
            vaultAuthenticated = true;
            const targetPage = pendingVaultNavigation ? pendingVaultNavigation.page : 'vault';
            closePinModal();
            navigateToProtectedPage(targetPage);
          } else {
            // PIN incorreto
            showPinError();
          }
        }, 150);
      }
    }

    function navigateToProtectedPage(page) {
      // Atualiza estado ativo dos nav items do footer
      const footerNavItems = footerNav.querySelectorAll('.nav-item');
      footerNavItems.forEach(nav => nav.classList.remove('active'));
      const targetNavItem = footerNav.querySelector('[data-page="' + page + '"]');
      if (targetNavItem) targetNavItem.classList.add('active');

      // Atualiza pÃ¡gina visÃ­vel
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(page + 'Page').classList.add('active');

      // Mostra/esconde input do chat
      chatInputContainer.style.display = page === 'chat' ? 'block' : 'none';
    }

    // Event listeners para o teclado numÃ©rico
    document.querySelectorAll('.pin-key').forEach(key => {
      key.addEventListener('click', (e) => {
        e.preventDefault();
        const keyValue = key.dataset.key;
        if (keyValue) {
          handlePinInput(keyValue);
        }
      });
    });

    // Suporte ao teclado fÃ­sico no modal PIN
    document.addEventListener('keydown', (e) => {
      const pinModal = document.getElementById('pinModal');
      if (!pinModal.classList.contains('active')) return;

      if (e.key >= '0' && e.key <= '9') {
        handlePinInput(e.key);
      } else if (e.key === 'Backspace') {
        handlePinInput('delete');
      } else if (e.key === 'Escape') {
        closePinModal();
      }
    });

    // ==================== END PIN SECURITY MODAL ====================

    // Initialize
    initTheme();
  </script>
</body>
</html>





